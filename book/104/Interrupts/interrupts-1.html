
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<title>中断和中断处理 Part 1.-Linux 内核揭密</title>
<meta content='中断和中断处理 Part 1.,Linux 内核揭密' name='keywords'>
<meta content='中断和中断处理 Part 1.,Linux 内核揭密' name='description'>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="zh-CN" />
<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=no"../../../>
<meta name="applicable-device" content="pc,mobile">
<link rel="shortcut icon" href="../../../favicon.ico" type="image/x-icon" />
<meta name="renderer" content="webkit">
<link rel="stylesheet" href="../../../static/components/uikit-2.27.5/css/uikit.custom.css">
<link rel="stylesheet" href="../../../static/components/social-share/social-share.min.css">
<link rel="stylesheet" href="../../../static/components/highlight/styles/custom.css">
<link rel="stylesheet" href="../../../static/components/css/base.css">
<link rel="stylesheet" href="../../../static/components/css/reader.css">
<link rel="stylesheet" href="../../../static/components/css/markdown.css">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5313208362165053" crossorigin="anonymous"></script>
</head>
<body>
<div class=" book-main-wrap uk-container uk-container-center uk-margin-top ">
<div class="uk-grid">
<div class="uk-width-1-1 reader-wrap ">
<div class=" bottom-nav uk-clearfix ">
<div class="uk-align-left ">
<a href="../../../book/104/Interrupts/README.html">
<i class="nav-icon-left uk-icon-small  uk-icon-caret-left"></i>
<span class="">中断</span>
</a>
</div>
<div class="uk-align-right ">
<a href="../../../book/104/Interrupts/interrupts-2.html">
<span class="">深入 Linux 内核..</span>
<i class="nav-icon-right uk-icon-small  uk-icon-caret-right"></i>
</a>
</div>
</div>
<div class="uk-text-center">
<h2 class="book-page-title uk-container-center">
<a href="../../../book/104/index.html">Linux 内核揭密</a>
<a target="_blank" rel="nofollow" href="https://github.com/ye11ow/linux-insides-zh" class="uk-icon-button uk-icon-github" title="github项目地址"></a>
</h2>
</div>
<script type="text/javascript" src="../../../static/components/js/app_intro.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5313208362165053" data-ad-slot="1328047120"></ins>
<script>(adsbygoogle =window.adsbygoogle ||[]).push({});</script>
<hr class="uk-article-divider">
<div class="book-content-section  md-content-section  uk-margin-bottom">
<h1 id="中断和中断处理-part-1">中断和中断处理 Part 1.</h1>
<h2 id="introduction">Introduction</h2>
<p>这是 <a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/">linux 内核揭密</a> 这本书最新章节的第一部分。我们已经在这本书前面的<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Initialization/index.html">章节</a>中走过了漫长的道路。从内核初始化的<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Initialization/linux-initialization-1.html">第一步</a>开始，结束于第一个 <code>init</code> 程序的<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Initialization/linux-initialization-10.html">启动</a>。我们见证了一系列与各种内核子系统相关的初始化步骤，但是我们并没有深入这些子系统。在这一章中，我们将会试着去了解这些内核子系统是如何工作和实现的。就像你在这章标题中看到的，第一个子系统是<a href="http://en.wikipedia.org/wiki/Interrupt">中断（interrupts）</a>。</p>
<h2 id="什么是中断">什么是中断？</h2>
<p>我们已经在这本书的很多地方听到过 <code>中断（interrupts）</code> 这个词，也看到过很多关于中断的例子。在这一章中我们将会从下面的主题开始：</p>
<ul>
<li>什么是 <code>中断（interrupts）</code> ？</li>
<li>什么是 <code>中断处理（interrupt handlers）</code> ？</li>
</ul>
<p>我们将会继续深入探讨 <code>中断</code> 的细节和 Linux 内核如何处理这些中断。</p>
<p>所以，首先什么是中断？中断就是当软件或者硬件需要使用 CPU 时引发的 <code>事件（event）</code>。比如，当我们在键盘上按下一个键的时候，我们下一步期望做什么？操作系统和电脑应该怎么做？做一个简单的假设，每一个物理硬件都有一根连接 CPU 的中断线，设备可以通过它对 CPU 发起中断信号。但是中断信号并不是直接发送给 CPU。在老机器上中断信号发送给 <a href="http://en.wikipedia.org/wiki/Programmable_Interrupt_Controller">PIC</a> ，它是一个顺序处理各种设备的各种中断请求的芯片。在新机器上，则是<a href="https://en.wikipedia.org/wiki/Advanced_Programmable_Interrupt_Controller">高级程序中断控制器（Advanced Programmable Interrupt Controller）</a>做这件事情，即我们熟知的 <code>APIC</code>。一个 APIC 包括两个独立的设备：</p>
<ul>
<li><code>Local APIC</code></li>
<li><code>I/O APIC</code></li>
</ul>
<p>第一个设备 - <code>Local APIC</code> 存在于每个CPU核心中，Local APIC 负责处理特定于 CPU 的中断配置。Local APIC 常被用于管理来自 APIC 时钟（APIC-timer）、热敏元件和其他与 I/O 设备连接的设备的中断。</p>
<p>第二个设备 - <code>I/O APIC</code> 提供了多核处理器的中断管理。它被用来在所有的 CPU 核心中分发外部中断。更多关于 local 和 I/O APIC 的内容将会在这一节的下面讲到。就如你所知道的，中断可以在任何时间发生。当一个中断发生时，操作系统必须立刻处理它。但是 <code>处理一个中断</code> 是什么意思呢？当一个中断发生时，操作系统必须确保下面的步骤顺序：</p>
<ul>
<li>内核必须暂停执行当前进程(取代当前的任务)；</li>
<li>内核必须搜索中断处理程序并且转交控制权(执行中断处理程序)；</li>
<li>中断处理程序结束之后，被中断的进程能够恢复执行。</li>
</ul>
<p>当然，在这个中断处理程序中会涉及到很多错综复杂的过程。但是上面 3 条是这个程序的基本骨架。</p>
<p>每个中断处理程序的地址都保存在一个特殊的位置，这个位置被称为 <code>中断描述符表（Interrupt Descriptor Table）</code> 或者 <code>IDT</code>。处理器使用一个唯一的数字来识别中断和异常的类型，这个数字被称为 <code>中断标识码（vector number）</code>。一个中断标识码就是一个 <code>IDT</code> 的标识。中断标识码范围是有限的，从 <code>0</code> 到 <code>255</code>。你可以在 Linux 内核源码中找到下面的中断标识码范围检查代码：</p>
<pre><code class="language-C">BUG_ON((unsigned)n &gt; 0xFF);
</code></pre>
<p>你可以在 Linux 内核源码中关于中断设置的地方找到这个检查(例如：<code>set_intr_gate</code>, <code>void set_system_intr_gate</code> 在 <a href="https://github.com/torvalds/linux/blob/master/arch/x86/include/asm/desc.h">arch/x86/include/asm/desc.h</a>中)。从 <code>0</code> 到 <code>31</code> 的 32 个中断标识码被处理器保留，用作处理架构定义的异常和中断。你可以在 Linux 内核初始化程序的第二部分 - <a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Initialization/linux-initialization-2.html">早期中断和异常处理</a>中找到这个表和关于这些中断标识码的描述。从 <code>32</code> 到 <code>255</code> 的中断标识码设计为用户定义中断并且不被系统保留。这些中断通常分配给外部 I/O 设备，使这些设备可以发送中断给处理器。</p>
<p>现在，我们来讨论中断的类型。笼统地来讲，我们可以把中断分为两个主要类型：</p>
<ul>
<li>外部或者硬件引起的中断；</li>
<li>软件引起的中断。</li>
</ul>
<p>第一种类型 - 外部中断，由 <code>Local APIC</code> 或者与 <code>Local APIC</code> 连接的处理器针脚接收。第二种类型 - 软件引起的中断，由处理器自身的特殊情况引起(有时使用特殊架构的指令)。一个常见的关于特殊情况的例子就是 <code>除零</code>。另一个例子就是使用 <code>系统调用（syscall）</code> 退出程序。</p>
<p>就如之前提到过的，中断可以在任何时间因为超出代码和 CPU 控制的原因而发生。另一方面，异常和程序执行 <code>同步（synchronous）</code> ，并且可以被分为 3 类：</p>
<ul>
<li><code>故障（Faults）</code></li>
<li><code>陷入（Traps）</code></li>
<li><code>终止（Aborts）</code></li>
</ul>
<p><code>故障</code> 是在执行一个“不完善的”指令（可以在之后被修正）之前被报告的异常。如果发生了，它允许被中断的程序继续执行。</p>
<p>接下来的 <code>陷入</code> 是一个在执行了 <code>陷入</code> 指令后立刻被报告的异常。陷入同样允许被中断的程序继续执行，就像 <code>故障</code> 一样。</p>
<p>最后的 <code>终止</code> 是一个从不报告引起异常的精确指令的异常，并且不允许被中断的程序继续执行。</p>
<p>我们已经从前面的<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Booting/linux-bootstrap-3.html">部分</a>知道，中断可以分为 <code>可屏蔽的（maskable）</code> 和 <code>不可屏蔽的（non-maskable）</code>。可屏蔽的中断可以被阻塞，使用 <code>x86_64</code> 的指令 - <code>sti</code> 和 <code>cli</code>。我们可以在 Linux 内核代码中找到他们：</p>
<pre><code class="language-C">static inline void native_irq_disable(void)
{
        asm volatile("cli": : :"memory");
}
</code></pre>
<p>and</p>
<pre><code class="language-C">static inline void native_irq_enable(void)
{
        asm volatile("sti": : :"memory");
}
</code></pre>
<p>这两个指令修改了在中断寄存器中的 <code>IF</code> 标识位。 <code>sti</code> 指令设置 <code>IF</code> 标识，<code>cli</code> 指令清除这个标识。不可屏蔽的中断总是被报告。通常，任何硬件上的失败都映射为不可屏蔽中断。</p>
<p>如果多个异常或者中断同时发生，处理器以事先设定好的中断优先级处理他们。我们可以定义下面表中的从最低到最高的优先级：</p>
<pre><code>+----------------------------------------------------------------+
|              |                                                 |
|   Priority   | Description                                     |
|              |                                                 |
+--------------+-------------------------------------------------+
|              | Hardware Reset and Machine Checks               |
|     1        | - RESET                                         |
|              | - Machine Check                                 |
+--------------+-------------------------------------------------+
|              | Trap on Task Switch                             |
|     2        | - T flag in TSS is set                          |
|              |                                                 |
+--------------+-------------------------------------------------+
|              | External Hardware Interventions                 |
|              | - FLUSH                                         |
|     3        | - STOPCLK                                       |
|              | - SMI                                           |
|              | - INIT                                          |
+--------------+-------------------------------------------------+
|              | Traps on the Previous Instruction               |
|     4        | - Breakpoints                                   |
|              | - Debug Trap Exceptions                         |
+--------------+-------------------------------------------------+
|     5        | Nonmaskable Interrupts                          |
+--------------+-------------------------------------------------+
|     6        | Maskable Hardware Interrupts                    |
+--------------+-------------------------------------------------+
|     7        | Code Breakpoint Fault                           |
+--------------+-------------------------------------------------+
|     8        | Faults from Fetching Next Instruction           |
|              | Code-Segment Limit Violation                    |
|              | Code Page Fault                                 |
+--------------+-------------------------------------------------+
|              | Faults from Decoding the Next Instruction       |
|              | Instruction length &gt; 15 bytes                   |
|     9        | Invalid Opcode                                  |
|              | Coprocessor Not Available                       |
|              |                                                 |
+--------------+-------------------------------------------------+
|     10       | Faults on Executing an Instruction              |
|              | Overflow                                        |
|              | Bound error                                     |
|              | Invalid TSS                                     |
|              | Segment Not Present                             |
|              | Stack fault                                     |
|              | General Protection                              |
|              | Data Page Fault                                 |
|              | Alignment Check                                 |
|              | x87 FPU Floating-point exception                |
|              | SIMD floating-point exception                   |
|              | Virtualization exception                        |
+--------------+-------------------------------------------------+
</code></pre>
<p>现在我们了解了一些关于各种类型的中断和异常的内容，是时候转到更实用的部分了。我们从 <code>中断描述符表（IDT）</code> 开始。就如之前所提到的，<code>IDT</code> 保存了中断和异常处理程序的入口指针。<code>IDT</code> 是一个类似于 <code>全局描述符表（Global Descriptor Table）</code>的结构，我们在<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Booting/linux-bootstrap-2.html">内核启动程序</a>的第二部分已经介绍过。但是他们确实有一些不同，<code>IDT</code> 的表项被称为 <code>门（gates）</code>，而不是 <code>描述符（descriptors）</code>。它可以包含下面的一种：</p>
<ul>
<li>中断门（Interrupt gates）</li>
<li>任务门（Task gates）</li>
<li>陷阱门（Trap gates）</li>
</ul>
<p>在 <code>x86</code> 架构中，只有 <a href="http://en.wikipedia.org/wiki/Long_mode">long mode</a> 中断门和陷阱门可以在 <code>x86_64</code> 中引用。就像 <code>全局描述符表</code>，<code>中断描述符表</code> 在 <code>x86</code> 上是一个 8 字节数组门，而在 <code>x86_64</code> 上是一个 16 字节数组门。让我们回忆在<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Booting/linux-bootstrap-2.html">内核启动程序</a>的第二部分，<code>全局描述符表</code> 必须包含 <code>NULL</code> 描述符作为它的第一个元素。与 <code>全局描述符表</code> 不一样的是，<code>中断描述符表</code> 的第一个元素可以是一个门。它并不是强制要求的。比如，你可能还记得我们只是在早期的章节中过渡到<a href="http://en.wikipedia.org/wiki/Protected_mode">保护模式</a>时用 <code>NULL</code> 门加载过中断描述符表：</p>
<pre><code class="language-C">/*
 * Set up the IDT
 */
static void setup_idt(void)
{
	static const struct gdt_ptr null_idt = {0, 0};
	asm volatile("lidtl %0" : : "m" (null_idt));
}
</code></pre>
<p>在 <a href="https://github.com/torvalds/linux/blob/master/arch/x86/boot/pm.c">arch/x86/boot/pm.c</a>中。<code>中断描述符表</code> 可以在线性地址空间和基址的任何地方被加载，只要在 <code>x86</code> 上以 8 字节对齐，在 <code>x86_64</code> 上以 16 字节对齐。<code>IDT</code> 的基址存储在一个特殊的寄存器 - IDTR。在 <code>x86</code> 上有两个指令 - 协调工作来修改 <code>IDTR</code> 寄存器：</p>
<ul>
<li><code>LIDT</code></li>
<li><code>SIDT</code></li>
</ul>
<p>第一个指令 <code>LIDT</code> 用来加载 <code>IDT</code> 的基址，即在 <code>IDTR</code> 的指定操作数。第二个指令 <code>SIDT</code> 用来在指定操作数中读取和存储 <code>IDTR</code> 的内容。在 <code>x86</code> 上 <code>IDTR</code> 寄存器是 48 位，包含了下面的信息：</p>
<pre><code>+-----------------------------------+----------------------+
|                                   |                      |
|     Base address of the IDT       |   Limit of the IDT   |
|                                   |                      |
+-----------------------------------+----------------------+
47                                16 15                    0
</code></pre>
<p>让我们看看 <code>setup_idt</code> 的实现，我们准备了一个 <code>null_idt</code>，并且使用 <code>lidt</code> 指令把它加载到 <code>IDTR</code> 寄存器。注意，<code>null_idt</code> 是 <code>gdt_ptr</code> 类型，后者定义如下：</p>
<pre><code class="language-C">struct gdt_ptr {
        u16 len;
        u32 ptr;
} __attribute__((packed));
</code></pre>
<p>这里我们可以看看 <code>IDTR</code> 结构的定义，就像我们在示意图中看到的一样，由 2 字节和 4 字节（共 48 位）的两个域组成。现在，让我们看看 <code>IDT</code> 入口结构体，它是一个在 <code>x86</code> 中被称为门的 16 字节数组。它拥有下面的结构：</p>
<pre><code>127                                                                             96
+-------------------------------------------------------------------------------+
|                                                                               |
|                                Reserved                                       |
|                                                                               |
+--------------------------------------------------------------------------------
95                                                                              64
+-------------------------------------------------------------------------------+
|                                                                               |
|                               Offset 63..32                                   |
|                                                                               |
+-------------------------------------------------------------------------------+
63                               48 47      46  44   42    39             34    32
+-------------------------------------------------------------------------------+
|                                  |       |  D  |   |     |      |   |   |     |
|       Offset 31..16              |   P   |  P  | 0 |Type |0 0 0 | 0 | 0 | IST |
|                                  |       |  L  |   |     |      |   |   |     |
 -------------------------------------------------------------------------------+
31                                   16 15                                      0
+-------------------------------------------------------------------------------+
|                                      |                                        |
|          Segment Selector            |                 Offset 15..0           |
|                                      |                                        |
+-------------------------------------------------------------------------------+
</code></pre>
<p>为了把索引格式化成 IDT 的格式，处理器把异常和中断向量分为 16 个级别。处理器处理异常和中断的发生就像它看到 <code>call</code> 指令时处理一个程序调用一样。处理器使用中断或异常的唯一的数字或 <code>中断标识码</code> 作为索引来寻找对应的 <code>中断描述符表</code> 的条目。现在让我们更近距离地看看 <code>IDT</code> 条目。</p>
<p>就像我们所看到的一样，在表中的 <code>IDT</code> 条目由下面的域组成：</p>
<ul>
<li><code>0-15</code> bits - 段选择器偏移，处理器用它作为中断处理程序的入口指针基址；</li>
<li><code>16-31</code> bits - 段选择器基址，包含中断处理程序入口指针；</li>
<li><code>IST</code> - 在 <code>x86_64</code> 上的一个新的机制，下面我们会介绍它；</li>
<li><code>DPL</code> - 描述符特权级；</li>
<li><code>P</code> - 段存在标志；</li>
<li><code>48-63</code> bits - 中断处理程序基址的第二部分；</li>
<li><code>64-95</code> bits - 中断处理程序基址的第三部分；</li>
<li><code>96-127</code> bits - CPU 保留位.</li>
</ul>
<p><code>Type</code> 域描述了 <code>IDT</code> 条目的类型。有三种不同的中断处理程序：</p>
<ul>
<li>中断门（Interrupt gate）</li>
<li>陷入门（Trap gate）</li>
<li>任务门（Task gate）</li>
</ul>
<p><code>IST</code> 或者说是 <code>Interrupt Stack Table</code> 是 <code>x86_64</code> 中的新机制，它用来代替传统的栈切换机制。之前的 <code>x86</code> 架构提供的机制可以在响应中断时自动切换栈帧。<code>IST</code> 是 <code>x86</code> 栈切换模式的一个修改版，在它使能之后可以无条件地切换栈，并且可以被任何与确定中断（我们将在下面介绍它）关联的 <code>IDT</code> 条目中的中断使能。从这里可以看出，<code>IST</code> 并不是所有的中断必须的，一些中断可以继续使用传统的栈切换模式。<code>IST</code> 机制在<a href="http://en.wikipedia.org/wiki/Task_state_segment">任务状态段（Task State Segment）</a>或者 <code>TSS</code> 中提供了 7 个 <code>IST</code> 指针。<code>TSS</code> 是一个包含进程信息的特殊结构，用来在执行中断或者处理 Linux 内核异常的时候做栈切换。每一个指针都被 <code>IDT</code> 中的中断门引用。</p>
<p><code>中断描述符表</code> 使用 <code>gate_desc</code> 的数组描述：</p>
<pre><code class="language-C">extern gate_desc idt_table[];
</code></pre>
<p><code>gate_desc</code> 定义如下：</p>
<pre><code class="language-C">#ifdef CONFIG_X86_64
...
...
...
typedef struct gate_struct64 gate_desc;
...
...
...
#endif
</code></pre>
<p><code>gate_struct64</code> 定义如下：</p>
<pre><code class="language-C">struct gate_struct64 {
        u16 offset_low;
        u16 segment;
        unsigned ist : 3, zero0 : 5, type : 5, dpl : 2, p : 1;
        u16 offset_middle;
        u32 offset_high;
        u32 zero1;
} __attribute__((packed));
</code></pre>
<p>在 <code>x86_64</code> 架构中，每一个活动的线程在 Linux 内核中都有一个很大的栈。这个栈的大小由 <code>THREAD_SIZE</code> 定义，而且与下面的定义相等：</p>
<pre><code class="language-C">#define PAGE_SHIFT      12
#define PAGE_SIZE       (_AC(1,UL) &lt;&lt; PAGE_SHIFT)
...
...
...
#define THREAD_SIZE_ORDER       (2 + KASAN_STACK_ORDER)
#define THREAD_SIZE  (PAGE_SIZE &lt;&lt; THREAD_SIZE_ORDER)
</code></pre>
<p><code>PAGE_SIZE</code> 是 <code>4096</code> 字节，<code>THREAD_SIZE_ORDER</code> 的值依赖于 <code>KASAN_STACK_ORDER</code>。就像我们看到的，<code>KASAN_STACK</code> 依赖于 <code>CONFIG_KASAN</code> 内核配置参数，它定义如下：</p>
<pre><code class="language-C">#ifdef CONFIG_KASAN
    #define KASAN_STACK_ORDER 1
#else
    #define KASAN_STACK_ORDER 0
#endif
</code></pre>
<p><code>KASan</code> 是一个运行时内存<a href="http://lwn.net/Articles/618180/">调试器</a>。所以，如果 <code>CONFIG_KASAN</code> 被禁用，<code>THREAD_SIZE</code> 是 <code>16384</code> ；如果内核配置选项打开，<code>THREAD_SIZE</code> 的值是 <code>32768</code>。这块栈空间保存着有用的数据，只要线程是活动状态或者僵尸状态。但是当线程在用户空间的时候，这个内核栈是空的，除非 <code>thread_info</code> 结构（关于这个结构的详细信息在 Linux 内核初始程序的第四<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Initialization/linux-initialization-4.html">部分</a>）在这个栈空间的底部。活动的或者僵尸线程并不是在他们栈中的唯一的线程，与每一个 CPU 关联的特殊栈也存在于这个空间。当内核在这个 CPU 上执行代码的时候，这些栈处于活动状态；当在这个 CPU 上执行用户空间代码时，这些栈不包含任何有用的信息。每一个 CPU 也有一个特殊的 per-cpu 栈。首先是给外部中断使用的 <code>中断栈（interrupt stack）</code>。它的大小定义如下：</p>
<pre><code class="language-C">#define IRQ_STACK_ORDER (2 + KASAN_STACK_ORDER)
#define IRQ_STACK_SIZE (PAGE_SIZE &lt;&lt; IRQ_STACK_ORDER)
</code></pre>
<p>或者是 <code>16384</code> 字节。Per-cpu 的中断栈在 <code>x86_64</code> 架构中使用 <code>irq_stack_union</code> 联合描述:</p>
<pre><code class="language-C">union irq_stack_union {
	char irq_stack[IRQ_STACK_SIZE];

    struct {
		char gs_base[40];
		unsigned long stack_canary;
	};
};
</code></pre>
<p>第一个 <code>irq_stack</code> 域是一个 16KB 的数组。然后你可以看到 <code>irq_stack_union</code> 联合包含了一个结构体，这个结构体有两个域：</p>
<ul>
<li><code>gs_base</code> - 总是指向 <code>irqstack</code> 联合底部的 <code>gs</code> 寄存器。在 <code>x86_64</code> 中， per-cpu（更多关于 <code>per-cpu</code> 变量的信息可以阅读特定的<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Concepts/per-cpu.html">章节</a>） 和 stack canary 共享 <code>gs</code> 寄存器。所有的 per-cpu 标志初始值为零，并且 <code>gs</code> 指向 per-cpu 区域的开始。你已经知道<a href="http://en.wikipedia.org/wiki/Memory_segmentation">段内存模式</a>已经废除很长时间了，但是我们可以使用<a href="http://en.wikipedia.org/wiki/Model-specific_register">特殊模块寄存器（Model specific registers）</a>给这两个段寄存器 - <code>fs</code> 和 <code>gs</code> 设置基址，并且这些寄存器仍然可以被用作地址寄存器。如果你记得 Linux 内核初始程序的第一<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Initialization/linux-initialization-1.html">部分</a>，你会记起我们设置了 <code>gs</code> 寄存器：</li>
</ul>
<pre><code class="language-assembly">	movl	$MSR_GS_BASE,%ecx
	movl	initial_gs(%rip),%eax
	movl	initial_gs+4(%rip),%edx
	wrmsr
</code></pre>
<p><code>initial_gs</code> 指向 <code>irq_stack_union</code>:</p>
<pre><code class="language-assembly">GLOBAL(initial_gs)
.quad	INIT_PER_CPU_VAR(irq_stack_union)
</code></pre>
<ul>
<li><code>stack_canary</code> - <a href="http://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">Stack canary</a> 对于中断栈来说是一个用来验证栈是否已经被修改的 <code>栈保护者（stack protector）</code>。<code>gs_base</code> 是一个 40 字节的数组，<code>GCC</code> 要求 stack canary 在被修正过的偏移量上，并且 <code>gs</code> 的值在 <code>x86_64</code> 架构上必须是 <code>40</code>，在 <code>x86</code> 架构上必须是 <code>20</code>。</li>
</ul>
<p><code>irq_stack_union</code> 是 <code>percpu</code> 的第一个数据, 我们可以在 <code>System.map</code>中看到它：</p>
<pre><code>0000000000000000 D __per_cpu_start
0000000000000000 D irq_stack_union
0000000000004000 d exception_stacks
0000000000009000 D gdt_page
...
...
...
</code></pre>
<p>我们可以看到它在代码中的定义:</p>
<pre><code class="language-C">DECLARE_PER_CPU_FIRST(union irq_stack_union, irq_stack_union) __visible;
</code></pre>
<p>现在，是时候来看 <code>irq_stack_union</code> 的初始化过程了。除了 <code>irq_stack_union</code> 的定义，我们可以在<a href="https://github.com/torvalds/linux/blob/master/arch/x86/include/asm/processor.h">arch/x86/include/asm/processor.h</a>中查看下面的 per-cpu 变量</p>
<pre><code class="language-C">DECLARE_PER_CPU(char *, irq_stack_ptr);
DECLARE_PER_CPU(unsigned int, irq_count);
</code></pre>
<p>第一个就是 <code>irq_stack_ptr</code>。从这个变量的名字中可以知道，它显然是一个指向这个栈顶的指针。第二个 <code>irq_count</code> 用来检查 CPU 是否已经在中断栈。<code>irq_stack_ptr</code> 的初始化在<a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/setup_percpu.c">arch/x86/kernel/setup_percpu.c</a>的 <code>setup_per_cpu_areas</code> 函数中：</p>
<pre><code class="language-C">void __init setup_per_cpu_areas(void)
{
...
...
#ifdef CONFIG_X86_64
for_each_possible_cpu(cpu) {
    ...
    ...
    ...
    per_cpu(irq_stack_ptr, cpu) =
            per_cpu(irq_stack_union.irq_stack, cpu) +
            IRQ_STACK_SIZE - 64;
    ...
    ...
    ...
#endif
...
...
}
</code></pre>
<p>现在，我们一个一个查看所有 CPU，并且设置 <code>irq_stack_ptr</code>。事实证明它等于中断栈的顶减去 <code>64</code>。为什么是 <code>64</code>？TODO [<a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/cpu/common.c">arch/x86/kernel/cpu/common.c</a>] 代码如下：</p>
<pre><code class="language-C">void load_percpu_segment(int cpu)
{
        ...
        ...
        ...
        loadsegment(gs, 0);
        wrmsrl(MSR_GS_BASE, (unsigned long)per_cpu(irq_stack_union.gs_base, cpu));
}
</code></pre>
<p>就像我们所知道的一样，<code>gs</code> 寄存器指向中断栈的栈底：</p>
<pre><code class="language-assembly">	movl	$MSR_GS_BASE,%ecx
	movl	initial_gs(%rip),%eax
	movl	initial_gs+4(%rip),%edx
	wrmsr

	GLOBAL(initial_gs)
	.quad	INIT_PER_CPU_VAR(irq_stack_union)
</code></pre>
<p>现在我们可以看到 <code>wrmsr</code> 指令，这个指令从 <code>edx:eax</code> 加载数据到 被 <code>ecx</code> 指向的<a href="(http://en.wikipedia.org/wiki/Model-specific_register)">MSR寄存器</a>。在这里MSR寄存器是 <code>MSR_GS_BASE</code>，它保存了被 <code>gs</code> 寄存器指向的内存段的基址。<code>edx:eax</code> 指向 <code>initial_gs</code> 的地址，它就是 <code>irq_stack_union</code> 的基址。</p>
<p>我们还知道，<code>x86_64</code> 有一个叫 <code>中断栈表（Interrupt Stack Table）</code> 或者 <code>IST</code> 的组件，当发生不可屏蔽中断、双重错误等等的时候，这个组件提供了切换到新栈的功能。这可以到达7个 <code>IST</code> per-cpu 入口。其中一些如下; There can be up to seven <code>IST</code> entries per-cpu. Some of them are:</p>
<ul>
<li><code>DOUBLEFAULT_STACK</code></li>
<li><code>NMI_STACK</code></li>
<li><code>DEBUG_STACK</code></li>
<li><code>MCE_STACK</code></li>
</ul>
<p>或者</p>
<pre><code class="language-C">#define DOUBLEFAULT_STACK 1
#define NMI_STACK 2
#define DEBUG_STACK 3
#define MCE_STACK 4
</code></pre>
<p>所有被 <code>IST</code> 切换到新栈的中断门描述符都由 <code>set_intr_gate_ist</code> 函数初始化。例如:</p>
<pre><code class="language-C">set_intr_gate_ist(X86_TRAP_NMI, &amp;nmi, NMI_STACK);
...
...
...
set_intr_gate_ist(X86_TRAP_DF, &amp;double_fault, DOUBLEFAULT_STACK);
</code></pre>
<p>其中 <code>&amp;nmi</code> 和 <code>&amp;double_fault</code> 是中断函数的入口地址：</p>
<pre><code class="language-C">asmlinkage void nmi(void);
asmlinkage void double_fault(void);
</code></pre>
<p>定义在 <a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/entry_64.S">arch/x86/kernel/entry_64.S</a>中</p>
<pre><code class="language-assembly">idtentry double_fault do_double_fault has_error_code=1 paranoid=2
...
...
...
ENTRY(nmi)
...
...
...
END(nmi)
</code></pre>
<p>当一个中断或者异常发生时，新的 <code>ss</code> 选择器被强制置为 <code>NULL</code>，并且 <code>ss</code> 选择器的 <code>rpl</code> 域被设置为新的 <code>cpl</code>。旧的 <code>ss</code>、<code>rsp</code>、寄存器标志、<code>cs</code>、<code>rip</code> 被压入新栈。在 64 位模型下，中断栈帧大小固定为 8 字节，所以我们可以得到下面的栈:</p>
<pre><code>+---------------+
|               |
|      SS       | 40
|      RSP      | 32
|     RFLAGS    | 24
|      CS       | 16
|      RIP      | 8
|   Error code  | 0
|               |
+---------------+
</code></pre>
<p>如果在中断门中 <code>IST</code> 域不是 <code>0</code>，我们把 <code>IST</code> 读到 <code>rsp</code> 中。如果它关联了一个中断向量错误码，我们再把这个错误码压入栈。如果中断向量没有错误码，就继续并且把虚拟错误码压入栈。我们必须做以上的步骤以确保栈一致性。接下来我们从门描述符中加载段选择器域到 CS 寄存器中，并且通过验证第 <code>21</code> 位的值来验证目标代码是一个 64 位代码段，例如 <code>L</code> 位在 <code>全局描述符表（Global Descriptor Table）</code>。最后我们从门描述符中加载偏移域到 <code>rip</code> 中，<code>rip</code> 是中断处理函数的入口指针。然后中断函数开始执行，在中断函数执行结束后，它必须通过 <code>iret</code> 指令把控制权交还给被中断进程。<code>iret</code> 指令无条件地弹出栈指针（<code>ss:rsp</code>）来恢复被中断的进程，并且不会依赖于 <code>cpl</code> 改变。</p>
<p>这就是中断的所有过程。</p>
<h2 id="总结">总结</h2>
<p>关于 Linux 内核的中断和中断处理的第一部分至此结束。我们初步了解了一些理论和与中断和异常相关的初始化条件。在下一部分，我会接着深入了解中断和中断处理 - 更深入了解她真实的样子。</p>
<p>如果你有任何问题或建议，请给我发评论或者给我发 <a href="https://twitter.com/0xAX">Twitter</a>。</p>
<p><strong>请注意英语并不是我的母语，我为任何表达不清楚的地方感到抱歉。如果你发现任何错误请发 PR 到 <a href="https://github.com/MintCN/linux-insides-zh">linux-insides</a>。(译者注：翻译问题请发 PR 到 <a href="https://www.gitbook.com/book/xinqiu/linux-insides-cn">linux-insides-cn</a>)</strong></p>
<h2 id="链接">链接</h2>
<ul>
<li><a href="http://en.wikipedia.org/wiki/Programmable_Interrupt_Controller">PIC</a></li>
<li><a href="https://en.wikipedia.org/wiki/Advanced_Programmable_Interrupt_Controller">Advanced Programmable Interrupt Controller</a></li>
<li><a href="http://en.wikipedia.org/wiki/Protected_mode">protected mode</a></li>
<li><a href="http://en.wikipedia.org/wiki/Long_mode">long mode</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/x86/x86_64/kernel-stacks">kernel stacks</a></li>
<li><a href="http://en.wikipedia.org/wiki/Task_state_segment">Task State Segement</a></li>
<li><a href="http://en.wikipedia.org/wiki/Memory_segmentation">segmented memory model</a></li>
<li><a href="http://en.wikipedia.org/wiki/Model-specific_register">Model specific registers</a></li>
<li><a href="http://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">Stack canary</a></li>
<li><a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Initialization/index.html">Previous chapter</a></li>
</ul>
</div>
<hr class="uk-article-divider">
<div class="uk-block uk-block-muted uk-padding-top-remove uk-padding-bottom-remove uk-margin-large-top  book-recommend-wrap">
<div class="uk-margin-top uk-margin-bottom uk-margin-left uk-margin-right">
<div class="uk-margin uk-text-muted "><i class="uk-icon-outdent uk-icon-justify uk-margin-small-right"></i>书籍推荐</div>
<div class="books">
<ul class="uk-book-list">
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/195/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/195/index.html">Linux命令大全搜索工具</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/111.html">jaywcjlove</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">30页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2021年10月24日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 个"></span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/36/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/36/index.html">米斯特白帽培训讲义</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/15.html">wizardforcel</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">24页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年5月3日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 99个">99</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/28/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/28/index.html">笨办法学 Linux</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/15.html">wizardforcel</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">34页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年5月3日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 326个">326</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/99/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/javascript_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/99/index.html">ECMAScript 6入门</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/60.html">likebeta</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="javascript">javascript</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">24页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年6月29日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 0个">0</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/134/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/github_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/134/index.html">GitHub 漫游指南</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/72.html">phodal</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="github">github</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">1页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年8月3日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 3472个">3472</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/158/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/java_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/158/index.html">java语法整理</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/90.html">niliv</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="java">java</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">42页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年5月26日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 2个">2</span>
</div>
</div>
</div>
</li>
<hr>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<nav class="tm-navbar uk-navbar uk-navbar-attached reader-nav">
<div class="uk-float-left uk-margin-small-top">
<a href="javascript:;" title="目录菜单" class="show-menu  uk-icon-hover  uk-icon-align-justify uk-margin-right"></a>
<div data-uk-dropdown="{mode:'click',pos:'bottom-left'}" class="font-setting-wrap">
<a class="uk-icon-hover uk-icon-font uk-margin-right" aria-label="字体设置" href="javascript:;"></a>
<div class="uk-dropdown dropdown-menu">
<div class="dropdown-caret"><span class="caret-outer"></span><span class="caret-inner"></span></div>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-reduce">小字</button>
<button class="uk-button-link button size-2 font-enlarge">大字</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-1 ">宋体</button>
<button class="uk-button-link button size-2 font-2 ">黑体</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-3 color-theme-sun "><i class="uk-icon-sun-o"></i>白天</button>
<button class="uk-button-link button size-3 color-theme-eye "><i class="uk-icon-eye"></i>护眼</button>
<button class="uk-button-link button size-3 color-theme-moon "><i class="uk-icon-moon-o"></i>夜晚</button></div>
</div>
</div>
<a class="logo uk-margin-right" href="../../../" title="返回首页"><img class="" src="../../../static/components/images/icon_32.png" /></a>
</div>
<div class="uk-navbar-flip  uk-hidden-small">
<div id="share-box"></div>
</div>
</nav>
<div id="menu-id" class="uk-offcanvas reader-offcanvas">
<div class="uk-offcanvas-bar">
<ul class="book-menu-bar uk-nav uk-nav-offcanvas" data-uk-nav>
<li>
<a href="../../../book/104/index.html" data-book-page-rel-url="index.html" data-book-page-id="0" title="封面">封面</a>
</li>
<li>
<a class="pjax" href="../../../book/104/readme.html" data-book-page-rel-url="readme.html" data-book-page-id="0" title="简介">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/README.html" title="简介" data-book-page-rel-url="README.html" data-book-page-id="7458">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/README.html" title="引导" data-book-page-rel-url="Booting/README.html" data-book-page-id="7459">引导</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-1.html" title="从引导加载程序内核" data-book-page-rel-url="Booting/linux-bootstrap-1.html" data-book-page-id="7460">从引导加载程序内核</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-2.html" title="在内核安装代码的第一步" data-book-page-rel-url="Booting/linux-bootstrap-2.html" data-book-page-id="7461">在内核安装代码的第一步</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-3.html" title="视频模式初始化和转换到保护模式" data-book-page-rel-url="Booting/linux-bootstrap-3.html" data-book-page-id="7462">视频模式初始化和转换到保护模式</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-4.html" title="过渡到 64 位模式" data-book-page-rel-url="Booting/linux-bootstrap-4.html" data-book-page-id="7463">过渡到 64 位模式</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-5.html" title="内核解压缩" data-book-page-rel-url="Booting/linux-bootstrap-5.html" data-book-page-id="7464">内核解压缩</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/README.html" title="初始化" data-book-page-rel-url="Initialization/README.html" data-book-page-id="7465">初始化</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-1.html" title="内核解压之后的首要步骤" data-book-page-rel-url="Initialization/linux-initialization-1.html" data-book-page-id="7466">内核解压之后的首要步骤</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-2.html" title="早期的中断和异常控制" data-book-page-rel-url="Initialization/linux-initialization-2.html" data-book-page-id="7467">早期的中断和异常控制</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-3.html" title="在到达内核入口之前最后的准备" data-book-page-rel-url="Initialization/linux-initialization-3.html" data-book-page-id="7468">在到达内核入口之前最后的准备</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-4.html" title="内核入口 - start_kernel" data-book-page-rel-url="Initialization/linux-initialization-4.html" data-book-page-id="7469">内核入口 - start_kernel</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-5.html" title="体系架构初始化" data-book-page-rel-url="Initialization/linux-initialization-5.html" data-book-page-id="7470">体系架构初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-6.html" title="进一步初始化指定体系架构" data-book-page-rel-url="Initialization/linux-initialization-6.html" data-book-page-id="7471">进一步初始化指定体系架构</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-7.html" title="最后对指定体系架构初始化" data-book-page-rel-url="Initialization/linux-initialization-7.html" data-book-page-id="7472">最后对指定体系架构初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-8.html" title="调度器初始化" data-book-page-rel-url="Initialization/linux-initialization-8.html" data-book-page-id="7473">调度器初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-9.html" title="RCU 初始化" data-book-page-rel-url="Initialization/linux-initialization-9.html" data-book-page-id="7474">RCU 初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-10.html" title="初始化结束" data-book-page-rel-url="Initialization/linux-initialization-10.html" data-book-page-id="7475">初始化结束</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/README.html" title="中断" data-book-page-rel-url="Interrupts/README.html" data-book-page-id="7476">中断</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-1.html" title="中断和中断处理 Part 1." data-book-page-rel-url="Interrupts/interrupts-1.html" data-book-page-id="7477">中断和中断处理 Part 1.</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-2.html" title="深入 Linux 内核中的中断" data-book-page-rel-url="Interrupts/interrupts-2.html" data-book-page-id="7478">深入 Linux 内核中的中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-3.html" title="初步中断处理" data-book-page-rel-url="Interrupts/interrupts-3.html" data-book-page-id="7479">初步中断处理</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-4.html" title="中断处理" data-book-page-rel-url="Interrupts/interrupts-4.html" data-book-page-id="7480">中断处理</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-5.html" title="异常处理的实现" data-book-page-rel-url="Interrupts/interrupts-5.html" data-book-page-id="7481">异常处理的实现</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-6.html" title="处理不可屏蔽中断" data-book-page-rel-url="Interrupts/interrupts-6.html" data-book-page-id="7482">处理不可屏蔽中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-7.html" title="深入外部硬件中断" data-book-page-rel-url="Interrupts/interrupts-7.html" data-book-page-id="7483">深入外部硬件中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-8.html" title="IRQs的非早期初始化" data-book-page-rel-url="Interrupts/interrupts-8.html" data-book-page-id="7484">IRQs的非早期初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-9.html" title="Softirq, Tasklets and Workqueues" data-book-page-rel-url="Interrupts/interrupts-9.html" data-book-page-id="7485">Softirq, Tasklets and Workqueues</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-10.html" title="最后一部分" data-book-page-rel-url="Interrupts/interrupts-10.html" data-book-page-id="7486">最后一部分</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/README.html" title="系统调用" data-book-page-rel-url="SysCall/README.html" data-book-page-id="7487">系统调用</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-1.html" title="系统调用概念简介" data-book-page-rel-url="SysCall/syscall-1.html" data-book-page-id="7488">系统调用概念简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-2.html" title="Linux 内核如何处理系统调用" data-book-page-rel-url="SysCall/syscall-2.html" data-book-page-id="7489">Linux 内核如何处理系统调用</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-3.html" title="vsyscall and vDSO" data-book-page-rel-url="SysCall/syscall-3.html" data-book-page-id="7490">vsyscall and vDSO</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-4.html" title="Linux 内核如何运行程序" data-book-page-rel-url="SysCall/syscall-4.html" data-book-page-id="7491">Linux 内核如何运行程序</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/README.html" title="定时器和时钟管理" data-book-page-rel-url="Timers/README.html" data-book-page-id="7492">定时器和时钟管理</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-1.html" title="简介" data-book-page-rel-url="Timers/timers-1.html" data-book-page-id="7493">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-2.html" title="时钟源框架简介" data-book-page-rel-url="Timers/timers-2.html" data-book-page-id="7494">时钟源框架简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-3.html" title="The tick broadcast framework and dyntick" data-book-page-rel-url="Timers/timers-3.html" data-book-page-id="7495">The tick broadcast framework and dyntick</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-4.html" title="定时器介绍" data-book-page-rel-url="Timers/timers-4.html" data-book-page-id="7496">定时器介绍</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-5.html" title="Clockevents 框架简介" data-book-page-rel-url="Timers/timers-5.html" data-book-page-id="7497">Clockevents 框架简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-6.html" title="x86 相关的时钟源" data-book-page-rel-url="Timers/timers-6.html" data-book-page-id="7498">x86 相关的时钟源</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-7.html" title="Linux 内核中与时钟相关的系统调用" data-book-page-rel-url="Timers/timers-7.html" data-book-page-id="7499">Linux 内核中与时钟相关的系统调用</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/README.html" title="同步原语" data-book-page-rel-url="SyncPrim/README.html" data-book-page-id="7500">同步原语</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-1.html" title="自旋锁简介" data-book-page-rel-url="SyncPrim/sync-1.html" data-book-page-id="7501">自旋锁简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-2.html" title="队列自旋锁" data-book-page-rel-url="SyncPrim/sync-2.html" data-book-page-id="7502">队列自旋锁</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-3.html" title="信号量" data-book-page-rel-url="SyncPrim/sync-3.html" data-book-page-id="7503">信号量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-4.html" title="互斥锁" data-book-page-rel-url="SyncPrim/sync-4.html" data-book-page-id="7504">互斥锁</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-5.html" title="读者/写者信号量" data-book-page-rel-url="SyncPrim/sync-5.html" data-book-page-id="7505">读者/写者信号量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-6.html" title="顺序锁" data-book-page-rel-url="SyncPrim/sync-6.html" data-book-page-id="7506">顺序锁</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/README.html" title="内存管理" data-book-page-rel-url="MM/README.html" data-book-page-id="7508">内存管理</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-1.html" title="内存块" data-book-page-rel-url="MM/linux-mm-1.html" data-book-page-id="7509">内存块</a>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-2.html" title="固定映射地址和 ioremap" data-book-page-rel-url="MM/linux-mm-2.html" data-book-page-id="7510">固定映射地址和 ioremap</a>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-3.html" title="kmemcheck" data-book-page-rel-url="MM/linux-mm-3.html" data-book-page-id="7511">kmemcheck</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/README.html" title="概念" data-book-page-rel-url="Concepts/README.html" data-book-page-id="7512">概念</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Concepts/per-cpu.html" title="每个 CPU 的变量" data-book-page-rel-url="Concepts/per-cpu.html" data-book-page-id="7513">每个 CPU 的变量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/cpumask.html" title="CPU 掩码" data-book-page-rel-url="Concepts/cpumask.html" data-book-page-id="7514">CPU 掩码</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/initcall.html" title="initcall 机制" data-book-page-rel-url="Concepts/initcall.html" data-book-page-id="7515">initcall 机制</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/notification_chains.html" title="Linux 内核的通知链" data-book-page-rel-url="Concepts/notification_chains.html" data-book-page-id="7516">Linux 内核的通知链</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/README.html" title="Linux 内核中的数据结构" data-book-page-rel-url="DataStructures/README.html" data-book-page-id="7517">Linux 内核中的数据结构</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/DataStructures/dlist.html" title="双向链表" data-book-page-rel-url="DataStructures/dlist.html" data-book-page-id="7518">双向链表</a>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/radix-tree.html" title="基数树" data-book-page-rel-url="DataStructures/radix-tree.html" data-book-page-id="7519">基数树</a>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/bitmap.html" title="位数组" data-book-page-rel-url="DataStructures/bitmap.html" data-book-page-id="7520">位数组</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Theory/README.html" title="理论" data-book-page-rel-url="Theory/README.html" data-book-page-id="7521">理论</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Theory/Paging.html" title="分页" data-book-page-rel-url="Theory/Paging.html" data-book-page-id="7522">分页</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Theory/ELF.html" title="Elf64 格式" data-book-page-rel-url="Theory/ELF.html" data-book-page-id="7523">Elf64 格式</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/README.html" title="杂项" data-book-page-rel-url="Misc/README.html" data-book-page-id="7524">杂项</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Misc/how_kernel_compiled.html" title="内核编译方法" data-book-page-rel-url="Misc/how_kernel_compiled.html" data-book-page-id="7525">内核编译方法</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/linkers.html" title="链接器" data-book-page-rel-url="Misc/linkers.html" data-book-page-id="7526">链接器</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/contribute.html" title="Linux 内核开发" data-book-page-rel-url="Misc/contribute.html" data-book-page-id="7527">Linux 内核开发</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/program_startup.html" title="用户空间的程序启动过程" data-book-page-rel-url="Misc/program_startup.html" data-book-page-id="7528">用户空间的程序启动过程</a>
</li>
<li>
<a class="pjax" href="../../../book/104/" title="Write and Submit your first Linux kernel Patch" data-book-page-rel-url="" data-book-page-id="7507">Write and Submit your first Linux kernel Patch</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/KernelStructures/README.html" title="内核数据结构" data-book-page-rel-url="KernelStructures/README.html" data-book-page-id="7529">内核数据结构</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/KernelStructures/idt.html" title="中断描述符表" data-book-page-rel-url="KernelStructures/idt.html" data-book-page-id="7530">中断描述符表</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/LINKS.html" title="有帮助的链接" data-book-page-rel-url="LINKS.html" data-book-page-id="7531">有帮助的链接</a>
</li>
<li>
<a class="pjax" href="../../../book/104/contributors.html" title="贡献者" data-book-page-rel-url="contributors.html" data-book-page-id="7532">贡献者</a>
</li>
</ul>
</div>
</div>
<script src="https://cdn.staticfile.net/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript" src="../../../static/components/uikit-2.27.5/js/uikit.reader.js"></script>
<script type="text/javascript" src="../../../static/components/social-share/social-share.min.js"></script>
<script>(function(){var bp =document.createElement('script');var curProtocol =window.location.protocol.split(':')[0];if (curProtocol ==='https') {bp.src ='https://zz.bdstatic.com/linksubmit/push.js';}
else {bp.src ='http://push.zhanzhang.baidu.com/push.js';}
var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
<script src="https://cdn.staticfile.net/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.staticfile.net/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>
<script src="https://cdn.staticfile.net/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://cdn.staticfile.net/uikit/2.27.5/js/components/lightbox.min.js"></script>
<link rel="dns-prefetch" href="../../..//cdn.mathjax.org" />
<script type="text/x-mathjax-config">
 function initMathJax() {
    var mathId = $("book-content-section")[0];
    MathJax.Hub.Config({
        tex2jax: {skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code','a']},
        showProcessingMessages: false,
        messageStyle: "none"
    });
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,mathId]);
 };
initMathJax();
</script>
<script src='https://cdn.staticfile.net/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
<style>
	.MathJax_Display{display:inline!important;}
</style>
<script type="text/javascript" src="../../../static/components/js/reader.js"></script>
<script type="text/javascript">var bookId =104;var bookPageId =7477;var bookPageRelUrl ='Interrupts/interrupts-1.html';</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
</body>
</html>