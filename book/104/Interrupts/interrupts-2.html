
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<title>深入 Linux 内核中的中断-Linux 内核揭密</title>
<meta content='深入 Linux 内核中的中断,Linux 内核揭密' name='keywords'>
<meta content='深入 Linux 内核中的中断,Linux 内核揭密' name='description'>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="zh-CN" />
<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=no"../../../>
<meta name="applicable-device" content="pc,mobile">
<link rel="shortcut icon" href="../../../favicon.ico" type="image/x-icon" />
<meta name="renderer" content="webkit">
<link rel="stylesheet" href="../../../static/components/uikit-2.27.5/css/uikit.custom.css">
<link rel="stylesheet" href="../../../static/components/social-share/social-share.min.css">
<link rel="stylesheet" href="../../../static/components/highlight/styles/custom.css">
<link rel="stylesheet" href="../../../static/components/css/base.css">
<link rel="stylesheet" href="../../../static/components/css/reader.css">
<link rel="stylesheet" href="../../../static/components/css/markdown.css">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5313208362165053" crossorigin="anonymous"></script>
</head>
<body>
<div class=" book-main-wrap uk-container uk-container-center uk-margin-top ">
<div class="uk-grid">
<div class="uk-width-1-1 reader-wrap ">
<div class=" bottom-nav uk-clearfix ">
<div class="uk-align-left ">
<a href="../../../book/104/Interrupts/interrupts-1.html">
<i class="nav-icon-left uk-icon-small  uk-icon-caret-left"></i>
<span class="">中断和中断处理 Par..</span>
</a>
</div>
<div class="uk-align-right ">
<a href="../../../book/104/Interrupts/interrupts-3.html">
<span class="">初步中断处理</span>
<i class="nav-icon-right uk-icon-small  uk-icon-caret-right"></i>
</a>
</div>
</div>
<div class="uk-text-center">
<h2 class="book-page-title uk-container-center">
<a href="../../../book/104/index.html">Linux 内核揭密</a>
<a target="_blank" rel="nofollow" href="https://github.com/ye11ow/linux-insides-zh" class="uk-icon-button uk-icon-github" title="github项目地址"></a>
</h2>
</div>
<script type="text/javascript" src="../../../static/components/js/app_intro.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5313208362165053" data-ad-slot="1328047120"></ins>
<script>(adsbygoogle =window.adsbygoogle ||[]).push({});</script>
<hr class="uk-article-divider">
<div class="book-content-section  md-content-section  uk-margin-bottom">
<h1 id="interrupts-and-interrupt-handling-part-2">Interrupts and Interrupt Handling. Part 2.</h1>
<h2 id="start-to-dive-into-interrupt-and-exceptions-handling-in-the-linux-kernel">Start to dive into interrupt and exceptions handling in the Linux kernel</h2>
<p>We saw some theory about interrupts and exception handling in the previous <a href="http://0xax.gitbooks.io/linux-insides/content/interrupts/interrupts-1.html">part</a> and as I already wrote in that part, we will start to dive into interrupts and exceptions in the Linux kernel source code in this part. As you already can note, the previous part mostly described theoretical aspects and in this part we will start to dive directly into the Linux kernel source code. We will start to do it as we did it in other chapters, from the very early places. We will not see the Linux kernel source code from the earliest <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/boot/header.S#L292">code lines</a> as we saw it for example in the <a href="http://0xax.gitbooks.io/linux-insides/content/Booting/index.html">Linux kernel booting process</a> chapter, but we will start from the earliest code which is related to the interrupts and exceptions. In this part we will try to go through the all interrupts and exceptions related stuff which we can find in the Linux kernel source code.</p>
<p>If you've read the previous parts, you can remember that the earliest place in the Linux kernel <code>x86_64</code> architecture-specific source code which is related to the interrupt is located in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/boot/pm.c">arch/x86/boot/pm.c</a> source code file and represents the first setup of the <a href="http://en.wikipedia.org/wiki/Interrupt_descriptor_table">Interrupt Descriptor Table</a>. It occurs right before the transition into the <a href="http://en.wikipedia.org/wiki/Protected_mode">protected mode</a> in the <code>go_to_protected_mode</code> function by the call of the <code>setup_idt</code>:</p>
<pre><code class="language-C">void go_to_protected_mode(void)
{
	...
	setup_idt();
	...
}
</code></pre>
<p>The <code>setup_idt</code> function is defined in the same source code file as the <code>go_to_protected_mode</code> function and just loads the address of the <code>NULL</code> interrupts descriptor table:</p>
<pre><code class="language-C">static void setup_idt(void)
{
	static const struct gdt_ptr null_idt = {0, 0};
	asm volatile("lidtl %0" : : "m" (null_idt));
}
</code></pre>
<p>where <code>gdt_ptr</code> represents a special 48-bit <code>GDTR</code> register which must contain the base address of the <code>Global Descriptor Table</code>:</p>
<pre><code class="language-C">struct gdt_ptr {
	u16 len;
	u32 ptr;
} __attribute__((packed));
</code></pre>
<p>Of course in our case the <code>gdt_ptr</code> does not represent the <code>GDTR</code> register, but <code>IDTR</code> since we set <code>Interrupt Descriptor Table</code>. You will not find an <code>idt_ptr</code> structure, because if it had been in the Linux kernel source code, it would have been the same as <code>gdt_ptr</code> but with different name. So, as you can understand there is no sense to have two similar structures which differ only by name. You can note here, that we do not fill the <code>Interrupt Descriptor Table</code> with entries, because it is too early to handle any interrupts or exceptions at this point. That's why we just fill the <code>IDT</code> with <code>NULL</code>.</p>
<p>After the setup of the <a href="http://en.wikipedia.org/wiki/Interrupt_descriptor_table">Interrupt descriptor table</a>, <a href="http://en.wikipedia.org/wiki/GDT">Global Descriptor Table</a> and other stuff we jump into <a href="http://en.wikipedia.org/wiki/Protected_mode">protected mode</a> in the - <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/boot/pmjump.S">arch/x86/boot/pmjump.S</a>. You can read more about it in the <a href="http://0xax.gitbooks.io/linux-insides/content/Booting/linux-bootstrap-3.html">part</a> which describes the transition to protected mode.</p>
<p>We already know from the earliest parts that entry to protected mode is located in the <code>boot_params.hdr.code32_start</code> and you can see that we pass the entry of the protected mode and <code>boot_params</code> to the <code>protected_mode_jump</code> in the end of the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/boot/pm.c">arch/x86/boot/pm.c</a>:</p>
<pre><code class="language-C">protected_mode_jump(boot_params.hdr.code32_start,
			    (u32)&amp;boot_params + (ds() &lt;&lt; 4));
</code></pre>
<p>The <code>protected_mode_jump</code> is defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/boot/pmjump.S">arch/x86/boot/pmjump.S</a> and gets these two parameters in the <code>ax</code> and <code>dx</code> registers using one of the <a href="http://en.wikipedia.org/wiki/Intel_8086">8086</a> calling <a href="http://en.wikipedia.org/wiki/X86_calling_conventions#List_of_x86_calling_conventions">conventions</a>:</p>
<pre><code class="language-assembly">GLOBAL(protected_mode_jump)
	...
	...
	...
	.byte	0x66, 0xea		# ljmpl opcode
2:	.long	in_pm32			# offset
	.word	__BOOT_CS		# segment
...
...
...
ENDPROC(protected_mode_jump)
</code></pre>
<p>where <code>in_pm32</code> contains a jump to the 32-bit entry point:</p>
<pre><code class="language-assembly">GLOBAL(in_pm32)
	...
	...
	jmpl	*%eax // %eax contains address of the `startup_32`
	...
	...
ENDPROC(in_pm32)
</code></pre>
<p>As you can remember the 32-bit entry point is in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/boot/compressed/head_64.S">arch/x86/boot/compressed/head_64.S</a> assembly file, although it contains <code>_64</code> in its name. We can see the two similar files in the <code>arch/x86/boot/compressed</code> directory:</p>
<ul>
<li><code>arch/x86/boot/compressed/head_32.S</code>.</li>
<li><code>arch/x86/boot/compressed/head_64.S</code>;</li>
</ul>
<p>But the 32-bit mode entry point is the second file in our case. The first file is not even compiled for <code>x86_64</code>. Let's look at the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/boot/compressed/Makefile">arch/x86/boot/compressed/Makefile</a>:</p>
<pre><code>vmlinux-objs-y := $(obj)/vmlinux.lds $(obj)/head_$(BITS).o $(obj)/misc.o \
...
...
</code></pre>
<p>We can see here that <code>head_*</code> depends on the <code>$(BITS)</code> variable which depends on the architecture. You can find it in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/Makefile">arch/x86/Makefile</a>:</p>
<pre><code>ifeq ($(CONFIG_X86_32),y)
...
	BITS := 32
else
	BITS := 64
	...
endif
</code></pre>
<p>Now as we jumped on the <code>startup_32</code> from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/boot/compressed/head_64.S">arch/x86/boot/compressed/head_64.S</a> we will not find anything related to the interrupt handling here. The <code>startup_32</code> contains code that makes preparations before the transition into <a href="http://en.wikipedia.org/wiki/Long_mode">long mode</a> and directly jumps in to it. The <code>long mode</code> entry is located in <code>startup_64</code> and it makes preparations before the <a href="http://0xax.gitbooks.io/linux-insides/content/Booting/linux-bootstrap-5.html">kernel decompression</a> that occurs in the <code>decompress_kernel</code> from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/boot/compressed/misc.c">arch/x86/boot/compressed/misc.c</a>. After the kernel is decompressed, we jump on the <code>startup_64</code> from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/kernel/head_64.S">arch/x86/kernel/head_64.S</a>. In the <code>startup_64</code> we start to build identity-mapped pages. After we have built identity-mapped pages, checked the <a href="http://en.wikipedia.org/wiki/NX_bit">NX</a> bit, setup the <code>Extended Feature Enable Register</code> (see in links), and updated the early <code>Global Descriptor Table</code> with the <code>lgdt</code> instruction, we need to setup <code>gs</code> register with the following code:</p>
<pre><code class="language-assembly">movl	$MSR_GS_BASE,%ecx
movl	initial_gs(%rip),%eax
movl	initial_gs+4(%rip),%edx
wrmsr
</code></pre>
<p>We already saw this code in the previous <a href="http://0xax.gitbooks.io/linux-insides/content/interrupts/interrupts-1.html">part</a>. First of all pay attention on the last <code>wrmsr</code> instruction. This instruction writes data from the <code>edx:eax</code> registers to the <a href="http://en.wikipedia.org/wiki/Model-specific_register">model specific register</a> specified by the <code>ecx</code> register. We can see that <code>ecx</code> contains <code>$MSR_GS_BASE</code> which is declared in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/include/uapi/asm/msr-index.h">arch/x86/include/uapi/asm/msr-index.h</a> and looks like:</p>
<pre><code class="language-C">#define MSR_GS_BASE             0xc0000101
</code></pre>
<p>From this we can understand that <code>MSR_GS_BASE</code> defines the number of the <code>model specific register</code>. Since registers <code>cs</code>, <code>ds</code>, <code>es</code>, and <code>ss</code> are not used in the 64-bit mode, their fields are ignored. But we can access memory over <code>fs</code> and <code>gs</code> registers. The model specific register provides a <code>back door</code> to the hidden parts of these segment registers and allows to use 64-bit base address for segment register addressed by the <code>fs</code> and <code>gs</code>. So the <code>MSR_GS_BASE</code> is the hidden part and this part is mapped on the <code>GS.base</code> field. Let's look on the <code>initial_gs</code>:</p>
<pre><code class="language-assembly">GLOBAL(initial_gs)
	.quad	INIT_PER_CPU_VAR(irq_stack_union)
</code></pre>
<p>We pass <code>irq_stack_union</code> symbol to the <code>INIT_PER_CPU_VAR</code> macro which just concatenates the <code>init_per_cpu__</code> prefix with the given symbol. In our case we will get the <code>init_per_cpu__irq_stack_union</code> symbol. Let's look at the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/kernel/vmlinux.lds.S">linker</a> script. There we can see following definition:</p>
<pre><code>#define INIT_PER_CPU(x) init_per_cpu__##x = x + __per_cpu_load
INIT_PER_CPU(irq_stack_union);
</code></pre>
<p>It tells us that the address of the <code>init_per_cpu__irq_stack_union</code> will be <code>irq_stack_union + __per_cpu_load</code>. Now we need to understand where <code>init_per_cpu__irq_stack_union</code> and <code>__per_cpu_load</code> are what they mean. The first <code>irq_stack_union</code> is defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/include/asm/processor.h">arch/x86/include/asm/processor.h</a> with the <code>DECLARE_INIT_PER_CPU</code> macro which expands to call the <code>init_per_cpu_var</code> macro:</p>
<pre><code class="language-C">DECLARE_INIT_PER_CPU(irq_stack_union);

#define DECLARE_INIT_PER_CPU(var) \
       extern typeof(per_cpu_var(var)) init_per_cpu_var(var)

#define init_per_cpu_var(var)  init_per_cpu__##var
</code></pre>
<p>If we expand all macros we will get the same <code>init_per_cpu__irq_stack_union</code> as we got after expanding the <code>INIT_PER_CPU</code> macro, but you can note that it is not just a symbol, but a variable. Let's look at the <code>typeof(per_cpu_var(var))</code> expression. Our <code>var</code> is <code>irq_stack_union</code> and the <code>per_cpu_var</code> macro is defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/include/asm/percpu.h">arch/x86/include/asm/percpu.h</a>:</p>
<pre><code class="language-C">#define PER_CPU_VAR(var)        %__percpu_seg:var
</code></pre>
<p>where:</p>
<pre><code class="language-C">#ifdef CONFIG_X86_64
    #define __percpu_seg gs
endif
</code></pre>
<p>So, we are accessing <code>gs:irq_stack_union</code> and getting its type which is <code>irq_union</code>. Ok, we defined the first variable and know its address, now let's look at the second <code>__per_cpu_load</code> symbol. There are a couple of <code>per-cpu</code> variables which are located after this symbol. The <code>__per_cpu_load</code> is defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/include/asm-generic-sections.h">include/asm-generic/sections.h</a>:</p>
<pre><code class="language-C">extern char __per_cpu_load[], __per_cpu_start[], __per_cpu_end[];
</code></pre>
<p>and presented base address of the <code>per-cpu</code> variables from the data area. So, we know the address of the <code>irq_stack_union</code>, <code>__per_cpu_load</code> and we know that <code>init_per_cpu__irq_stack_union</code> must be placed right after <code>__per_cpu_load</code>. And we can see it in the <a href="http://en.wikipedia.org/wiki/System.map">System.map</a>:</p>
<pre><code>...
...
...
ffffffff819ed000 D __init_begin
ffffffff819ed000 D __per_cpu_load
ffffffff819ed000 A init_per_cpu__irq_stack_union
...
...
...
</code></pre>
<p>Now we know about <code>initial_gs</code>, so let's look at the code:</p>
<pre><code class="language-assembly">movl	$MSR_GS_BASE,%ecx
movl	initial_gs(%rip),%eax
movl	initial_gs+4(%rip),%edx
wrmsr
</code></pre>
<p>Here we specified a model specific register with <code>MSR_GS_BASE</code>, put the 64-bit address of the <code>initial_gs</code> to the <code>edx:eax</code> pair and execute the <code>wrmsr</code> instruction for filling the <code>gs</code> register with the base address of the <code>init_per_cpu__irq_stack_union</code> which will be at the bottom of the interrupt stack. After this we will jump to the C code on the <code>x86_64_start_kernel</code> from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/kernel/head64.c">arch/x86/kernel/head64.c</a>. In the <code>x86_64_start_kernel</code> function we do the last preparations before we jump into the generic and architecture-independent kernel code and one of these preparations is filling the early <code>Interrupt Descriptor Table</code> with the interrupts handlers entries or <code>early_idt_handlers</code>. You can remember it, if you have read the part about the <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-2.html">Early interrupt and exception handling</a> and can remember following code:</p>
<pre><code class="language-C">for (i = 0; i &lt; NUM_EXCEPTION_VECTORS; i++)
	set_intr_gate(i, early_idt_handlers[i]);

load_idt((const struct desc_ptr *)&amp;idt_descr);
</code></pre>
<p>but I wrote <code>Early interrupt and exception handling</code> part when Linux kernel version was - <code>3.18</code>. For this day actual version of the Linux kernel is <code>4.1.0-rc6+</code> and <code>Andy Lutomirski</code> sent the <a href="https://lkml.org/lkml/2015/6/2/106">patch</a> and soon it will be in the mainline kernel that changes behaviour for the <code>early_idt_handlers</code>. <strong>NOTE</strong> While I wrote this part the <a href="https://github.com/torvalds/linux/commit/425be5679fd292a3c36cb1fe423086708a99f11a">patch</a> already turned in the Linux kernel source code. Let's look on it. Now the same part looks like:</p>
<pre><code class="language-C">for (i = 0; i &lt; NUM_EXCEPTION_VECTORS; i++)
	set_intr_gate(i, early_idt_handler_array[i]);

load_idt((const struct desc_ptr *)&amp;idt_descr);
</code></pre>
<p>AS you can see it has only one difference in the name of the array of the interrupts handlers entry points. Now it is <code>early_idt_handler_arry</code>:</p>
<pre><code class="language-C">extern const char early_idt_handler_array[NUM_EXCEPTION_VECTORS][EARLY_IDT_HANDLER_SIZE];
</code></pre>
<p>where <code>NUM_EXCEPTION_VECTORS</code> and <code>EARLY_IDT_HANDLER_SIZE</code> are defined as:</p>
<pre><code class="language-C">#define NUM_EXCEPTION_VECTORS 32
#define EARLY_IDT_HANDLER_SIZE 9
</code></pre>
<p>So, the <code>early_idt_handler_array</code> is an array of the interrupts handlers entry points and contains one entry point on every nine bytes. You can remember that previous <code>early_idt_handlers</code> was defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/kernel/head_64.S">arch/x86/kernel/head_64.S</a>. The <code>early_idt_handler_array</code> is defined in the same source code file too:</p>
<pre><code class="language-assembly">ENTRY(early_idt_handler_array)
...
...
...
ENDPROC(early_idt_handler_common)
</code></pre>
<p>It fills <code>early_idt_handler_arry</code> with the <code>.rept NUM_EXCEPTION_VECTORS</code> and contains entry of the <code>early_make_pgtable</code> interrupt handler (more about its implementation you can read in the part about <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-2.html">Early interrupt and exception handling</a>). For now we come to the end of the <code>x86_64</code> architecture-specific code and the next part is the generic kernel code. Of course you already can know that we will return to the architecture-specific code in the <code>setup_arch</code> function and other places, but this is the end of the <code>x86_64</code> early code.</p>
<h2 id="setting-stack-canary-for-the-interrupt-stack">Setting stack canary for the interrupt stack</h2>
<p>The next stop after the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/kernel/head_64.S">arch/x86/kernel/head_64.S</a> is the biggest <code>start_kernel</code> function from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/init/main.c">init/main.c</a>. If you've read the previous <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/index.html">chapter</a> about the Linux kernel initialization process, you must remember it. This function does all initialization stuff before kernel will launch first <code>init</code> process with the <a href="https://en.wikipedia.org/wiki/Process_identifier">pid</a> - <code>1</code>. The first thing that is related to the interrupts and exceptions handling is the call of the <code>boot_init_stack_canary</code> function.</p>
<p>This function sets the <a href="http://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">canary</a> value to protect interrupt stack overflow. We already saw a little some details about implementation of the <code>boot_init_stack_canary</code> in the previous part and now let's take a closer look on it. You can find implementation of this function in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/include/asm/stackprotector.h">arch/x86/include/asm/stackprotector.h</a> and its depends on the <code>CONFIG_CC_STACKPROTECTOR</code> kernel configuration option. If this option is not set this function will not do anything:</p>
<pre><code class="language-C">#ifdef CONFIG_CC_STACKPROTECTOR
...
...
...
#else
static inline void boot_init_stack_canary(void)
{
}
#endif
</code></pre>
<p>If the <code>CONFIG_CC_STACKPROTECTOR</code> kernel configuration option is set, the <code>boot_init_stack_canary</code> function starts from the check stat <code>irq_stack_union</code> that represents <a href="http://0xax.gitbooks.io/linux-insides/content/Concepts/per-cpu.html">per-cpu</a> interrupt stack has offset equal to forty bytes from the <code>stack_canary</code> value:</p>
<pre><code class="language-C">#ifdef CONFIG_X86_64
        BUILD_BUG_ON(offsetof(union irq_stack_union, stack_canary) != 40);
#endif
</code></pre>
<p>As we can read in the previous <a href="http://0xax.gitbooks.io/linux-insides/content/interrupts/interrupts-1.html">part</a> the <code>irq_stack_union</code> represented by the following union:</p>
<pre><code class="language-C">union irq_stack_union {
	char irq_stack[IRQ_STACK_SIZE];

    struct {
		char gs_base[40];
		unsigned long stack_canary;
	};
};
</code></pre>
<p>which defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/include/asm/processor.h">arch/x86/include/asm/processor.h</a>. We know that <a href="http://en.wikipedia.org/wiki/Union_type">union</a> in the <a href="http://en.wikipedia.org/wiki/C_%28programming_language%29">C</a> programming language is a data structure which stores only one field in a memory. We can see here that structure has first field - <code>gs_base</code> which is 40 bytes size and represents bottom of the <code>irq_stack</code>. So, after this our check with the <code>BUILD_BUG_ON</code> macro should end successfully. (you can read the first part about Linux kernel initialization <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-1.html">process</a> if you're interesting about the <code>BUILD_BUG_ON</code> macro).</p>
<p>After this we calculate new <code>canary</code> value based on the random number and <a href="http://en.wikipedia.org/wiki/Time_Stamp_Counter">Time Stamp Counter</a>:</p>
<pre><code class="language-C">get_random_bytes(&amp;canary, sizeof(canary));
tsc = __native_read_tsc();
canary += tsc + (tsc &lt;&lt; 32UL);
</code></pre>
<p>and write <code>canary</code> value to the <code>irq_stack_union</code> with the <code>this_cpu_write</code> macro:</p>
<pre><code class="language-C">this_cpu_write(irq_stack_union.stack_canary, canary);
</code></pre>
<p>more about <code>this_cpu_*</code> operation you can read in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/Documentation/this_cpu_ops.txt">Linux kernel documentation</a>.</p>
<h2 id="disablingenabling-local-interrupts">Disabling/Enabling local interrupts</h2>
<p>The next step in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/init/main.c">init/main.c</a> which is related to the interrupts and interrupts handling after we have set the <code>canary</code> value to the interrupt stack - is the call of the <code>local_irq_disable</code> macro.</p>
<p>This macro defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/include/linux/irqflags.h">include/linux/irqflags.h</a> header file and as you can understand, we can disable interrupts for the CPU with the call of this macro. Let's look on its implementation. First of all note that it depends on the <code>CONFIG_TRACE_IRQFLAGS_SUPPORT</code> kernel configuration option:</p>
<pre><code class="language-C">#ifdef CONFIG_TRACE_IRQFLAGS_SUPPORT
...
#define local_irq_disable() \
         do { raw_local_irq_disable(); trace_hardirqs_off(); } while (0)
...
#else
...
#define local_irq_disable()     do { raw_local_irq_disable(); } while (0)
...
#endif
</code></pre>
<p>They are both similar and as you can see have only one difference: the <code>local_irq_disable</code> macro contains call of the <code>trace_hardirqs_off</code> when <code>CONFIG_TRACE_IRQFLAGS_SUPPORT</code> is enabled. There is special feature in the <a href="http://lwn.net/Articles/321663/">lockdep</a> subsystem - <code>irq-flags tracing</code> for tracing <code>hardirq</code> and <code>softirq</code> state. In our case <code>lockdep</code> subsystem can give us interesting information about hard/soft irqs on/off events which are occurs in the system. The <code>trace_hardirqs_off</code> function defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/kernel/locking/lockdep.c">kernel/locking/lockdep.c</a>:</p>
<pre><code class="language-C">void trace_hardirqs_off(void)
{
         trace_hardirqs_off_caller(CALLER_ADDR0);
}
EXPORT_SYMBOL(trace_hardirqs_off);
</code></pre>
<p>and just calls <code>trace_hardirqs_off_caller</code> function. The <code>trace_hardirqs_off_caller</code> checks the <code>hardirqs_enabled</code> field of the current process and increases the <code>redundant_hardirqs_off</code> if call of the <code>local_irq_disable</code> was redundant or the <code>hardirqs_off_events</code> if it was not. These two fields and other <code>lockdep</code> statistic related fields are defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/kernel/locking/lockdep_insides.h">kernel/locking/lockdep_insides.h</a> and located in the <code>lockdep_stats</code> structure:</p>
<pre><code class="language-C">struct lockdep_stats {
...
...
...
int     softirqs_off_events;
int     redundant_softirqs_off;
...
...
...
}
</code></pre>
<p>If you will set <code>CONFIG_DEBUG_LOCKDEP</code> kernel configuration option, the <code>lockdep_stats_debug_show</code> function will write all tracing information to the <code>/proc/lockdep</code>:</p>
<pre><code class="language-C">static void lockdep_stats_debug_show(struct seq_file *m)
{
#ifdef CONFIG_DEBUG_LOCKDEP
	unsigned long long hi1 = debug_atomic_read(hardirqs_on_events),
	                         hi2 = debug_atomic_read(hardirqs_off_events),
							 hr1 = debug_atomic_read(redundant_hardirqs_on),
    ...
	...
	...
    seq_printf(m, " hardirq on events:             %11llu\n", hi1);
    seq_printf(m, " hardirq off events:            %11llu\n", hi2);
    seq_printf(m, " redundant hardirq ons:         %11llu\n", hr1);
#endif
}
</code></pre>
<p>and you can see its result with the:</p>
<pre><code>$ sudo cat /proc/lockdep
 hardirq on events:             12838248974
 hardirq off events:            12838248979
 redundant hardirq ons:               67792
 redundant hardirq offs:         3836339146
 softirq on events:                38002159
 softirq off events:               38002187
 redundant softirq ons:                   0
 redundant softirq offs:                  0
</code></pre>
<p>Ok, now we know a little about tracing, but more info will be in the separate part about <code>lockdep</code> and <code>tracing</code>. You can see that the both <code>local_disable_irq</code> macros have the same part - <code>raw_local_irq_disable</code>. This macro defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/include/asm/irqflags.h">arch/x86/include/asm/irqflags.h</a> and expands to the call of the:</p>
<pre><code class="language-C">static inline void native_irq_disable(void)
{
        asm volatile("cli": : :"memory");
}
</code></pre>
<p>And you already must remember that <code>cli</code> instruction clears the <a href="http://en.wikipedia.org/wiki/Interrupt_flag">IF</a> flag which determines ability of a processor to handle an interrupt or an exception. Besides the <code>local_irq_disable</code>, as you already can know there is an inverse macro - <code>local_irq_enable</code>. This macro has the same tracing mechanism and very similar on the <code>local_irq_enable</code>, but as you can understand from its name, it enables interrupts with the <code>sti</code> instruction:</p>
<pre><code class="language-C">static inline void native_irq_enable(void)
{
        asm volatile("sti": : :"memory");
}
</code></pre>
<p>Now we know how <code>local_irq_disable</code> and <code>local_irq_enable</code> work. It was the first call of the <code>local_irq_disable</code> macro, but we will meet these macros many times in the Linux kernel source code. But for now we are in the <code>start_kernel</code> function from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/init/main.c">init/main.c</a> and we just disabled <code>local</code> interrupts. Why local and why we did it? Previously kernel provided a method to disable interrupts on all processors and it was called <code>cli</code>. This function was <a href="https://lwn.net/Articles/291956/">removed</a> and now we have <code>local_irq_{enabled,disable}</code> to disable or enable interrupts on the current processor. After we've disabled the interrupts with the <code>local_irq_disable</code> macro, we set the:</p>
<pre><code class="language-C">early_boot_irqs_disabled = true;
</code></pre>
<p>The <code>early_boot_irqs_disabled</code> variable defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/include/linux/kernel.h">include/linux/kernel.h</a>:</p>
<pre><code class="language-C">extern bool early_boot_irqs_disabled;
</code></pre>
<p>and used in the different places. For example it used in the <code>smp_call_function_many</code> function from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/kernel/smp.c">kernel/smp.c</a> for the checking possible deadlock when interrupts are disabled:</p>
<pre><code class="language-C">WARN_ON_ONCE(cpu_online(this_cpu) &amp;&amp; irqs_disabled()
                     &amp;&amp; !oops_in_progress &amp;&amp; !early_boot_irqs_disabled);
</code></pre>
<h2 id="early-trap-initialization-during-kernel-initialization">Early trap initialization during kernel initialization</h2>
<p>The next functions after the <code>local_disable_irq</code> are <code>boot_cpu_init</code> and <code>page_address_init</code>, but they are not related to the interrupts and exceptions (more about this functions you can read in the chapter about Linux kernel <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/index.html">initialization process</a>). The next is the <code>setup_arch</code> function. As you can remember this function located in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/kernel.setup.c">arch/x86/kernel/setup.c</a> source code file and makes initialization of many different architecture-dependent <a href="http://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-4.html">stuff</a>. The first interrupts related function which we can see in the <code>setup_arch</code> is the - <code>early_trap_init</code> function. This function defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/kernel/traps.c">arch/x86/kernel/traps.c</a> and fills <code>Interrupt Descriptor Table</code> with the couple of entries:</p>
<pre><code class="language-C">void __init early_trap_init(void)
{
        set_intr_gate_ist(X86_TRAP_DB, &amp;debug, DEBUG_STACK);
        set_system_intr_gate_ist(X86_TRAP_BP, &amp;int3, DEBUG_STACK);
#ifdef CONFIG_X86_32
        set_intr_gate(X86_TRAP_PF, page_fault);
#endif
        load_idt(&amp;idt_descr);
}
</code></pre>
<p>Here we can see calls of three different functions:</p>
<ul>
<li><code>set_intr_gate_ist</code></li>
<li><code>set_system_intr_gate_ist</code></li>
<li><code>set_intr_gate</code></li>
</ul>
<p>All of these functions defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/include/asm/desc.h">arch/x86/include/asm/desc.h</a> and do the similar thing but not the same. The first <code>set_intr_gate_ist</code> function inserts new an interrupt gate in the <code>IDT</code>. Let's look on its implementation:</p>
<pre><code class="language-C">static inline void set_intr_gate_ist(int n, void *addr, unsigned ist)
{
        BUG_ON((unsigned)n &gt; 0xFF);
        _set_gate(n, GATE_INTERRUPT, addr, 0, ist, __KERNEL_CS);
}
</code></pre>
<p>First of all we can see the check that <code>n</code> which is <a href="http://en.wikipedia.org/wiki/Interrupt_vector_table">vector number</a> of the interrupt is not greater than <code>0xff</code> or 255. We need to check it because we remember from the previous <a href="http://0xax.gitbooks.io/linux-insides/content/interrupts/interrupts-1.html">part</a> that vector number of an interrupt must be between <code>0</code> and <code>255</code>. In the next step we can see the call of the <code>_set_gate</code> function that sets a given interrupt gate to the <code>IDT</code> table:</p>
<pre><code class="language-C">static inline void _set_gate(int gate, unsigned type, void *addr,
                             unsigned dpl, unsigned ist, unsigned seg)
{
        gate_desc s;

        pack_gate(&amp;s, type, (unsigned long)addr, dpl, ist, seg);
        write_idt_entry(idt_table, gate, &amp;s);
        write_trace_idt_entry(gate, &amp;s);
}
</code></pre>
<p>Here we start from the <code>pack_gate</code> function which takes clean <code>IDT</code> entry represented by the <code>gate_desc</code> structure and fills it with the base address and limit, <a href="https://www.kernel.org/doc/Documentation/x86/x86_64/kernel-stacks">Interrupt Stack Table</a>, <a href="http://en.wikipedia.org/wiki/Privilege_level">Privilege level</a>, type of an interrupt which can be one of the following values:</p>
<ul>
<li><code>GATE_INTERRUPT</code></li>
<li><code>GATE_TRAP</code></li>
<li><code>GATE_CALL</code></li>
<li><code>GATE_TASK</code></li>
</ul>
<p>and set the present bit for the given <code>IDT</code> entry:</p>
<pre><code class="language-C">static inline void pack_gate(gate_desc *gate, unsigned type, unsigned long func,
                             unsigned dpl, unsigned ist, unsigned seg)
{
        gate-&gt;offset_low        = PTR_LOW(func);
        gate-&gt;segment           = __KERNEL_CS;
        gate-&gt;ist               = ist;
        gate-&gt;p                 = 1;
        gate-&gt;dpl               = dpl;
        gate-&gt;zero0             = 0;
        gate-&gt;zero1             = 0;
        gate-&gt;type              = type;
        gate-&gt;offset_middle     = PTR_MIDDLE(func);
        gate-&gt;offset_high       = PTR_HIGH(func);
}
</code></pre>
<p>After this we write just filled interrupt gate to the <code>IDT</code> with the <code>write_idt_entry</code> macro which expands to the <code>native_write_idt_entry</code> and just copy the interrupt gate to the <code>idt_table</code> table by the given index:</p>
<pre><code class="language-C">#define write_idt_entry(dt, entry, g)           native_write_idt_entry(dt, entry, g)

static inline void native_write_idt_entry(gate_desc *idt, int entry, const gate_desc *gate)
{
        memcpy(&amp;idt[entry], gate, sizeof(*gate));
}
</code></pre>
<p>where <code>idt_table</code> is just array of <code>gate_desc</code>:</p>
<pre><code class="language-C">extern gate_desc idt_table[];
</code></pre>
<p>That's all. The second <code>set_system_intr_gate_ist</code> function has only one difference from the <code>set_intr_gate_ist</code>:</p>
<pre><code class="language-C">static inline void set_system_intr_gate_ist(int n, void *addr, unsigned ist)
{
        BUG_ON((unsigned)n &gt; 0xFF);
        _set_gate(n, GATE_INTERRUPT, addr, 0x3, ist, __KERNEL_CS);
}
</code></pre>
<p>Do you see it? Look on the fourth parameter of the <code>_set_gate</code>. It is <code>0x3</code>. In the <code>set_intr_gate</code> it was <code>0x0</code>. We know that this parameter represent <code>DPL</code> or privilege level. We also know that <code>0</code> is the highest privilege level and <code>3</code> is the lowest.Now we know how <code>set_system_intr_gate_ist</code>, <code>set_intr_gate_ist</code>, <code>set_intr_gate</code> are work and we can return to the <code>early_trap_init</code> function. Let's look on it again:</p>
<pre><code class="language-C">set_intr_gate_ist(X86_TRAP_DB, &amp;debug, DEBUG_STACK);
set_system_intr_gate_ist(X86_TRAP_BP, &amp;int3, DEBUG_STACK);
</code></pre>
<p>We set two <code>IDT</code> entries for the <code>#DB</code> interrupt and <code>int3</code>. These functions takes the same set of parameters:</p>
<ul>
<li>vector number of an interrupt;</li>
<li>address of an interrupt handler;</li>
<li>interrupt stack table index.</li>
</ul>
<p>That's all. More about interrupts and handlers you will know in the next parts.</p>
<h2 id="conclusion">Conclusion</h2>
<p>It is the end of the second part about interrupts and interrupt handling in the Linux kernel. We saw the some theory in the previous part and started to dive into interrupts and exceptions handling in the current part. We have started from the earliest parts in the Linux kernel source code which are related to the interrupts. In the next part we will continue to dive into this interesting theme and will know more about interrupt handling process.</p>
<p>If you have any questions or suggestions write me a comment or ping me at <a href="https://twitter.com/0xAX">twitter</a>.</p>
<p><strong>Please note that English is not my first language, And I am really sorry for any inconvenience. If you find any mistakes please send me PR to <a href="https://github.com/0xAX/linux-insides">linux-insides</a>.</strong></p>
<h2 id="links">Links</h2>
<ul>
<li><a href="http://en.wikipedia.org/wiki/Interrupt_descriptor_table">IDT</a></li>
<li><a href="http://en.wikipedia.org/wiki/Protected_mode">Protected mode</a></li>
<li><a href="http://en.wikipedia.org/wiki/X86_calling_conventions#List_of_x86_calling_conventions">List of x86 calling conventions</a></li>
<li><a href="http://en.wikipedia.org/wiki/Intel_8086">8086</a></li>
<li><a href="http://en.wikipedia.org/wiki/Long_mode">Long mode</a></li>
<li><a href="http://en.wikipedia.org/wiki/NX_bit">NX</a></li>
<li><a href="http://en.wikipedia.org/wiki/Control_register#Additional_Control_registers_in_x86-64_series">Extended Feature Enable Register</a></li>
<li><a href="http://en.wikipedia.org/wiki/Model-specific_register">Model-specific register</a></li>
<li><a href="https://en.wikipedia.org/wiki/Process_identifier">Process identifier</a></li>
<li><a href="http://lwn.net/Articles/321663/">lockdep</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/irqflags-tracing.txt">irqflags tracing</a></li>
<li><a href="http://en.wikipedia.org/wiki/Interrupt_flag">IF</a></li>
<li><a href="http://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">Stack canary</a></li>
<li><a href="http://en.wikipedia.org/wiki/Union_type">Union type</a></li>
<li><a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/Documentation/this_cpu_ops.txt">this_cpu_* operations</a></li>
<li><a href="http://en.wikipedia.org/wiki/Interrupt_vector_table">vector number</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/x86/x86_64/kernel-stacks">Interrupt Stack Table</a></li>
<li><a href="http://en.wikipedia.org/wiki/Privilege_level">Privilege level</a></li>
<li><a href="http://0xax.gitbooks.io/linux-insides/content/interrupts/interrupts-1.html">Previous part</a></li>
</ul>
</div>
<hr class="uk-article-divider">
<div class="uk-block uk-block-muted uk-padding-top-remove uk-padding-bottom-remove uk-margin-large-top  book-recommend-wrap">
<div class="uk-margin-top uk-margin-bottom uk-margin-left uk-margin-right">
<div class="uk-margin uk-text-muted "><i class="uk-icon-outdent uk-icon-justify uk-margin-small-right"></i>书籍推荐</div>
<div class="books">
<ul class="uk-book-list">
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/181/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/181/index.html">命令行的艺术</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/101.html">jlevy</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">34页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年5月26日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 46710个">46710</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/28/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/28/index.html">笨办法学 Linux</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/15.html">wizardforcel</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">34页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年5月3日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 326个">326</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/45/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/45/index.html">嵌入式 Linux 知识库</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/23.html">泰晓科技</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">402页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年5月30日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 97个">97</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/47/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/phpstorm_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/47/index.html">CodeIgniter3.1.8源码分析</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/24.html">NightSakura</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="phpstorm">phpstorm</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">22页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年6月2日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 2个">2</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/149/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/git_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/149/index.html">Git Cheat Sheet 中文版</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/81.html">flyhigher139</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="git">git</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">1页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年3月3日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 642个">642</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/65/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/java_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/65/index.html">更先进的Java - Java 8指南</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/41.html">winterbe</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="java">java</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">1页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年6月6日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 9341个">9341</span>
</div>
</div>
</div>
</li>
<hr>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<nav class="tm-navbar uk-navbar uk-navbar-attached reader-nav">
<div class="uk-float-left uk-margin-small-top">
<a href="javascript:;" title="目录菜单" class="show-menu  uk-icon-hover  uk-icon-align-justify uk-margin-right"></a>
<div data-uk-dropdown="{mode:'click',pos:'bottom-left'}" class="font-setting-wrap">
<a class="uk-icon-hover uk-icon-font uk-margin-right" aria-label="字体设置" href="javascript:;"></a>
<div class="uk-dropdown dropdown-menu">
<div class="dropdown-caret"><span class="caret-outer"></span><span class="caret-inner"></span></div>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-reduce">小字</button>
<button class="uk-button-link button size-2 font-enlarge">大字</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-1 ">宋体</button>
<button class="uk-button-link button size-2 font-2 ">黑体</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-3 color-theme-sun "><i class="uk-icon-sun-o"></i>白天</button>
<button class="uk-button-link button size-3 color-theme-eye "><i class="uk-icon-eye"></i>护眼</button>
<button class="uk-button-link button size-3 color-theme-moon "><i class="uk-icon-moon-o"></i>夜晚</button></div>
</div>
</div>
<a class="logo uk-margin-right" href="../../../" title="返回首页"><img class="" src="../../../static/components/images/icon_32.png" /></a>
</div>
<div class="uk-navbar-flip  uk-hidden-small">
<div id="share-box"></div>
</div>
</nav>
<div id="menu-id" class="uk-offcanvas reader-offcanvas">
<div class="uk-offcanvas-bar">
<ul class="book-menu-bar uk-nav uk-nav-offcanvas" data-uk-nav>
<li>
<a href="../../../book/104/index.html" data-book-page-rel-url="index.html" data-book-page-id="0" title="封面">封面</a>
</li>
<li>
<a class="pjax" href="../../../book/104/readme.html" data-book-page-rel-url="readme.html" data-book-page-id="0" title="简介">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/README.html" title="简介" data-book-page-rel-url="README.html" data-book-page-id="7458">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/README.html" title="引导" data-book-page-rel-url="Booting/README.html" data-book-page-id="7459">引导</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-1.html" title="从引导加载程序内核" data-book-page-rel-url="Booting/linux-bootstrap-1.html" data-book-page-id="7460">从引导加载程序内核</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-2.html" title="在内核安装代码的第一步" data-book-page-rel-url="Booting/linux-bootstrap-2.html" data-book-page-id="7461">在内核安装代码的第一步</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-3.html" title="视频模式初始化和转换到保护模式" data-book-page-rel-url="Booting/linux-bootstrap-3.html" data-book-page-id="7462">视频模式初始化和转换到保护模式</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-4.html" title="过渡到 64 位模式" data-book-page-rel-url="Booting/linux-bootstrap-4.html" data-book-page-id="7463">过渡到 64 位模式</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-5.html" title="内核解压缩" data-book-page-rel-url="Booting/linux-bootstrap-5.html" data-book-page-id="7464">内核解压缩</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/README.html" title="初始化" data-book-page-rel-url="Initialization/README.html" data-book-page-id="7465">初始化</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-1.html" title="内核解压之后的首要步骤" data-book-page-rel-url="Initialization/linux-initialization-1.html" data-book-page-id="7466">内核解压之后的首要步骤</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-2.html" title="早期的中断和异常控制" data-book-page-rel-url="Initialization/linux-initialization-2.html" data-book-page-id="7467">早期的中断和异常控制</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-3.html" title="在到达内核入口之前最后的准备" data-book-page-rel-url="Initialization/linux-initialization-3.html" data-book-page-id="7468">在到达内核入口之前最后的准备</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-4.html" title="内核入口 - start_kernel" data-book-page-rel-url="Initialization/linux-initialization-4.html" data-book-page-id="7469">内核入口 - start_kernel</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-5.html" title="体系架构初始化" data-book-page-rel-url="Initialization/linux-initialization-5.html" data-book-page-id="7470">体系架构初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-6.html" title="进一步初始化指定体系架构" data-book-page-rel-url="Initialization/linux-initialization-6.html" data-book-page-id="7471">进一步初始化指定体系架构</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-7.html" title="最后对指定体系架构初始化" data-book-page-rel-url="Initialization/linux-initialization-7.html" data-book-page-id="7472">最后对指定体系架构初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-8.html" title="调度器初始化" data-book-page-rel-url="Initialization/linux-initialization-8.html" data-book-page-id="7473">调度器初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-9.html" title="RCU 初始化" data-book-page-rel-url="Initialization/linux-initialization-9.html" data-book-page-id="7474">RCU 初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-10.html" title="初始化结束" data-book-page-rel-url="Initialization/linux-initialization-10.html" data-book-page-id="7475">初始化结束</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/README.html" title="中断" data-book-page-rel-url="Interrupts/README.html" data-book-page-id="7476">中断</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-1.html" title="中断和中断处理 Part 1." data-book-page-rel-url="Interrupts/interrupts-1.html" data-book-page-id="7477">中断和中断处理 Part 1.</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-2.html" title="深入 Linux 内核中的中断" data-book-page-rel-url="Interrupts/interrupts-2.html" data-book-page-id="7478">深入 Linux 内核中的中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-3.html" title="初步中断处理" data-book-page-rel-url="Interrupts/interrupts-3.html" data-book-page-id="7479">初步中断处理</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-4.html" title="中断处理" data-book-page-rel-url="Interrupts/interrupts-4.html" data-book-page-id="7480">中断处理</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-5.html" title="异常处理的实现" data-book-page-rel-url="Interrupts/interrupts-5.html" data-book-page-id="7481">异常处理的实现</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-6.html" title="处理不可屏蔽中断" data-book-page-rel-url="Interrupts/interrupts-6.html" data-book-page-id="7482">处理不可屏蔽中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-7.html" title="深入外部硬件中断" data-book-page-rel-url="Interrupts/interrupts-7.html" data-book-page-id="7483">深入外部硬件中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-8.html" title="IRQs的非早期初始化" data-book-page-rel-url="Interrupts/interrupts-8.html" data-book-page-id="7484">IRQs的非早期初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-9.html" title="Softirq, Tasklets and Workqueues" data-book-page-rel-url="Interrupts/interrupts-9.html" data-book-page-id="7485">Softirq, Tasklets and Workqueues</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-10.html" title="最后一部分" data-book-page-rel-url="Interrupts/interrupts-10.html" data-book-page-id="7486">最后一部分</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/README.html" title="系统调用" data-book-page-rel-url="SysCall/README.html" data-book-page-id="7487">系统调用</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-1.html" title="系统调用概念简介" data-book-page-rel-url="SysCall/syscall-1.html" data-book-page-id="7488">系统调用概念简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-2.html" title="Linux 内核如何处理系统调用" data-book-page-rel-url="SysCall/syscall-2.html" data-book-page-id="7489">Linux 内核如何处理系统调用</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-3.html" title="vsyscall and vDSO" data-book-page-rel-url="SysCall/syscall-3.html" data-book-page-id="7490">vsyscall and vDSO</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-4.html" title="Linux 内核如何运行程序" data-book-page-rel-url="SysCall/syscall-4.html" data-book-page-id="7491">Linux 内核如何运行程序</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/README.html" title="定时器和时钟管理" data-book-page-rel-url="Timers/README.html" data-book-page-id="7492">定时器和时钟管理</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-1.html" title="简介" data-book-page-rel-url="Timers/timers-1.html" data-book-page-id="7493">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-2.html" title="时钟源框架简介" data-book-page-rel-url="Timers/timers-2.html" data-book-page-id="7494">时钟源框架简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-3.html" title="The tick broadcast framework and dyntick" data-book-page-rel-url="Timers/timers-3.html" data-book-page-id="7495">The tick broadcast framework and dyntick</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-4.html" title="定时器介绍" data-book-page-rel-url="Timers/timers-4.html" data-book-page-id="7496">定时器介绍</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-5.html" title="Clockevents 框架简介" data-book-page-rel-url="Timers/timers-5.html" data-book-page-id="7497">Clockevents 框架简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-6.html" title="x86 相关的时钟源" data-book-page-rel-url="Timers/timers-6.html" data-book-page-id="7498">x86 相关的时钟源</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-7.html" title="Linux 内核中与时钟相关的系统调用" data-book-page-rel-url="Timers/timers-7.html" data-book-page-id="7499">Linux 内核中与时钟相关的系统调用</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/README.html" title="同步原语" data-book-page-rel-url="SyncPrim/README.html" data-book-page-id="7500">同步原语</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-1.html" title="自旋锁简介" data-book-page-rel-url="SyncPrim/sync-1.html" data-book-page-id="7501">自旋锁简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-2.html" title="队列自旋锁" data-book-page-rel-url="SyncPrim/sync-2.html" data-book-page-id="7502">队列自旋锁</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-3.html" title="信号量" data-book-page-rel-url="SyncPrim/sync-3.html" data-book-page-id="7503">信号量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-4.html" title="互斥锁" data-book-page-rel-url="SyncPrim/sync-4.html" data-book-page-id="7504">互斥锁</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-5.html" title="读者/写者信号量" data-book-page-rel-url="SyncPrim/sync-5.html" data-book-page-id="7505">读者/写者信号量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-6.html" title="顺序锁" data-book-page-rel-url="SyncPrim/sync-6.html" data-book-page-id="7506">顺序锁</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/README.html" title="内存管理" data-book-page-rel-url="MM/README.html" data-book-page-id="7508">内存管理</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-1.html" title="内存块" data-book-page-rel-url="MM/linux-mm-1.html" data-book-page-id="7509">内存块</a>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-2.html" title="固定映射地址和 ioremap" data-book-page-rel-url="MM/linux-mm-2.html" data-book-page-id="7510">固定映射地址和 ioremap</a>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-3.html" title="kmemcheck" data-book-page-rel-url="MM/linux-mm-3.html" data-book-page-id="7511">kmemcheck</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/README.html" title="概念" data-book-page-rel-url="Concepts/README.html" data-book-page-id="7512">概念</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Concepts/per-cpu.html" title="每个 CPU 的变量" data-book-page-rel-url="Concepts/per-cpu.html" data-book-page-id="7513">每个 CPU 的变量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/cpumask.html" title="CPU 掩码" data-book-page-rel-url="Concepts/cpumask.html" data-book-page-id="7514">CPU 掩码</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/initcall.html" title="initcall 机制" data-book-page-rel-url="Concepts/initcall.html" data-book-page-id="7515">initcall 机制</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/notification_chains.html" title="Linux 内核的通知链" data-book-page-rel-url="Concepts/notification_chains.html" data-book-page-id="7516">Linux 内核的通知链</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/README.html" title="Linux 内核中的数据结构" data-book-page-rel-url="DataStructures/README.html" data-book-page-id="7517">Linux 内核中的数据结构</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/DataStructures/dlist.html" title="双向链表" data-book-page-rel-url="DataStructures/dlist.html" data-book-page-id="7518">双向链表</a>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/radix-tree.html" title="基数树" data-book-page-rel-url="DataStructures/radix-tree.html" data-book-page-id="7519">基数树</a>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/bitmap.html" title="位数组" data-book-page-rel-url="DataStructures/bitmap.html" data-book-page-id="7520">位数组</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Theory/README.html" title="理论" data-book-page-rel-url="Theory/README.html" data-book-page-id="7521">理论</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Theory/Paging.html" title="分页" data-book-page-rel-url="Theory/Paging.html" data-book-page-id="7522">分页</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Theory/ELF.html" title="Elf64 格式" data-book-page-rel-url="Theory/ELF.html" data-book-page-id="7523">Elf64 格式</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/README.html" title="杂项" data-book-page-rel-url="Misc/README.html" data-book-page-id="7524">杂项</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Misc/how_kernel_compiled.html" title="内核编译方法" data-book-page-rel-url="Misc/how_kernel_compiled.html" data-book-page-id="7525">内核编译方法</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/linkers.html" title="链接器" data-book-page-rel-url="Misc/linkers.html" data-book-page-id="7526">链接器</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/contribute.html" title="Linux 内核开发" data-book-page-rel-url="Misc/contribute.html" data-book-page-id="7527">Linux 内核开发</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/program_startup.html" title="用户空间的程序启动过程" data-book-page-rel-url="Misc/program_startup.html" data-book-page-id="7528">用户空间的程序启动过程</a>
</li>
<li>
<a class="pjax" href="../../../book/104/" title="Write and Submit your first Linux kernel Patch" data-book-page-rel-url="" data-book-page-id="7507">Write and Submit your first Linux kernel Patch</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/KernelStructures/README.html" title="内核数据结构" data-book-page-rel-url="KernelStructures/README.html" data-book-page-id="7529">内核数据结构</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/KernelStructures/idt.html" title="中断描述符表" data-book-page-rel-url="KernelStructures/idt.html" data-book-page-id="7530">中断描述符表</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/LINKS.html" title="有帮助的链接" data-book-page-rel-url="LINKS.html" data-book-page-id="7531">有帮助的链接</a>
</li>
<li>
<a class="pjax" href="../../../book/104/contributors.html" title="贡献者" data-book-page-rel-url="contributors.html" data-book-page-id="7532">贡献者</a>
</li>
</ul>
</div>
</div>
<script src="https://cdn.staticfile.net/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript" src="../../../static/components/uikit-2.27.5/js/uikit.reader.js"></script>
<script type="text/javascript" src="../../../static/components/social-share/social-share.min.js"></script>
<script>(function(){var bp =document.createElement('script');var curProtocol =window.location.protocol.split(':')[0];if (curProtocol ==='https') {bp.src ='https://zz.bdstatic.com/linksubmit/push.js';}
else {bp.src ='http://push.zhanzhang.baidu.com/push.js';}
var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
<script src="https://cdn.staticfile.net/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.staticfile.net/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>
<script src="https://cdn.staticfile.net/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://cdn.staticfile.net/uikit/2.27.5/js/components/lightbox.min.js"></script>
<link rel="dns-prefetch" href="../../..//cdn.mathjax.org" />
<script type="text/x-mathjax-config">
 function initMathJax() {
    var mathId = $("book-content-section")[0];
    MathJax.Hub.Config({
        tex2jax: {skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code','a']},
        showProcessingMessages: false,
        messageStyle: "none"
    });
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,mathId]);
 };
initMathJax();
</script>
<script src='https://cdn.staticfile.net/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
<style>
	.MathJax_Display{display:inline!important;}
</style>
<script type="text/javascript" src="../../../static/components/js/reader.js"></script>
<script type="text/javascript">var bookId =104;var bookPageId =7478;var bookPageRelUrl ='Interrupts/interrupts-2.html';</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
</body>
</html>