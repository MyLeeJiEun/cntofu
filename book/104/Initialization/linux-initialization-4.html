
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<title>内核入口 - start_kernel-Linux 内核揭密</title>
<meta content='内核入口 - start_kernel,Linux 内核揭密' name='keywords'>
<meta content='内核入口 - start_kernel,Linux 内核揭密' name='description'>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="zh-CN" />
<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=no"../../../>
<meta name="applicable-device" content="pc,mobile">
<link rel="shortcut icon" href="../../../favicon.ico" type="image/x-icon" />
<meta name="renderer" content="webkit">
<link rel="stylesheet" href="../../../static/components/uikit-2.27.5/css/uikit.custom.css">
<link rel="stylesheet" href="../../../static/components/social-share/social-share.min.css">
<link rel="stylesheet" href="../../../static/components/highlight/styles/custom.css">
<link rel="stylesheet" href="../../../static/components/css/base.css">
<link rel="stylesheet" href="../../../static/components/css/reader.css">
<link rel="stylesheet" href="../../../static/components/css/markdown.css">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5313208362165053" crossorigin="anonymous"></script>
</head>
<body>
<div class=" book-main-wrap uk-container uk-container-center uk-margin-top ">
<div class="uk-grid">
<div class="uk-width-1-1 reader-wrap ">
<div class=" bottom-nav uk-clearfix ">
<div class="uk-align-left ">
<a href="../../../book/104/Initialization/linux-initialization-3.html">
<i class="nav-icon-left uk-icon-small  uk-icon-caret-left"></i>
<span class="">在到达内核入口之前最后..</span>
</a>
</div>
<div class="uk-align-right ">
<a href="../../../book/104/Initialization/linux-initialization-5.html">
<span class="">体系架构初始化</span>
<i class="nav-icon-right uk-icon-small  uk-icon-caret-right"></i>
</a>
</div>
</div>
<div class="uk-text-center">
<h2 class="book-page-title uk-container-center">
<a href="../../../book/104/index.html">Linux 内核揭密</a>
<a target="_blank" rel="nofollow" href="https://github.com/ye11ow/linux-insides-zh" class="uk-icon-button uk-icon-github" title="github项目地址"></a>
</h2>
</div>
<script type="text/javascript" src="../../../static/components/js/app_intro.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5313208362165053" data-ad-slot="1328047120"></ins>
<script>(adsbygoogle =window.adsbygoogle ||[]).push({});</script>
<hr class="uk-article-divider">
<div class="book-content-section  md-content-section  uk-margin-bottom">
<h1 id="内核初始化-part-4">内核初始化. Part 4.</h1>
<h1 id="kernel-entry-point">Kernel entry point</h1>
<p>还记得上一章的内容吗 - <a href="https://github.com/MintCN/linux-insides-zh/blob/master/Initialization/linux-initialization-3.html">跳转到内核入口之前的最后准备</a>？你应该还记得我们已经完成一系列初始化操作，并停在了调用位于<code>init/main.c</code>中的<code>start_kernel</code>函数之前.<code>start_kernel</code>函数是与体系架构无关的通用处理入口函数，尽管我们在此初始化过程中要无数次的返回arch/ 文件夹。如果你仔细看看<code>start_kernel</code>函数的内容，你将发现此函数涉及内容非常广泛。在此过程中约包含了86个调用函数，是的，你发现它真的是非常庞大但是此部分并不是全部的初始化过程，在当前阶段我们只看这些就可以了。此章节以及后续所有在<a href="https://github.com/MintCN/linux-insides-zh/blob/master/Initialization/README.html">内核初始化过程</a>章节的内容将涉及并详述它。</p>
<p><code>start_kernel</code>函数的主要目的是完成内核初始化并启动祖先进程(1号进程)。在祖先进程启动之前<code>start_kernel</code>函数做了很多事情，如<a href="https://www.kernel.org/doc/Documentation/locking/lockdep-design.txt">锁验证器</a>,根据处理器标识ID初始化处理器，开启cgroups子系统，设置每CPU区域环境，初始化<a href="http://en.wikipedia.org/wiki/Virtual_file_system">VFS</a> Cache机制，初始化内存管理，rcu,vmalloc,scheduler(调度器),IRQs(中断向量表),ACPI(中断可编程控制器)以及其它很多子系统。只有经过这些步骤我们才看到本章最后一部分祖先进程启动的过程；同志们，如此复杂的内核子系统，有没有勾起你的学习欲望，有这么多的内核代码等着我们去征服，让我们开始吧。</p>
<p><strong>注意:在此大章节的所有内容 <code>Linux Kernel initialization process</code>，并不涉及内核调试相关，关于内核调试部分会有一个单独的章节来进行描述</strong></p>
<h2 id="关于---attribute--">关于 <code>__attribute__</code></h2>
<p>正如我上述所写，<code>start_kernel</code>函数是定义在<a href="https://github.com/torvalds/linux/blob/master/init/main.c">init/main.c</a>.从已知代码中我们能看到此函数使用了<code>__init</code>特性，你也许从其它地方了解过关于GCC <code>__attribute__</code>相关的内容。在内核初始化阶段这个机制在所有的函数中都是有必要的。</p>
<pre><code class="language-C">	#define __init      __section(.init.text) __cold notrace
</code></pre>
<p>在初始化过程完成后，内核将通过调用<code>free_initmem</code>释放这些sections(段)。注意<code>__init</code>属性是通过<code>__cold</code>和<code>notrace</code>两个属性来定义的。第一个属性<code>cold</code>的目的是标记此函数很少使用所以编译器必须优化此函数的大小，第二个属性<code>notrace</code>定义如下：</p>
<pre><code class="language-C">	#define notrace __attribute__((no_instrument_function))
</code></pre>
<p>含有<code>no_instrument_function</code>意思就是告诉编译器函数调用不产生环境变量(堆栈空间)。</p>
<p>在<code>start_kernel</code>函数的定义中，你也可以看到<code>__visible</code> 属性的扩展：</p>
<pre><code>	#define __visible __attribute__((externally_visible))
</code></pre>
<p>含有<code>externally_visible</code>意思就是告诉编译器有一些过程在使用该函数或者变量，为了放至标记这个函数/变量是<code>unusable</code>。你可以在此<a href="https://github.com/torvalds/linux/blob/master/include/linux/init.h">include/linux/init.h</a>处查到这些属性表达式的含义。</p>
<h2 id="start-kernel-初始化">start_kernel 初始化</h2>
<p>在start_kernel的初始之初你可以看到这两个变量：</p>
<pre><code class="language-C">char *command_line;
char *after_dashes;
</code></pre>
<p>第一个变量表示内核命令行的全局指针，第二个变量将包含<code>parse_args</code>函数通过输入字符串中的参数'name=value'，寻找特定的关键字和调用正确的处理程序。我们不想在这个时候参与这两个变量的相关细节，但是会在接下来的章节看到。我们接着往下走，下一步我们看到了此函数:</p>
<pre><code class="language-C">lockdep_init();
</code></pre>
<p><code>lockdep_init</code> 初始化 <a href="https://www.kernel.org/doc/Documentation/locking/lockdep-design.txt">lock validator</a>. 其实现是相当简单的，它只是初始化了两个哈希表 <a href="https://github.com/MintCN/linux-insides-zh/blob/master/DataStructures/dlist.html">list_head</a>并设置<code>lockdep_initialized</code> 全局变量为<code>1</code>。 关于自旋锁 <a href="http://en.wikipedia.org/wiki/Spinlock">spinlock</a>以及互斥锁<a href="http://en.wikipedia.org/wiki/Mutual_exclusion">mutex</a> 如何获取请参考链接.</p>
<p>下一个函数是<code>set_task_stack_end_magic</code>，参数为<code>init_task</code>和设置<code>STACK_END_MAGIC</code> (<code>0x57AC6E9D</code>)。<code>init_task</code>代表初始化进程(任务)数据结构:</p>
<pre><code class="language-C">struct task_struct init_task = INIT_TASK(init_task);
</code></pre>
<p><code>task_struct</code> 存储了进程的所有相关信息。因为它很庞大，我在这本书并不会去介绍，详细信息你可以查看调度相关数据结构定义头文件 <a href="https://github.com/torvalds/linux/blob/master/include/linux/sched.h#L1278">include/linux/sched.h</a>。在此刻<code>task_sreuct</code>包含了超过<code>100</code>个字段！虽然你不会看到<code>task_struct</code>是在这本书中的解释，但是我们会经常使用它，因为它是介绍在Linux内核<code>进程</code>的基本知识。我将描述这个结构中字段的一些含义，因为我们在后面的实践中见到它们。</p>
<p>你也可以查看<code>init_task</code>的相关定义以及宏指令<code>INIT_TASK</code>的初始化流程。这个宏指令来自于<a href="https://github.com/torvalds/linux/blob/master/include/linux/init_task.h">include/linux/init_task.h</a>在此刻只是设置和初始化了第一个进程来(0号进程)的值。例如这么设置：</p>
<ul>
<li>初始化进程状态为 zero 或者 <code>runnable</code>. 一个可运行进程即为等待CPU去运行;</li>
<li>初始化仅存的标志位 - <code>PF_KTHREAD</code> 意思为 - 内核线程;</li>
<li>一个可运行的任务列表;</li>
<li>进程地址空间;</li>
<li>初始化进程堆栈 <code>&amp;init_thread_info</code> - <code>init_thread_union.thread_info</code> 和 <code>initthread_union</code> 使用共用体 - <code>thread_union</code> 包含了 <code>thread_info</code>进程信息以及进程栈:。</li>
</ul>
<pre><code class="language-C">union thread_union {
	struct thread_info thread_info;
    unsigned long stack[THREAD_SIZE/sizeof(long)];
};
</code></pre>
<p>每个进程都有其自己的堆栈，<code>x86_64</code>架构的CPU一般支持的页表是16KB or 4个页框大小。我们注意stack变量被定义为数据并且类型是<code>unsigned long</code>。<code>thread_union</code>结构的下一个字段为<code>thread_union</code> 定义如下：</p>
<pre><code class="language-C">struct thread_info {
        struct task_struct      *task;
        struct exec_domain      *exec_domain;
        __u32                   flags; 
        __u32                   status;
        __u32                   cpu;
        int                     saved_preempt_count;
        mm_segment_t            addr_limit;
        struct restart_block    restart_block;
        void __user             *sysenter_return;
        unsigned int            sig_on_uaccess_error:1;
        unsigned int            uaccess_err:1;
};
</code></pre>
<p>此结构占用52个字节。<code>thread_info</code>结构包含了特定体系架构相关的线程信息，我们都知道在<code>X86_64</code>架构上内核栈是逆生成而<code>thread_union.thread_info</code>结构则是正生长。所以进程进程栈是16KB并且<code>thread_info</code>是在栈底。还需我们处理<code>16 kilobytes - 62 bytes = 16332 bytes</code>.注意 <code>thread_union</code>代表一个联合体<a href="http://en.wikipedia.org/wiki/Union_type">union</a>而不是结构体，用一张图来描述栈内存空间。 如下图所示:</p>
<pre><code class="language-C">+-----------------------+
|                       |
|                       |
|        stack          |
|                       |
|_______________________|
|          |            |
|          |            |
|          |            |
|__________↓____________|             +--------------------+
|                       |             |                    |
|      thread_info      |&lt;-----------&gt;|     task_struct    |
|                       |             |                    |
+-----------------------+             +--------------------+
</code></pre>
<p>http://www.quora.com/In-Linux-kernel-Why-thread_info-structure-and-the-kernel-stack-of-a-process-binds-in-union-construct</p>
<p>所以<code>INIT_TASK</code>宏指令就是<code>task_struct's</code>'结构。正如我上述所写，我并不会去描述这些字段的含义和值，在<code>INIT_TASK</code>赋值处理的时候我们很快能看到这些。</p>
<p>现在让我们回到<code>set_task_stack_end_magic</code>函数，这个函数被定义在<a href="https://github.com/torvalds/linux/blob/master/kernel/fork.c#L297">kernel/fork.c</a>功能为设置<a href="http://en.wikipedia.org/wiki/Stack_buffer_overflow">canary</a> <code>init</code> 进程堆栈以检测堆栈溢出。</p>
<pre><code class="language-C">void set_task_stack_end_magic(struct task_struct *tsk)
{
	unsigned long *stackend;
	stackend = end_of_stack(tsk);
	*stackend = STACK_END_MAGIC; /* for overflow detection */
}
</code></pre>
<p>上述函数比较简单，<code>set_task_stack_end_magic</code>函数的作用是先通过<code>end_of_stack</code>函数获取堆栈并赋给 <code>task_struct</code>。 关于检测配置需要打开内核配置宏<code>CONFIG_STACK_GROWSUP</code>。因为我们学习的是x86架构的初始化，堆栈是逆生成，所以堆栈底部为：</p>
<pre><code class="language-C">(unsigned long *)(task_thread_info(p) + 1);
</code></pre>
<p><code>task_thread_info</code>的定义如下，返回一个当前的堆栈；</p>
<pre><code class="language-C">#define task_thread_info(task)  ((struct thread_info *)(task)-&gt;stack)
</code></pre>
<p>进程的栈底，我们写<code>STACK_END_MAGIC</code>这个值。如果设置<code>canary</code>，我们可以像这样子去检测堆栈：</p>
<pre><code class="language-C">if (*end_of_stack(task) != STACK_END_MAGIC) {
        //
        // handle stack overflow here
		//
}
</code></pre>
<p><code>set_task_stack_end_magic</code> 初始化完毕后的下一个函数是 <code>smp_setup_processor_id</code>.此函数在<code>x86_64</code>架构上是空函数：</p>
<pre><code class="language-C">void __init __weak smp_setup_processor_id(void)
{
}
</code></pre>
<p>在此架构上没有实现此函数，但在别的体系架构的实现可以参考<a href="http://en.wikipedia.org/wiki/IBM_ESA/390">s390</a> and <a href="http://en.wikipedia.org/wiki/ARM_architecture#64.2F32-bit_architecture">arm64</a>.</p>
<p>我们接着往下走，下一个函数是<code>debug_objects_early_init</code>。此函数的执行几乎和<code>lockdep_init</code>是一样的，但是填充的哈希对象是调试相关。上述我已经表明，关于内核调试部分会在后续专门有一个章节来完成。</p>
<p><code>debug_object_early_init</code>函数之后我们看到调用了<code>boot_init_stack_canary</code>函数。<code>task_struct-&gt;canary</code> 的值利用了GCC特性，但是此特性需要先使能内核<code>CONFIG_CC_STACKPROTECTOR</code>宏后才可以使用。 <code>boot_init_stack_canary</code> 什么也没有做， 否则基于随机数和随机池产生 <a href="http://en.wikipedia.org/wiki/Time_Stamp_Counter">TSC</a>:</p>
<pre><code class="language-C">get_random_bytes(&amp;canary, sizeof(canary));
tsc = __native_read_tsc();
canary += tsc + (tsc &lt;&lt; 32UL);
</code></pre>
<p>我们要获取随机数, 我们可以给<code>stack_canary</code> 字段 <code>task_struct</code>赋值：</p>
<pre><code class="language-C">current-&gt;stack_canary = canary;
</code></pre>
<p>然后将此值写入IRQ堆栈的顶部:</p>
<pre><code class="language-C">this_cpu_write(irq_stack_union.stack_canary, canary); // read below about this_cpu_write
</code></pre>
<p>关于IRQ的章节我们这里也不会详细刨析, 关于这部分介绍看这里<a href="http://en.wikipedia.org/wiki/Interrupt_request_%28PC_architecture%29">IRQs</a>.如果canary被设置, 关闭本地中断注册bootstrap CPU以及CPU maps. 我们关闭本地中断 (interrupts for current CPU) 使用 <code>local_irq_disable</code> 函数，展开后原型为 <code>arch_local_irq_disable</code> 函数<a href="https://github.com/torvalds/linux/blob/master/include/linux/percpu-defs.h">include/linux/percpu-defs.h</a>:</p>
<pre><code class="language-C">static inline notrace void arch_local_irq_enable(void)
{
        native_irq_enable();
}
</code></pre>
<p>如果<code>native_irq_enable</code>通过<code>cli</code>指令判断架构，这里是<code>X86_64</code>， Where <code>native_irq_enable</code> is <code>cli</code> instruction for <code>x86_64</code>.中断的关闭(屏蔽)我们可以通过注册当前CPU ID到CPU bitmap来实现。</p>
<h2 id="激活第一个cpu">激活第一个CPU</h2>
<p>当前已经走到<code>start_kernel</code>函数中的<code>boot_cpu_init</code>函数，此函数主要为了通过掩码初始化每一个CPU。首先我们需要获取当前处理器的ID通过下面函数：</p>
<pre><code class="language-C">int cpu = smp_processor_id();
</code></pre>
<p>现在是0. 如果<code>CONFIG_DEBUG_PREEMPT</code> 宏配置了那么 <code>smp_processor_id</code> 的值就来自于 <code>raw_smp_processor_id</code> 函数，原型如下:</p>
<pre><code class="language-C">#define raw_smp_processor_id() (this_cpu_read(cpu_number))
</code></pre>
<p><code>this_cpu_read</code> 函数与其它很多函数一样如(<code>this_cpu_write</code>, <code>this_cpu_add</code> 等等...) 被定义在<a href="https://github.com/torvalds/linux/blob/master/include/linux/percpu-defs.h">include/linux/percpu-defs.h</a> 此部分函数主要为对 <code>this_cpu</code> 进行操作. 这些操作提供不同的对每cpu<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Theory/per-cpu.html">per-cpu</a> 变量相关访问方式. 譬如让我们来看看这个函数 <code>this_cpu_read</code>:</p>
<pre><code>__pcpu_size_call_return(this_cpu_read_, pcp)
</code></pre>
<p>还记得上面我们所写，每cpu变量<code>cpu_number</code> 的值是<code>this_cpu_read</code>通过<code>raw_smp_processor_id</code>来得到，现在让我们看看 <code>__pcpu_size_call_return</code>的执行：</p>
<pre><code class="language-C">#define __pcpu_size_call_return(stem, variable)                         \
({                                                                      \
        typeof(variable) pscr_ret__;                                    \
        __verify_pcpu_ptr(&amp;(variable));                                 \
        switch(sizeof(variable)) {                                      \
        case 1: pscr_ret__ = stem##1(variable); break;                  \
        case 2: pscr_ret__ = stem##2(variable); break;                  \
        case 4: pscr_ret__ = stem##4(variable); break;                  \
        case 8: pscr_ret__ = stem##8(variable); break;                  \
        default:                                                        \
                __bad_size_call_parameter(); break;                     \
        }                                                               \
        pscr_ret__;                                                     \
}) 
</code></pre>
<p>是的，此函数虽然看起起奇怪但是它的实现是简单的，我们看到<code>pscr_ret__</code> 变量的定义是<code>int</code>类型，为什么是int类型呢？好吧，<code>变量</code>是<code>common_cpu</code> 它声明了每cpu(per-cpu)变量:</p>
<pre><code class="language-C">DECLARE_PER_CPU_READ_MOSTLY(int, cpu_number);
</code></pre>
<p>在下一个步骤中我们调用了<code>__verify_pcpu_ptr</code>通过使用一个有效的每cpu变量指针来取地址得到<code>cpu_number</code>。之后我们通过<code>pscr_ret__</code> 函数设置变量的大小，<code>common_cpu</code>变量是<code>int</code>,所以它的大小是4字节。意思就是我们通过<code>this_cpu_read_4(common_cpu)</code>获取cpu变量其大小被<code>pscr_ret__</code>决定。在<code>__pcpu_size_call_return</code>的结束 我们调用了__pcpu_size_call_return：</p>
<pre><code class="language-C">#define this_cpu_read_4(pcp)       percpu_from_op("mov", pcp)
</code></pre>
<p>需要调用<code>percpu_from_op</code> 并且通过<code>mov</code>指令来传递每cpu变量，<code>percpu_from_op</code>的内联扩展如下：</p>
<pre><code class="language-C">asm("movl %%gs:%1,%0" : "=r" (pfo_ret__) : "m" (common_cpu))
</code></pre>
<p>让我们尝试理解此函数是如果工作的，<code>gs</code>段寄存器包含每个CPU区域的初始值，这里我们通过<code>mov</code>指令copy <code>common_cpu</code>到内存中去，此函数还有另外的形式：</p>
<pre><code class="language-C">this_cpu_read(common_cpu)
</code></pre>
<p>等价于:</p>
<pre><code class="language-C">movl %gs:$common_cpu, $pfo_ret__
</code></pre>
<p>由于我们没有设置每个CPU的区域,我们只有一个 - 为当前CPU的值<code>zero</code> 通过此函数 <code>smp_processor_id</code>返回.</p>
<p>返回的ID表示我们处于哪一个CPU上, <code>boot_cpu_init</code> 函数设置了CPU的在线, 激活, 当前的设置为:</p>
<pre><code class="language-C">set_cpu_online(cpu, true);
set_cpu_active(cpu, true);
set_cpu_present(cpu, true);
set_cpu_possible(cpu, true);
</code></pre>
<p>上述我们所有使用的这些CPU的配置我们称之为- CPU掩码<code>cpumask</code>. <code>cpu_possible</code> 则是设置支持CPU热插拔时候的CPU ID. <code>cpu_present</code> 表示当前热插拔的CPU. <code>cpu_online</code>表示当前所有在线的CPU以及通过 <code>cpu_present</code> 来决定被调度出去的CPU. CPU热插拔的操作需要打开内核配置宏<code>CONFIG_HOTPLUG_CPU</code>并且将 <code>possible == present</code> 以及<code>active == online</code>选项禁用。这些功能都非常相似，每个函数都需要检查第二个参数，如果设置为<code>true</code>，需要通过调用<code>cpumask_set_cpu</code> or <code>cpumask_clear_cpu</code>来改变状态。</p>
<p>譬如我们可以通过true或者第二个参数来这么调用：</p>
<pre><code class="language-C">cpumask_set_cpu(cpu, to_cpumask(cpu_possible_bits));
</code></pre>
<p>让我们继续尝试理解<code>to_cpumask</code>宏指令，此宏指令转化为一个位图通过<code>struct cpumask *</code>，CPU掩码提供了位图集代表了当前系统中所有的CPU's，每CPU都占用1bit，CPU掩码相关定义通过<code>cpu_mask</code>结构定义:</p>
<pre><code class="language-C">typedef struct cpumask { DECLARE_BITMAP(bits, NR_CPUS); } cpumask_t;
</code></pre>
<p>在来看下面一组函数定义了位图宏指令。</p>
<pre><code class="language-C">#define DECLARE_BITMAP(name, bits) unsigned long name[BITS_TO_LONGS(bits)]
</code></pre>
<p>正如我们看到的定义一样， <code>DECLARE_BITMAP</code>宏指令的原型是一个<code>unsigned long</code>的数组，现在让我们查看如何执行<code>to_cpumask</code>:</p>
<pre><code class="language-C">#define to_cpumask(bitmap)                                              \
        ((struct cpumask *)(1 ? (bitmap)                                \
                            : (void *)sizeof(__check_is_bitmap(bitmap))))
</code></pre>
<p>我不知道你是怎么想的, 但是我是这么想的，我看到此函数其实就是一个条件判断语句当条件为真的时候，但是为什么执行<code>__check_is_bitmap</code>？让我们看看<code>__check_is_bitmap</code>的定义：</p>
<pre><code class="language-C">static inline int __check_is_bitmap(const unsigned long *bitmap)
{
        return 1;
}
</code></pre>
<p>原来此函数始终返回1，事实上我们需要这样的函数才达到我们的目的： 它在编译时给定一个<code>bitmap</code>，换句话将就是检查<code>bitmap</code>的类型是否是<code>unsigned long *</code>,因此我们仅仅通过<code>to_cpumask</code>宏指令将类型为<code>unsigned long</code>的数组转化为<code>struct cpumask *</code>。现在我们可以调用<code>cpumask_set_cpu</code> 函数，这个函数仅仅是一个 <code>set_bit</code>给CPU掩码的功能函数。所有的这些<code>set_cpu_*</code>函数的原理都是一样的。</p>
<p>如果你还不确定<code>set_cpu_*</code>这些函数的操作并且不能理解 <code>cpumask</code>的概念，不要担心。你可以通过读取这些章节<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Concepts/cpumask.html">cpumask</a> or <a href="https://www.kernel.org/doc/Documentation/cpu-hotplug.txt">documentation</a>.来继续了解和学习这些函数的原理。</p>
<p>现在我们已经激活第一个CPU，我们继续接着start_kernel函数往下走，下面的函数是<code>page_address_init</code>,但是此函数不执行任何操作，因为只有当所有内存不能直接映射的时候才会执行。</p>
<h2 id="linux-内核的第一条打印信息">Linux 内核的第一条打印信息</h2>
<p>下面调用了pr_notice函数。</p>
<pre><code class="language-C">#define pr_notice(fmt, ...) \
    printk(KERN_NOTICE pr_fmt(fmt), ##__VA_ARGS__)
</code></pre>
<p>pr_notice其实是printk的扩展，这里我们使用它打印了Linux 的banner。</p>
<pre><code class="language-C">pr_notice("%s", linux_banner);
</code></pre>
<p>打印的是内核的版本号以及编译环境信息:</p>
<pre><code>Linux version 4.0.0-rc6+ (alex@localhost) (gcc version 4.9.1 (Ubuntu 4.9.1-16ubuntu6) ) #319 SMP
</code></pre>
<h2 id="依赖于体系结构的初始化部分">依赖于体系结构的初始化部分</h2>
<p>下个步骤我们就要进入到指定的体系架构的初始函数，Linux 内核初始化体系架构相关调用<code>setup_arch</code>函数，这又是一个类型于<code>start_kernel</code>的庞大函数，这里我们仅仅简单描述，在下一个章节我们将继续深入。指定体系架构的内容，我们需要再一次阅读<code>arch/</code>目录，<code>setup_arch</code>函数定义在<a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/setup.c">arch/x86/kernel/setup.c</a> 文件中，此函数就一个参数-内核命令行。</p>
<p>此函数解析内核的段<code>_text</code>和<code>_data</code>来自于<code>_text</code>符号和<code>_bss_stop</code>(你应该还记得此文件<a href="https://github.com/torvalds/linux/blob/master/arch/x86/kernel/head_64.S#L46">arch/x86/kernel/head_64.S</a>)。我们使用<code>memblock</code>来解析内存块。</p>
<pre><code class="language-C">memblock_reserve(__pa_symbol(_text), (unsigned long)__bss_stop - (unsigned long)_text);
</code></pre>
<p>你可以阅读关于<code>memblock</code>的相关内容在<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/mm/linux-mm-1.html">Linux kernel memory management Part 1.</a>，你应该还记得<code>memblock_reserve</code>函数的两个参数：</p>
<ul>
<li>base physical address of a memory block;</li>
<li>size of a memory block.</li>
</ul>
<p>我们可以通过<code>__pa_symbol</code>宏指令来获取符号表<code>_text</code>段中的物理地址</p>
<pre><code class="language-C">#define __pa_symbol(x) \
	__phys_addr_symbol(__phys_reloc_hide((unsigned long)(x)))
</code></pre>
<p>上述宏指令调用 <code>__phys_reloc_hide</code> 宏指令来填充参数，<code>__phys_reloc_hide</code>宏指令在<code>x86_64</code>上返回的参数是给定的。宏指令 <code>__phys_addr_symbol</code>的执行是简单的，只是减去从<code>_text</code>符号表中读到的内核的符号映射地址并且加上物理地址的基地址。</p>
<pre><code class="language-C">#define __phys_addr_symbol(x) \
 ((unsigned long)(x) - __START_KERNEL_map + phys_base)
</code></pre>
<p><code>memblock_reserve</code>函数对内存页进行分配。</p>
<h2 id="保留可用内存初始化initrd">保留可用内存初始化initrd</h2>
<p>之后我们保留替换内核的text和data段用来初始化<a href="http://en.wikipedia.org/wiki/Initrd">initrd</a>,我们暂时不去了解initrd的详细信息，你仅仅只需要知道根文件系统就是通过这方式来进行初始化这就是<code>early_reserve_initrd</code> 函数的工作，此函数获取RAM DISK的基地址以及大小以及大小加偏移。</p>
<pre><code class="language-C">u64 ramdisk_image = get_ramdisk_image();
u64 ramdisk_size  = get_ramdisk_size();
u64 ramdisk_end   = PAGE_ALIGN(ramdisk_image + ramdisk_size);
</code></pre>
<p>如果你阅读过这些章节<a href="http://xinqiu.gitbooks.io/linux-insides-cn/content/Booting/index.html">Linux Kernel Booting Process</a>，你就知道所有的这些啊参数都来自于<code>boot_params</code>，时刻谨记<code>boot_params</code>在boot期间已经被赋值，内核启动头包含了一下几个字段用来描述RAM DISK：</p>
<pre><code>Field name:	ramdisk_image
Type:		write (obligatory)
Offset/size:	0x218/4
Protocol:	2.00+

  The 32-bit linear address of the initial ramdisk or ramfs.  Leave at
  zero if there is no initial ramdisk/ramfs.
</code></pre>
<p>我们可以得到关于 <code>boot_params</code>的一些信息. 具体查看<code>get_ramdisk_image</code>:</p>
<pre><code class="language-C">static u64 __init get_ramdisk_image(void)
{
        u64 ramdisk_image = boot_params.hdr.ramdisk_image;

        ramdisk_image |= (u64)boot_params.ext_ramdisk_image &lt;&lt; 32;

        return ramdisk_image;
}
</code></pre>
<p>关于32位的ramdisk的地址，我们可以阅读此部分内容来获取<a href="https://github.com/0xAX/linux/blob/master/Documentation/x86/zero-page.txt">Documentation/x86/zero-page.txt</a>:</p>
<pre><code>0C0/004	ALL	ext_ramdisk_image ramdisk_image high 32bits
</code></pre>
<p>32位变化后，我们获取64位的ramdisk原理一样，为此我们可以检查bootloader 提供的ramdisk信息：</p>
<pre><code class="language-C">if (!boot_params.hdr.type_of_loader ||
    !ramdisk_image || !ramdisk_size)
	return;
</code></pre>
<p>并保留内存块将ramdisk传输到最终的内存地址，然后进行初始化：</p>
<pre><code class="language-C">memblock_reserve(ramdisk_image, ramdisk_end - ramdisk_image);
</code></pre>
<h2 id="结束语">结束语</h2>
<p>以上就是第四部分关于内核初始化的部分内容，我们从<code>start_kernel</code>函数开始一直到指定体系架构初始化<code>setup_arch</code>的过程中停止，那么在下一个章节我们将继续研究体系架构相关的初始化内容。</p>
<p>如果你有任何的问题或者建议，你可以留言，也可以直接发消息给我<a href="https://twitter.com/0xAX">twitter</a>。</p>
<p><strong>很抱歉，英语并不是我的母的，非常抱歉给您阅读带来不便，如果你发现文中描述有任何问题，请提交一个 PR 到 <a href="https://github.com/MintCN/linux-insides-zh">linux-insides</a>.</strong></p>
<h2 id="链接">链接</h2>
<ul>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html">GCC function attributes</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/this_cpu_ops.txt">this_cpu operations</a></li>
<li><a href="http://www.crashcourse.ca/wiki/index.php/Cpumask">cpumask</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/locking/lockdep-design.txt">lock validator</a></li>
<li><a href="http://en.wikipedia.org/wiki/Cgroups">cgroups</a></li>
<li><a href="http://en.wikipedia.org/wiki/Stack_buffer_overflow">stack buffer overflow</a></li>
<li><a href="http://en.wikipedia.org/wiki/Interrupt_request_%28PC_architecture%29">IRQs</a></li>
<li><a href="http://en.wikipedia.org/wiki/Initrd">initrd</a></li>
<li><a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Initialization/linux-initialization-3.html">Previous part</a></li>
</ul>
</div>
<hr class="uk-article-divider">
<div class="uk-block uk-block-muted uk-padding-top-remove uk-padding-bottom-remove uk-margin-large-top  book-recommend-wrap">
<div class="uk-margin-top uk-margin-bottom uk-margin-left uk-margin-right">
<div class="uk-margin uk-text-muted "><i class="uk-icon-outdent uk-icon-justify uk-margin-small-right"></i>书籍推荐</div>
<div class="books">
<ul class="uk-book-list">
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/195/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/195/index.html">Linux命令大全搜索工具</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/111.html">jaywcjlove</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">30页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2021年10月24日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 个"></span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/181/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/181/index.html">命令行的艺术</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/101.html">jlevy</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">34页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年5月26日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 46710个">46710</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/114/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/114/index.html">Linux 内核揭密</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/62.html">tzivanmoe</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">86页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年7月1日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 2个">2</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/53/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/javascript_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/53/index.html">前端开发者指南 2018</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/30.html">稀土</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="css3">css3</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="html5">html5</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="javascript">javascript</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">103页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年6月3日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 282个">282</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/179/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/python_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/179/index.html">30秒学会常用Python代码</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/99.html">kriadmin</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="python">python</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">1页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年5月26日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 2716个">2716</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/110/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/react_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/110/index.html">React 学习之道</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/62.html">tzivanmoe</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="react">react</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">11页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年7月1日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 0个">0</span>
</div>
</div>
</div>
</li>
<hr>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<nav class="tm-navbar uk-navbar uk-navbar-attached reader-nav">
<div class="uk-float-left uk-margin-small-top">
<a href="javascript:;" title="目录菜单" class="show-menu  uk-icon-hover  uk-icon-align-justify uk-margin-right"></a>
<div data-uk-dropdown="{mode:'click',pos:'bottom-left'}" class="font-setting-wrap">
<a class="uk-icon-hover uk-icon-font uk-margin-right" aria-label="字体设置" href="javascript:;"></a>
<div class="uk-dropdown dropdown-menu">
<div class="dropdown-caret"><span class="caret-outer"></span><span class="caret-inner"></span></div>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-reduce">小字</button>
<button class="uk-button-link button size-2 font-enlarge">大字</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-1 ">宋体</button>
<button class="uk-button-link button size-2 font-2 ">黑体</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-3 color-theme-sun "><i class="uk-icon-sun-o"></i>白天</button>
<button class="uk-button-link button size-3 color-theme-eye "><i class="uk-icon-eye"></i>护眼</button>
<button class="uk-button-link button size-3 color-theme-moon "><i class="uk-icon-moon-o"></i>夜晚</button></div>
</div>
</div>
<a class="logo uk-margin-right" href="../../../" title="返回首页"><img class="" src="../../../static/components/images/icon_32.png" /></a>
</div>
<div class="uk-navbar-flip  uk-hidden-small">
<div id="share-box"></div>
</div>
</nav>
<div id="menu-id" class="uk-offcanvas reader-offcanvas">
<div class="uk-offcanvas-bar">
<ul class="book-menu-bar uk-nav uk-nav-offcanvas" data-uk-nav>
<li>
<a href="../../../book/104/index.html" data-book-page-rel-url="index.html" data-book-page-id="0" title="封面">封面</a>
</li>
<li>
<a class="pjax" href="../../../book/104/readme.html" data-book-page-rel-url="readme.html" data-book-page-id="0" title="简介">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/README.html" title="简介" data-book-page-rel-url="README.html" data-book-page-id="7458">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/README.html" title="引导" data-book-page-rel-url="Booting/README.html" data-book-page-id="7459">引导</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-1.html" title="从引导加载程序内核" data-book-page-rel-url="Booting/linux-bootstrap-1.html" data-book-page-id="7460">从引导加载程序内核</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-2.html" title="在内核安装代码的第一步" data-book-page-rel-url="Booting/linux-bootstrap-2.html" data-book-page-id="7461">在内核安装代码的第一步</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-3.html" title="视频模式初始化和转换到保护模式" data-book-page-rel-url="Booting/linux-bootstrap-3.html" data-book-page-id="7462">视频模式初始化和转换到保护模式</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-4.html" title="过渡到 64 位模式" data-book-page-rel-url="Booting/linux-bootstrap-4.html" data-book-page-id="7463">过渡到 64 位模式</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-5.html" title="内核解压缩" data-book-page-rel-url="Booting/linux-bootstrap-5.html" data-book-page-id="7464">内核解压缩</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/README.html" title="初始化" data-book-page-rel-url="Initialization/README.html" data-book-page-id="7465">初始化</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-1.html" title="内核解压之后的首要步骤" data-book-page-rel-url="Initialization/linux-initialization-1.html" data-book-page-id="7466">内核解压之后的首要步骤</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-2.html" title="早期的中断和异常控制" data-book-page-rel-url="Initialization/linux-initialization-2.html" data-book-page-id="7467">早期的中断和异常控制</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-3.html" title="在到达内核入口之前最后的准备" data-book-page-rel-url="Initialization/linux-initialization-3.html" data-book-page-id="7468">在到达内核入口之前最后的准备</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-4.html" title="内核入口 - start_kernel" data-book-page-rel-url="Initialization/linux-initialization-4.html" data-book-page-id="7469">内核入口 - start_kernel</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-5.html" title="体系架构初始化" data-book-page-rel-url="Initialization/linux-initialization-5.html" data-book-page-id="7470">体系架构初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-6.html" title="进一步初始化指定体系架构" data-book-page-rel-url="Initialization/linux-initialization-6.html" data-book-page-id="7471">进一步初始化指定体系架构</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-7.html" title="最后对指定体系架构初始化" data-book-page-rel-url="Initialization/linux-initialization-7.html" data-book-page-id="7472">最后对指定体系架构初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-8.html" title="调度器初始化" data-book-page-rel-url="Initialization/linux-initialization-8.html" data-book-page-id="7473">调度器初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-9.html" title="RCU 初始化" data-book-page-rel-url="Initialization/linux-initialization-9.html" data-book-page-id="7474">RCU 初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-10.html" title="初始化结束" data-book-page-rel-url="Initialization/linux-initialization-10.html" data-book-page-id="7475">初始化结束</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/README.html" title="中断" data-book-page-rel-url="Interrupts/README.html" data-book-page-id="7476">中断</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-1.html" title="中断和中断处理 Part 1." data-book-page-rel-url="Interrupts/interrupts-1.html" data-book-page-id="7477">中断和中断处理 Part 1.</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-2.html" title="深入 Linux 内核中的中断" data-book-page-rel-url="Interrupts/interrupts-2.html" data-book-page-id="7478">深入 Linux 内核中的中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-3.html" title="初步中断处理" data-book-page-rel-url="Interrupts/interrupts-3.html" data-book-page-id="7479">初步中断处理</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-4.html" title="中断处理" data-book-page-rel-url="Interrupts/interrupts-4.html" data-book-page-id="7480">中断处理</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-5.html" title="异常处理的实现" data-book-page-rel-url="Interrupts/interrupts-5.html" data-book-page-id="7481">异常处理的实现</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-6.html" title="处理不可屏蔽中断" data-book-page-rel-url="Interrupts/interrupts-6.html" data-book-page-id="7482">处理不可屏蔽中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-7.html" title="深入外部硬件中断" data-book-page-rel-url="Interrupts/interrupts-7.html" data-book-page-id="7483">深入外部硬件中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-8.html" title="IRQs的非早期初始化" data-book-page-rel-url="Interrupts/interrupts-8.html" data-book-page-id="7484">IRQs的非早期初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-9.html" title="Softirq, Tasklets and Workqueues" data-book-page-rel-url="Interrupts/interrupts-9.html" data-book-page-id="7485">Softirq, Tasklets and Workqueues</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-10.html" title="最后一部分" data-book-page-rel-url="Interrupts/interrupts-10.html" data-book-page-id="7486">最后一部分</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/README.html" title="系统调用" data-book-page-rel-url="SysCall/README.html" data-book-page-id="7487">系统调用</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-1.html" title="系统调用概念简介" data-book-page-rel-url="SysCall/syscall-1.html" data-book-page-id="7488">系统调用概念简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-2.html" title="Linux 内核如何处理系统调用" data-book-page-rel-url="SysCall/syscall-2.html" data-book-page-id="7489">Linux 内核如何处理系统调用</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-3.html" title="vsyscall and vDSO" data-book-page-rel-url="SysCall/syscall-3.html" data-book-page-id="7490">vsyscall and vDSO</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-4.html" title="Linux 内核如何运行程序" data-book-page-rel-url="SysCall/syscall-4.html" data-book-page-id="7491">Linux 内核如何运行程序</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/README.html" title="定时器和时钟管理" data-book-page-rel-url="Timers/README.html" data-book-page-id="7492">定时器和时钟管理</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-1.html" title="简介" data-book-page-rel-url="Timers/timers-1.html" data-book-page-id="7493">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-2.html" title="时钟源框架简介" data-book-page-rel-url="Timers/timers-2.html" data-book-page-id="7494">时钟源框架简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-3.html" title="The tick broadcast framework and dyntick" data-book-page-rel-url="Timers/timers-3.html" data-book-page-id="7495">The tick broadcast framework and dyntick</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-4.html" title="定时器介绍" data-book-page-rel-url="Timers/timers-4.html" data-book-page-id="7496">定时器介绍</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-5.html" title="Clockevents 框架简介" data-book-page-rel-url="Timers/timers-5.html" data-book-page-id="7497">Clockevents 框架简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-6.html" title="x86 相关的时钟源" data-book-page-rel-url="Timers/timers-6.html" data-book-page-id="7498">x86 相关的时钟源</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-7.html" title="Linux 内核中与时钟相关的系统调用" data-book-page-rel-url="Timers/timers-7.html" data-book-page-id="7499">Linux 内核中与时钟相关的系统调用</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/README.html" title="同步原语" data-book-page-rel-url="SyncPrim/README.html" data-book-page-id="7500">同步原语</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-1.html" title="自旋锁简介" data-book-page-rel-url="SyncPrim/sync-1.html" data-book-page-id="7501">自旋锁简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-2.html" title="队列自旋锁" data-book-page-rel-url="SyncPrim/sync-2.html" data-book-page-id="7502">队列自旋锁</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-3.html" title="信号量" data-book-page-rel-url="SyncPrim/sync-3.html" data-book-page-id="7503">信号量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-4.html" title="互斥锁" data-book-page-rel-url="SyncPrim/sync-4.html" data-book-page-id="7504">互斥锁</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-5.html" title="读者/写者信号量" data-book-page-rel-url="SyncPrim/sync-5.html" data-book-page-id="7505">读者/写者信号量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-6.html" title="顺序锁" data-book-page-rel-url="SyncPrim/sync-6.html" data-book-page-id="7506">顺序锁</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/README.html" title="内存管理" data-book-page-rel-url="MM/README.html" data-book-page-id="7508">内存管理</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-1.html" title="内存块" data-book-page-rel-url="MM/linux-mm-1.html" data-book-page-id="7509">内存块</a>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-2.html" title="固定映射地址和 ioremap" data-book-page-rel-url="MM/linux-mm-2.html" data-book-page-id="7510">固定映射地址和 ioremap</a>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-3.html" title="kmemcheck" data-book-page-rel-url="MM/linux-mm-3.html" data-book-page-id="7511">kmemcheck</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/README.html" title="概念" data-book-page-rel-url="Concepts/README.html" data-book-page-id="7512">概念</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Concepts/per-cpu.html" title="每个 CPU 的变量" data-book-page-rel-url="Concepts/per-cpu.html" data-book-page-id="7513">每个 CPU 的变量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/cpumask.html" title="CPU 掩码" data-book-page-rel-url="Concepts/cpumask.html" data-book-page-id="7514">CPU 掩码</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/initcall.html" title="initcall 机制" data-book-page-rel-url="Concepts/initcall.html" data-book-page-id="7515">initcall 机制</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/notification_chains.html" title="Linux 内核的通知链" data-book-page-rel-url="Concepts/notification_chains.html" data-book-page-id="7516">Linux 内核的通知链</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/README.html" title="Linux 内核中的数据结构" data-book-page-rel-url="DataStructures/README.html" data-book-page-id="7517">Linux 内核中的数据结构</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/DataStructures/dlist.html" title="双向链表" data-book-page-rel-url="DataStructures/dlist.html" data-book-page-id="7518">双向链表</a>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/radix-tree.html" title="基数树" data-book-page-rel-url="DataStructures/radix-tree.html" data-book-page-id="7519">基数树</a>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/bitmap.html" title="位数组" data-book-page-rel-url="DataStructures/bitmap.html" data-book-page-id="7520">位数组</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Theory/README.html" title="理论" data-book-page-rel-url="Theory/README.html" data-book-page-id="7521">理论</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Theory/Paging.html" title="分页" data-book-page-rel-url="Theory/Paging.html" data-book-page-id="7522">分页</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Theory/ELF.html" title="Elf64 格式" data-book-page-rel-url="Theory/ELF.html" data-book-page-id="7523">Elf64 格式</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/README.html" title="杂项" data-book-page-rel-url="Misc/README.html" data-book-page-id="7524">杂项</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Misc/how_kernel_compiled.html" title="内核编译方法" data-book-page-rel-url="Misc/how_kernel_compiled.html" data-book-page-id="7525">内核编译方法</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/linkers.html" title="链接器" data-book-page-rel-url="Misc/linkers.html" data-book-page-id="7526">链接器</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/contribute.html" title="Linux 内核开发" data-book-page-rel-url="Misc/contribute.html" data-book-page-id="7527">Linux 内核开发</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/program_startup.html" title="用户空间的程序启动过程" data-book-page-rel-url="Misc/program_startup.html" data-book-page-id="7528">用户空间的程序启动过程</a>
</li>
<li>
<a class="pjax" href="../../../book/104/" title="Write and Submit your first Linux kernel Patch" data-book-page-rel-url="" data-book-page-id="7507">Write and Submit your first Linux kernel Patch</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/KernelStructures/README.html" title="内核数据结构" data-book-page-rel-url="KernelStructures/README.html" data-book-page-id="7529">内核数据结构</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/KernelStructures/idt.html" title="中断描述符表" data-book-page-rel-url="KernelStructures/idt.html" data-book-page-id="7530">中断描述符表</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/LINKS.html" title="有帮助的链接" data-book-page-rel-url="LINKS.html" data-book-page-id="7531">有帮助的链接</a>
</li>
<li>
<a class="pjax" href="../../../book/104/contributors.html" title="贡献者" data-book-page-rel-url="contributors.html" data-book-page-id="7532">贡献者</a>
</li>
</ul>
</div>
</div>
<script src="https://cdn.staticfile.net/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript" src="../../../static/components/uikit-2.27.5/js/uikit.reader.js"></script>
<script type="text/javascript" src="../../../static/components/social-share/social-share.min.js"></script>
<script>(function(){var bp =document.createElement('script');var curProtocol =window.location.protocol.split(':')[0];if (curProtocol ==='https') {bp.src ='https://zz.bdstatic.com/linksubmit/push.js';}
else {bp.src ='http://push.zhanzhang.baidu.com/push.js';}
var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
<script src="https://cdn.staticfile.net/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.staticfile.net/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>
<script src="https://cdn.staticfile.net/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://cdn.staticfile.net/uikit/2.27.5/js/components/lightbox.min.js"></script>
<link rel="dns-prefetch" href="../../..//cdn.mathjax.org" />
<script type="text/x-mathjax-config">
 function initMathJax() {
    var mathId = $("book-content-section")[0];
    MathJax.Hub.Config({
        tex2jax: {skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code','a']},
        showProcessingMessages: false,
        messageStyle: "none"
    });
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,mathId]);
 };
initMathJax();
</script>
<script src='https://cdn.staticfile.net/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
<style>
	.MathJax_Display{display:inline!important;}
</style>
<script type="text/javascript" src="../../../static/components/js/reader.js"></script>
<script type="text/javascript">var bookId =104;var bookPageId =7469;var bookPageRelUrl ='Initialization/linux-initialization-4.html';</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
</body>
</html>