
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<title>kmemcheck-Linux 内核揭密</title>
<meta content='kmemcheck,Linux 内核揭密' name='keywords'>
<meta content='kmemcheck,Linux 内核揭密' name='description'>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="zh-CN" />
<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=no"../../../>
<meta name="applicable-device" content="pc,mobile">
<link rel="shortcut icon" href="../../../favicon.ico" type="image/x-icon" />
<meta name="renderer" content="webkit">
<link rel="stylesheet" href="../../../static/components/uikit-2.27.5/css/uikit.custom.css">
<link rel="stylesheet" href="../../../static/components/social-share/social-share.min.css">
<link rel="stylesheet" href="../../../static/components/highlight/styles/custom.css">
<link rel="stylesheet" href="../../../static/components/css/base.css">
<link rel="stylesheet" href="../../../static/components/css/reader.css">
<link rel="stylesheet" href="../../../static/components/css/markdown.css">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5313208362165053" crossorigin="anonymous"></script>
</head>
<body>
<div class=" book-main-wrap uk-container uk-container-center uk-margin-top ">
<div class="uk-grid">
<div class="uk-width-1-1 reader-wrap ">
<div class=" bottom-nav uk-clearfix ">
<div class="uk-align-left ">
<a href="../../../book/104/MM/linux-mm-2.html">
<i class="nav-icon-left uk-icon-small  uk-icon-caret-left"></i>
<span class="">固定映射地址和 ior..</span>
</a>
</div>
<div class="uk-align-right ">
<a href="../../../book/104/Concepts/README.html">
<span class="">概念</span>
<i class="nav-icon-right uk-icon-small  uk-icon-caret-right"></i>
</a>
</div>
</div>
<div class="uk-text-center">
<h2 class="book-page-title uk-container-center">
<a href="../../../book/104/index.html">Linux 内核揭密</a>
<a target="_blank" rel="nofollow" href="https://github.com/ye11ow/linux-insides-zh" class="uk-icon-button uk-icon-github" title="github项目地址"></a>
</h2>
</div>
<script type="text/javascript" src="../../../static/components/js/app_intro.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5313208362165053" data-ad-slot="1328047120"></ins>
<script>(adsbygoogle =window.adsbygoogle ||[]).push({});</script>
<hr class="uk-article-divider">
<div class="book-content-section  md-content-section  uk-margin-bottom">
<h1 id="linux内核内存管理-第三节">Linux内核内存管理 第三节</h1>
<h2 id="内核中-kmemcheck-介绍">内核中 kmemcheck 介绍</h2>
<p>Linux内存管理<a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/mm/">章节</a>描述了Linux内核中<a href="https://en.wikipedia.org/wiki/Memory_management">内存管理</a>；本小节是第三部分。 在本章<a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/mm/linux-mm-2.html">第二节</a>中我们遇到了两个与内存管理相关的概念：</p>
<ul>
<li><code>固定映射地址</code>;</li>
<li><code>输入输出重映射</code>.</li>
</ul>
<p>固定映射地址代表<a href="https://en.wikipedia.org/wiki/Virtual_memory">虚拟内存</a>中的一类特殊区域， 这类地址的物理映射地址是在<a href="https://en.wikipedia.org/wiki/Compile_time">编译</a>期间计算出来的。输入输出重映射表示把输入/输出相关的内存映射到虚拟内存。</p>
<p>例如，查看<code>/proc/iomem</code>命令：</p>
<pre><code>$ sudo cat /proc/iomem

00000000-00000fff : reserved
00001000-0009d7ff : System RAM
0009d800-0009ffff : reserved
000a0000-000bffff : PCI Bus 0000:00
000c0000-000cffff : Video ROM
000d0000-000d3fff : PCI Bus 0000:00
000d4000-000d7fff : PCI Bus 0000:00
000d8000-000dbfff : PCI Bus 0000:00
000dc000-000dffff : PCI Bus 0000:00
000e0000-000fffff : reserved
...
...
...
</code></pre>
<p><code>iomem</code> 命令的输出显示了系统中每个物理设备所映射的内存区域。第一列为物理设备分配的内存区域，第二列为对应的各种不同类型的物理设备。再例如：</p>
<pre><code>$ sudo cat /proc/ioports

0000-0cf7 : PCI Bus 0000:00
  0000-001f : dma1
  0020-0021 : pic1
  0040-0043 : timer0
  0050-0053 : timer1
  0060-0060 : keyboard
  0064-0064 : keyboard
  0070-0077 : rtc0
  0080-008f : dma page reg
  00a0-00a1 : pic2
  00c0-00df : dma2
  00f0-00ff : fpu
    00f0-00f0 : PNP0C04:00
  03c0-03df : vga+
  03f8-03ff : serial
  04d0-04d1 : pnp 00:06
  0800-087f : pnp 00:01
  0a00-0a0f : pnp 00:04
  0a20-0a2f : pnp 00:04
  0a30-0a3f : pnp 00:04
...
...
...
</code></pre>
<p><code>ioports</code> 的输出列出了系统中物理设备所注册的各种类型的I/O端口。内核不能直接访问设备的输入/输出地址。在内核能够使用这些内存之前，必须将这些地址映射到虚拟地址空间，这就是<code>io remap</code>机制的主要目的。在前面<a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/mm/linux-mm-2.html">第二节</a>中只介绍了早期的 <code>io remap</code> 。很快我们就要来看一看常规的 <code>io remap</code> 实现机制。但在此之前，我们需要学习一些其他的知识，例如不同类型的内存分配器等，不然的话我们很难理解该机制。</p>
<p>在进入Linux内核常规期的<a href="https://en.wikipedia.org/wiki/Memory_management">内存管理</a>之前，我们要看一些特殊的内存机制，例如<a href="https://en.wikipedia.org/wiki/Debugging">调试</a>，检查<a href="https://en.wikipedia.org/wiki/Memory_leak">内存泄漏</a>，内存控制等等。学习这些内容有助于我们理解Linux内核的内存管理。</p>
<p>从本节的标题中，你可能已经看出来，我们会从<a href="https://www.kernel.org/doc/Documentation/kmemcheck.txt">kmemcheck</a>开始了解内存机制。和前面的<a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/">章节</a>一样，我们首先从理论上学习什么是 <code>kmemcheck</code> ，然后再来看Linux内核中是怎么实现这一机制的。</p>
<p>让我们开始吧。Linux内核中的 <code>kmemcheck</code> 到底是什么呢？从该机制的名称上你可能已经猜到， <code>kmemcheck</code> 是检查内存的。你猜的很对。<code>kmemcheck</code> 的主要目的就是用来检查是否有内核代码访问 <code>未初始化的内存</code> 。让我们看一个简单的 <a href="https://en.wikipedia.org/wiki/C_%28programming_language%29">C</a> 程序：</p>
<pre><code class="language-C">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;

struct A {
        int a;
};

int main(int argc, char **argv) {
        struct A *a = malloc(sizeof(struct A));
        printf("a-&gt;a = %d\n", a-&gt;a);
        return 0;
}
</code></pre>
<p>在上面的程序中我们给结构体<code>A</code>分配了内存，然后我们尝试打印它的成员<code>a</code>。如果我们不使用其他选项来编译该程序：</p>
<pre><code>gcc test.c -o test
</code></pre>
<p><a href="https://en.wikipedia.org/wiki/GNU_Compiler_Collection">编译器</a>不会显示成员 <code>a</code> 未初始化的提示信息。但是如果使用工具<a href="https://en.wikipedia.org/wiki/Valgrind">valgrind</a>来运行该程序，我们会看到如下输出：</p>
<pre><code>~$   valgrind --leak-check=yes ./test
==28469== Memcheck, a memory error detector
==28469== Copyright (C) 2002-2015, and GNU GPL'd, by Julian Seward et al.
==28469== Using Valgrind-3.11.0 and LibVEX; rerun with -h for copyright info
==28469== Command: ./test
==28469== 
==28469== Conditional jump or move depends on uninitialised value(s)
==28469==    at 0x4E820EA: vfprintf (in /usr/lib64/libc-2.22.so)
==28469==    by 0x4E88D48: printf (in /usr/lib64/libc-2.22.so)
==28469==    by 0x4005B9: main (in /home/alex/test)
==28469== 
==28469== Use of uninitialised value of size 8
==28469==    at 0x4E7E0BB: _itoa_word (in /usr/lib64/libc-2.22.so)
==28469==    by 0x4E8262F: vfprintf (in /usr/lib64/libc-2.22.so)
==28469==    by 0x4E88D48: printf (in /usr/lib64/libc-2.22.so)
==28469==    by 0x4005B9: main (in /home/alex/test)
...
...
...
</code></pre>
<p>实际上 <code>kmemcheck</code> 在内核空间做的事情，和 <code>valgrind</code> 在用户空间做的事情是一样的，都是用来检测未初始化的内存。</p>
<p>要想在内核中启用该机制，需要在配置内核时开启 <code>CONFIG_KMEMCHECK</code> 选项：</p>
<pre><code>Kernel hacking
  -&gt; Memory Debugging
</code></pre>
<p><a href="http://oi63.tinypic.com/2pzbog7.jpg" data-uk-lightbox><img src="http://oi63.tinypic.com/2pzbog7.jpg" alt="kernel configuration menu"></a></p>
<p><code>kmemcheck</code> 机制还提供了一些内核配置参数，我们可以在下一个段落中看到所有的可选参数。最后一个需要注意的是，<code>kmemcheck</code> 仅在 <a href="https://en.wikipedia.org/wiki/X86-64">x86_64</a> 体系中实现了。为了确信这一点，我们可以查看 <code>x86</code> 的内核配置文件 <a href="https://github.com/torvalds/linux/blob/master/arch/x86/Kconfig">arch/x86/Kconfig</a>：</p>
<pre><code>config X86
  ...
  ...
  ...
  select HAVE_ARCH_KMEMCHECK
  ...
  ...
  ...
</code></pre>
<p>因此，对于其他的体系结构来说是没有 <code>kmemcheck</code> 功能的。</p>
<p>现在我们知道了 <code>kmemcheck</code> 可以检测内核中<code>未初始化内存</code>的使用情况，也知道了如何开启这个功能。那么 <code>kmemcheck</code> 是怎么做检测的呢？当内核尝试分配内存时，例如如下一段代码：</p>
<pre><code>struct my_struct *my_struct = kmalloc(sizeof(struct my_struct), GFP_KERNEL);
</code></pre>
<p>或者换句话说，在内核访问 <a href="https://en.wikipedia.org/wiki/Page_%28computer_memory%29">page</a> 时会发生<a href="https://en.wikipedia.org/wiki/Page_fault">缺页中断</a>。这是由于 <code>kmemcheck</code> 将内存页标记为<code>不存在</code>（关于Linux内存分页的相关信息，你可以参考<a href="https://0xax.gitbooks.io/linux-insides/content/Theory/Paging.html">分页</a>）。如果一个<code>缺页中断</code>异常发生了，异常处理程序会来处理这个异常，如果异常处理程序检测到内核使能了 <code>kmemcheck</code>，那么就会将控制权提交给 <code>kmemcheck</code> 来处理；<code>kmemcheck</code> 检查完之后，该内存页会被标记为 <code>present</code>，然后被中断的程序得以继续执行下去。 这里的处理方式比较巧妙，被中断程序的第一条指令执行时，<code>kmemcheck</code> 又会标记内存页为 <code>not present</code>，按照这种方式，下一个对内存页的访问也会被捕获。</p>
<p>目前我们只是从理论层面考察了 <code>kmemcheck</code>，接下来我们看一下Linux内核是怎么来实现该机制的。</p>
<h2 id="kmemcheck-机制在linux内核中的实现"><code>kmemcheck</code> 机制在Linux内核中的实现</h2>
<p>我们应该已经了解 <code>kmemcheck</code> 是做什么的以及它在Linux内核中的功能，现在是时候看一下它在Linux内核中的实现。 <code>kmemcheck</code> 在内核的实现分为两部分。第一部分是架构无关的部分，位于源码 <a href="https://github.com/torvalds/linux/blob/master/mm/kmemcheck.c">mm/kmemcheck.c</a>；第二部分 <a href="https://en.wikipedia.org/wiki/X86-64">x86_64</a>架构相关的部分位于目录<a href="https://github.com/torvalds/linux/tree/master/arch/x86/mm/kmemcheck">arch/x86/mm/kmemcheck</a>中。</p>
<p>我们先分析该机制的初始化过程。我们已经知道要在内核中使能 <code>kmemcheck</code> 机制，需要开启内核的<code>CONFIG_KMEMCHECK</code> 配置项。除了这个选项，我们还需要给内核command line传递一个 <code>kmemcheck</code> 参数：</p>
<ul>
<li>kmemcheck=0 (disabled)</li>
<li>kmemcheck=1 (enabled)</li>
<li>kmemcheck=2 (one-shot mode)</li>
</ul>
<p>前面两个值得含义很明确，但是最后一个需要解释。这个选项会使 <code>kmemcheck</code> 进入一种特殊的模式：在第一次检测到未初始化内存的使用之后，就会关闭 <code>kmemcheck</code> 。实际上该模式是内核的默认选项：</p>
<p><a href="http://oi66.tinypic.com/y2eeh.jpg" data-uk-lightbox><img src="http://oi66.tinypic.com/y2eeh.jpg" alt="kernel configuration menu"></a></p>
<p>从Linux初始化过程章节的第七节 <a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Initialization/linux-initialization-7.html">part</a> 中，我们知道在内核初始化过程中，会在 <code>do_initcall_level</code> , <code>do_early_param</code> 等函数中解析内核 command line。前面也提到过 <code>kmemcheck</code> 子系统由两部分组成，第一部分启动比较早。在源码 <a href="https://github.com/torvalds/linux/blob/master/mm/kmemcheck.c">mm/kmemcheck.c</a> 中有一个函数 <code>param_kmemcheck</code> ，该函数在command line解析时就会用到:</p>
<pre><code class="language-C">static int __init param_kmemcheck(char *str)
{
	int val;
	int ret;

	if (!str)
		return -EINVAL;

	ret = kstrtoint(str, 0, &amp;val);
	if (ret)
		return ret;
	kmemcheck_enabled = val;
	return 0;
}

early_param("kmemcheck", param_kmemcheck);
</code></pre>
<p>从前面的介绍我们知道 <code>param_kmemcheck</code> 可能存在三种情况：<code>0</code> (使能), <code>1</code> (禁止) or <code>2</code> (一次性)。 <code>param_kmemcheck</code> 的实现很简单：将command line传递的 <code>kmemcheck</code> 参数的值由字符串转换为整数，然后赋值给变量 <code>kmemcheck_enabled</code> 。</p>
<p>第二阶段在内核初始化阶段执行，而不是在早期初始化过程 <a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Concepts/initcall.html">initcalls</a> 。第二阶断的过程体现在 <code>kmemcheck_init</code> :</p>
<pre><code class="language-C">int __init kmemcheck_init(void)
{
    ...
    ...
    ...
}

early_initcall(kmemcheck_init);
</code></pre>
<p><code>kmemcheck_init</code> 的主要目的就是调用 <code>kmemcheck_selftest</code> 函数，并检查它的返回值：</p>
<pre><code class="language-C">if (!kmemcheck_selftest()) {
	printk(KERN_INFO "kmemcheck: self-tests failed; disabling\n");
	kmemcheck_enabled = 0;
	return -EINVAL;
}

printk(KERN_INFO "kmemcheck: Initialized\n");
</code></pre>
<p>如果 <code>kmemcheck_init</code> 检测失败，就返回 <code>EINVAL</code> 。 <code>kmemcheck_selftest</code> 函数会检测内存访问相关的<a href="https://en.wikipedia.org/wiki/Opcode">操作码</a>（例如 <code>rep movsb</code>, <code>movzwq</code>)的大小。如果检测到的大小的实际大小是一致的，<code>kmemcheck_selftest</code> 返回 <code>true</code>，否则返回 <code>false</code>。</p>
<p>如果如下代码被调用:</p>
<pre><code class="language-C">struct my_struct *my_struct = kmalloc(sizeof(struct my_struct), GFP_KERNEL);
</code></pre>
<p>经过一系列的函数调用，<code>kmem_getpages</code> 函数会被调用到，该函数的定义在源码 <a href="https://github.com/torvalds/linux/blob/master/mm/slab.c">mm/slab.c</a> 中，该函数的主要功能就是尝试按照指定的参数需求分配<a href="https://en.wikipedia.org/wiki/Paging">内存页</a>。在该函数的结尾处有如下代码：</p>
<pre><code class="language-C">if (kmemcheck_enabled &amp;&amp; !(cachep-&gt;flags &amp; SLAB_NOTRACK)) {
	kmemcheck_alloc_shadow(page, cachep-&gt;gfporder, flags, nodeid);

    if (cachep-&gt;ctor)
		kmemcheck_mark_uninitialized_pages(page, nr_pages);
	else
		kmemcheck_mark_unallocated_pages(page, nr_pages);
}
</code></pre>
<p>这段代码判断如果 <code>kmemcheck</code> 使能，并且参数中未设置 <code>SLAB_NOTRACK</code> ，那么就给分配的内存页设置 <code>non-present</code> 标记。<code>SLAB_NOTRACK</code> 标记的含义是不跟踪未初始化的内存。另外，如果缓存对象有构造函数（细节在下面描述），所分配的内存页标记为未初始化，否则标记为未分配。<code>kmemcheck_alloc_shadow</code> 函数在源码 <a href="https://github.com/torvalds/linux/blob/master/mm/kmemcheck.c">mm/kmemcheck.c</a> 中，其基本内容如下：</p>
<pre><code class="language-C">void kmemcheck_alloc_shadow(struct page *page, int order, gfp_t flags, int node)
{
    struct page *shadow;

   	shadow = alloc_pages_node(node, flags | __GFP_NOTRACK, order);

   	for(i = 0; i &lt; pages; ++i)
		page[i].shadow = page_address(&amp;shadow[i]);

   	kmemcheck_hide_pages(page, pages);
}
</code></pre>
<p>首先为 shadow bits 分配内存，并为内存页设置 shadow 位。如果内存页设置了该标记，就意味着 <code>kmemcheck</code> 会跟踪这个内存页。最后调用 <code>kmemcheck_hide_pages</code> 函数。 <code>kmemcheck_hide_pages</code> 是体系结构相关的函数，其代码在 <a href="https://github.com/torvalds/linux/tree/master/arch/x86/mm/kmemcheck/kmemcheck.c">arch/x86/mm/kmemcheck/kmemcheck.c</a> 源码中。该函数的功能是为指定的内存页设置 <code>non-present</code> 标记。该函数实现如下：</p>
<pre><code class="language-C">void kmemcheck_hide_pages(struct page *p, unsigned int n)
{
	unsigned int i;

	for (i = 0; i &lt; n; ++i) {
		unsigned long address;
		pte_t *pte;
		unsigned int level;

		address = (unsigned long) page_address(&amp;p[i]);
		pte = lookup_address(address, &amp;level);
		BUG_ON(!pte);
		BUG_ON(level != PG_LEVEL_4K);

		set_pte(pte, __pte(pte_val(*pte) &amp; ~_PAGE_PRESENT));
		set_pte(pte, __pte(pte_val(*pte) | _PAGE_HIDDEN));
		__flush_tlb_one(address);
	}
}
</code></pre>
<p>该函数遍历参数代表的所有内存页，并尝试获取每个内存页的 <code>页表项</code> 。如果获取成功，清理页表项的present 标记，设置页表项的 hidden 标记。在最后还需要刷新 <a href="https://en.wikipedia.org/wiki/Translation_lookaside_buffer">TLB</a> ,因为有一些内存页已经发生了改变。从这个地方开始，内存页就进入 <code>kmemcheck</code> 的跟踪系统。由于内存页的 <code>present</code> 标记被清除了，一旦 <code>kmalloc</code> 返回了内存地址，并且有代码访问这个地址，就会触发<a href="https://en.wikipedia.org/wiki/Page_fault">缺页中断</a>。</p>
<p>在Linux内核初始化的<a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Initialization/linux-initialization-2.html">第二节</a>介绍过，<code>缺页中断</code>处理程序是 <a href="https://github.com/torvalds/linux/blob/master/arch/x86/mm/fault.c">arch/x86/mm/fault.c</a> 的 <code>do_page_fault</code> 函数。该函数开始部分如下：</p>
<pre><code class="language-C">static noinline void
__do_page_fault(struct pt_regs *regs, unsigned long error_code,
		unsigned long address)
{
    ...
    ...
    ...
	if (kmemcheck_active(regs))
		kmemcheck_hide(regs);
    ...
    ...
    ...
}
</code></pre>
<p><code>kmemcheck_active</code> 函数获取 <code>kmemcheck_context</code> <a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Concepts/per-cpu.html">per-cpu</a> 结构体，并返回该结构体成员 <code>balance</code> 和0的比较结果：</p>
<pre><code>bool kmemcheck_active(struct pt_regs *regs)
{
	struct kmemcheck_context *data = this_cpu_ptr(&amp;kmemcheck_context);

	return data-&gt;balance &gt; 0;
}
</code></pre>
<p><code>kmemcheck_context</code> 结构体代表 <code>kmemcheck</code> 机制的当前状态。其内部保存了未初始化的地址，地址的数量等信息。其成员 <code>balance</code> 代表了 <code>kmemcheck</code> 的当前状态，换句话说，<code>balance</code> 表示 <code>kmemcheck</code> 是否已经隐藏了内存页。如果 <code>data-&gt;balance</code> 大于0， <code>kmemcheck_hide</code> 函数会被调用。这意味着 <code>kmemecheck</code> 已经设置了内存页的 <code>present</code> 标记，但是我们需要再次隐藏内存页以便触发下一次的缺页中断。 <code>kmemcheck_hide</code> 函数会清理内存页的 <code>present</code> 标记，这表示一次 <code>kmemcheck</code> 会话已经完成，新的缺页中断会再次被触发。在第一步，由于 <code>data-&gt;balance</code> 值为0，所以 <code>kmemcheck_active</code> 会返回false，所以 <code>kmemcheck_hide</code> 也不会被调用。接下来，我们看 <code>do_page_fault</code> 的下一行代码：</p>
<pre><code class="language-C">if (kmemcheck_fault(regs, address, error_code))
		return;
</code></pre>
<p>首先 <code>kmemcheck_fault</code> 函数检查引起错误的真实原因。第一步先检查<a href="https://en.wikipedia.org/wiki/FLAGS_register">标记寄存器</a>以确认进程是否处于正常的内核态：</p>
<pre><code class="language-C">if (regs-&gt;flags &amp; X86_VM_MASK)
		return false;
if (regs-&gt;cs != __KERNEL_CS)
		return false;
</code></pre>
<p>如果检测失败，表明这不是 <code>kmemcheck</code> 相关的缺页中断，<code>kmemcheck_fault</code> 会返回false。如果检测成功，接下来查找发生异常的地址的<code>页表项</code>，如果找不到页表项，函数返回false:</p>
<pre><code class="language-C">pte = kmemcheck_pte_lookup(address);
if (!pte)
	return false;
</code></pre>
<p><code>kmemcheck_fault</code> 最后一步是调用 <code>kmemcheck_access</code> 函数，该函数检查对指定内存页的访问，并设置该内存页的present标记。 <code>kmemcheck_access</code> 函数做了大部分工作，它检查引起缺页异常的当前指令，如果检查到了错误，那么会把该错误的上下文保存到环形队列中：</p>
<pre><code class="language-C">static struct kmemcheck_error error_fifo[CONFIG_KMEMCHECK_QUEUE_SIZE];
</code></pre>
<p><code>kmemcheck</code> 声明了一个特殊的 <a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Interrupts/interrupts-9.html">tasklet</a> :</p>
<pre><code class="language-C">static DECLARE_TASKLET(kmemcheck_tasklet, &amp;do_wakeup, 0);
</code></pre>
<p>该tasklet被调度执行时，会调用 <code>do_wakeup</code> 函数，该函数位于 <a href="https://github.com/torvalds/linux/blob/master/arch/x86/mm/kmemcheck/error.c">arch/x86/mm/kmemcheck/error.c</a> 文件中。</p>
<p><code>do_wakeup</code> 函数调用 <code>kmemcheck_error_recall</code> 函数以便将 <code>kmemcheck</code> 检测到的错误信息输出。</p>
<pre><code class="language-C">kmemcheck_show(regs);
</code></pre>
<p><code>kmemcheck_fault</code> 函数结束时会调用 <code>kmemcheck_show</code> 函数，该函数会再次设置内存页的present标记。</p>
<pre><code class="language-C">if (unlikely(data-&gt;balance != 0)) {
	kmemcheck_show_all();
	kmemcheck_error_save_bug(regs);
	data-&gt;balance = 0;
	return;
}
</code></pre>
<p><code>kmemcheck_show_all</code> 函数会针对每个地址调用 <code>kmemcheck_show_addr</code> ：</p>
<pre><code class="language-C">static unsigned int kmemcheck_show_all(void)
{
	struct kmemcheck_context *data = this_cpu_ptr(&amp;kmemcheck_context);
	unsigned int i;
	unsigned int n;

	n = 0;
	for (i = 0; i &lt; data-&gt;n_addrs; ++i)
		n += kmemcheck_show_addr(data-&gt;addr[i]);

	return n;
}
</code></pre>
<p><code>kmemcheck_show_addr</code> 函数内容如下:</p>
<pre><code class="language-C">int kmemcheck_show_addr(unsigned long address)
{
	pte_t *pte;

	pte = kmemcheck_pte_lookup(address);
	if (!pte)
		return 0;

	set_pte(pte, __pte(pte_val(*pte) | _PAGE_PRESENT));
	__flush_tlb_one(address);
	return 1;
}
</code></pre>
<p>在函数 <code>kmemcheck_show</code> 的结尾处会设置 <a href="https://en.wikipedia.org/wiki/Trap_flag">TF</a> 标记：</p>
<pre><code class="language-C">if (!(regs-&gt;flags &amp; X86_EFLAGS_TF))
	data-&gt;flags = regs-&gt;flags;
</code></pre>
<p>我们之所以这么处理，是因为我们在内存页的缺页中断处理完后需要再次隐藏内存页。当 <code>TF</code> 标记被设置后，处理器在执行被中断程序的第一条指令时会进入单步模式，这会触发 <code>debug</code> 异常。从这个地方开始，内存页会被隐藏起来，执行流程继续。由于内存页不可见，那么访问内存页的时候又会触发缺页中断，然后<code>kmemcheck</code> 就有机会继续检测/收集并显示内存错误信息。</p>
<p>到这里 <code>kmemcheck</code> 的工作机制就介绍完毕了。</p>
<h2 id="结束语">结束语</h2>
<p>Linux内核<a href="https://en.wikipedia.org/wiki/Memory_management">内存管理</a>第三节介绍到此为止。如果你有任何疑问或者建议，你可以直接给我<a href="https://twitter.com/0xAX">0xAX</a>发消息， 发<a href="anotherworldofworld@gmail.com">邮件</a>，或者创建一个 <a href="https://github.com/0xAX/linux-insides/issues/new">issue</a> 。 在接下来的小节中，我们来看一下另一个内存调试工具 - <code>kmemleak</code> 。</p>
<p><strong>英文不是我的母语。如果你发现我的英文描述有任何问题，请提交一个PR到 <a href="https://github.com/0xAX/linux-insides">linux-insides</a>.</strong></p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Memory_management">memory management</a></li>
<li><a href="https://en.wikipedia.org/wiki/Debugging">debugging</a></li>
<li><a href="https://en.wikipedia.org/wiki/Memory_leak">memory leaks</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/kmemcheck.txt">kmemcheck documentation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Valgrind">valgrind</a></li>
<li><a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Theory/Paging.html">paging</a></li>
<li><a href="https://en.wikipedia.org/wiki/Page_fault">page fault</a></li>
<li><a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Concepts/initcall.html">initcalls</a></li>
<li><a href="https://en.wikipedia.org/wiki/Opcode">opcode</a></li>
<li><a href="https://en.wikipedia.org/wiki/Translation_lookaside_buffer">translation lookaside buffer</a></li>
<li><a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Concepts/per-cpu.html">per-cpu variables</a></li>
<li><a href="https://en.wikipedia.org/wiki/FLAGS_register">flags register</a></li>
<li><a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Interrupts/interrupts-9.html">tasklet</a></li>
<li><a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/Theory/Paging.html">Paging</a></li>
<li><a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/mm/linux-mm-2.html">Previous part</a></li>
</ul>
</div>
<hr class="uk-article-divider">
<div class="uk-block uk-block-muted uk-padding-top-remove uk-padding-bottom-remove uk-margin-large-top  book-recommend-wrap">
<div class="uk-margin-top uk-margin-bottom uk-margin-left uk-margin-right">
<div class="uk-margin uk-text-muted "><i class="uk-icon-outdent uk-icon-justify uk-margin-small-right"></i>书籍推荐</div>
<div class="books">
<ul class="uk-book-list">
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/151/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/151/index.html">Shell脚本编程30分钟入门</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/83.html">qinjx</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">5页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年3月3日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 5224个">5224</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/181/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/181/index.html">命令行的艺术</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/101.html">jlevy</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">34页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年5月26日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 46710个">46710</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/195/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/195/index.html">Linux命令大全搜索工具</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/111.html">jaywcjlove</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">30页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2021年10月24日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 个"></span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/99/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/javascript_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/99/index.html">ECMAScript 6入门</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/60.html">likebeta</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="javascript">javascript</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">24页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年6月29日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 0个">0</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/168/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/machine-learning_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/168/index.html">AiLearning: 机器学习</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/18.html">ApacheCN</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="machine-learning">machine-learning</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">20页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年5月26日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 14197个">14197</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/149/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/git_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/149/index.html">Git Cheat Sheet 中文版</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/81.html">flyhigher139</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="git">git</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">1页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年3月3日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 642个">642</span>
</div>
</div>
</div>
</li>
<hr>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<nav class="tm-navbar uk-navbar uk-navbar-attached reader-nav">
<div class="uk-float-left uk-margin-small-top">
<a href="javascript:;" title="目录菜单" class="show-menu  uk-icon-hover  uk-icon-align-justify uk-margin-right"></a>
<div data-uk-dropdown="{mode:'click',pos:'bottom-left'}" class="font-setting-wrap">
<a class="uk-icon-hover uk-icon-font uk-margin-right" aria-label="字体设置" href="javascript:;"></a>
<div class="uk-dropdown dropdown-menu">
<div class="dropdown-caret"><span class="caret-outer"></span><span class="caret-inner"></span></div>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-reduce">小字</button>
<button class="uk-button-link button size-2 font-enlarge">大字</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-1 ">宋体</button>
<button class="uk-button-link button size-2 font-2 ">黑体</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-3 color-theme-sun "><i class="uk-icon-sun-o"></i>白天</button>
<button class="uk-button-link button size-3 color-theme-eye "><i class="uk-icon-eye"></i>护眼</button>
<button class="uk-button-link button size-3 color-theme-moon "><i class="uk-icon-moon-o"></i>夜晚</button></div>
</div>
</div>
<a class="logo uk-margin-right" href="../../../" title="返回首页"><img class="" src="../../../static/components/images/icon_32.png" /></a>
</div>
<div class="uk-navbar-flip  uk-hidden-small">
<div id="share-box"></div>
</div>
</nav>
<div id="menu-id" class="uk-offcanvas reader-offcanvas">
<div class="uk-offcanvas-bar">
<ul class="book-menu-bar uk-nav uk-nav-offcanvas" data-uk-nav>
<li>
<a href="../../../book/104/index.html" data-book-page-rel-url="index.html" data-book-page-id="0" title="封面">封面</a>
</li>
<li>
<a class="pjax" href="../../../book/104/readme.html" data-book-page-rel-url="readme.html" data-book-page-id="0" title="简介">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/README.html" title="简介" data-book-page-rel-url="README.html" data-book-page-id="7458">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/README.html" title="引导" data-book-page-rel-url="Booting/README.html" data-book-page-id="7459">引导</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-1.html" title="从引导加载程序内核" data-book-page-rel-url="Booting/linux-bootstrap-1.html" data-book-page-id="7460">从引导加载程序内核</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-2.html" title="在内核安装代码的第一步" data-book-page-rel-url="Booting/linux-bootstrap-2.html" data-book-page-id="7461">在内核安装代码的第一步</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-3.html" title="视频模式初始化和转换到保护模式" data-book-page-rel-url="Booting/linux-bootstrap-3.html" data-book-page-id="7462">视频模式初始化和转换到保护模式</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-4.html" title="过渡到 64 位模式" data-book-page-rel-url="Booting/linux-bootstrap-4.html" data-book-page-id="7463">过渡到 64 位模式</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Booting/linux-bootstrap-5.html" title="内核解压缩" data-book-page-rel-url="Booting/linux-bootstrap-5.html" data-book-page-id="7464">内核解压缩</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/README.html" title="初始化" data-book-page-rel-url="Initialization/README.html" data-book-page-id="7465">初始化</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-1.html" title="内核解压之后的首要步骤" data-book-page-rel-url="Initialization/linux-initialization-1.html" data-book-page-id="7466">内核解压之后的首要步骤</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-2.html" title="早期的中断和异常控制" data-book-page-rel-url="Initialization/linux-initialization-2.html" data-book-page-id="7467">早期的中断和异常控制</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-3.html" title="在到达内核入口之前最后的准备" data-book-page-rel-url="Initialization/linux-initialization-3.html" data-book-page-id="7468">在到达内核入口之前最后的准备</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-4.html" title="内核入口 - start_kernel" data-book-page-rel-url="Initialization/linux-initialization-4.html" data-book-page-id="7469">内核入口 - start_kernel</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-5.html" title="体系架构初始化" data-book-page-rel-url="Initialization/linux-initialization-5.html" data-book-page-id="7470">体系架构初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-6.html" title="进一步初始化指定体系架构" data-book-page-rel-url="Initialization/linux-initialization-6.html" data-book-page-id="7471">进一步初始化指定体系架构</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-7.html" title="最后对指定体系架构初始化" data-book-page-rel-url="Initialization/linux-initialization-7.html" data-book-page-id="7472">最后对指定体系架构初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-8.html" title="调度器初始化" data-book-page-rel-url="Initialization/linux-initialization-8.html" data-book-page-id="7473">调度器初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-9.html" title="RCU 初始化" data-book-page-rel-url="Initialization/linux-initialization-9.html" data-book-page-id="7474">RCU 初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Initialization/linux-initialization-10.html" title="初始化结束" data-book-page-rel-url="Initialization/linux-initialization-10.html" data-book-page-id="7475">初始化结束</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/README.html" title="中断" data-book-page-rel-url="Interrupts/README.html" data-book-page-id="7476">中断</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-1.html" title="中断和中断处理 Part 1." data-book-page-rel-url="Interrupts/interrupts-1.html" data-book-page-id="7477">中断和中断处理 Part 1.</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-2.html" title="深入 Linux 内核中的中断" data-book-page-rel-url="Interrupts/interrupts-2.html" data-book-page-id="7478">深入 Linux 内核中的中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-3.html" title="初步中断处理" data-book-page-rel-url="Interrupts/interrupts-3.html" data-book-page-id="7479">初步中断处理</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-4.html" title="中断处理" data-book-page-rel-url="Interrupts/interrupts-4.html" data-book-page-id="7480">中断处理</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-5.html" title="异常处理的实现" data-book-page-rel-url="Interrupts/interrupts-5.html" data-book-page-id="7481">异常处理的实现</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-6.html" title="处理不可屏蔽中断" data-book-page-rel-url="Interrupts/interrupts-6.html" data-book-page-id="7482">处理不可屏蔽中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-7.html" title="深入外部硬件中断" data-book-page-rel-url="Interrupts/interrupts-7.html" data-book-page-id="7483">深入外部硬件中断</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-8.html" title="IRQs的非早期初始化" data-book-page-rel-url="Interrupts/interrupts-8.html" data-book-page-id="7484">IRQs的非早期初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-9.html" title="Softirq, Tasklets and Workqueues" data-book-page-rel-url="Interrupts/interrupts-9.html" data-book-page-id="7485">Softirq, Tasklets and Workqueues</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Interrupts/interrupts-10.html" title="最后一部分" data-book-page-rel-url="Interrupts/interrupts-10.html" data-book-page-id="7486">最后一部分</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/README.html" title="系统调用" data-book-page-rel-url="SysCall/README.html" data-book-page-id="7487">系统调用</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-1.html" title="系统调用概念简介" data-book-page-rel-url="SysCall/syscall-1.html" data-book-page-id="7488">系统调用概念简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-2.html" title="Linux 内核如何处理系统调用" data-book-page-rel-url="SysCall/syscall-2.html" data-book-page-id="7489">Linux 内核如何处理系统调用</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-3.html" title="vsyscall and vDSO" data-book-page-rel-url="SysCall/syscall-3.html" data-book-page-id="7490">vsyscall and vDSO</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SysCall/syscall-4.html" title="Linux 内核如何运行程序" data-book-page-rel-url="SysCall/syscall-4.html" data-book-page-id="7491">Linux 内核如何运行程序</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/README.html" title="定时器和时钟管理" data-book-page-rel-url="Timers/README.html" data-book-page-id="7492">定时器和时钟管理</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-1.html" title="简介" data-book-page-rel-url="Timers/timers-1.html" data-book-page-id="7493">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-2.html" title="时钟源框架简介" data-book-page-rel-url="Timers/timers-2.html" data-book-page-id="7494">时钟源框架简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-3.html" title="The tick broadcast framework and dyntick" data-book-page-rel-url="Timers/timers-3.html" data-book-page-id="7495">The tick broadcast framework and dyntick</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-4.html" title="定时器介绍" data-book-page-rel-url="Timers/timers-4.html" data-book-page-id="7496">定时器介绍</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-5.html" title="Clockevents 框架简介" data-book-page-rel-url="Timers/timers-5.html" data-book-page-id="7497">Clockevents 框架简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-6.html" title="x86 相关的时钟源" data-book-page-rel-url="Timers/timers-6.html" data-book-page-id="7498">x86 相关的时钟源</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Timers/timers-7.html" title="Linux 内核中与时钟相关的系统调用" data-book-page-rel-url="Timers/timers-7.html" data-book-page-id="7499">Linux 内核中与时钟相关的系统调用</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/README.html" title="同步原语" data-book-page-rel-url="SyncPrim/README.html" data-book-page-id="7500">同步原语</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-1.html" title="自旋锁简介" data-book-page-rel-url="SyncPrim/sync-1.html" data-book-page-id="7501">自旋锁简介</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-2.html" title="队列自旋锁" data-book-page-rel-url="SyncPrim/sync-2.html" data-book-page-id="7502">队列自旋锁</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-3.html" title="信号量" data-book-page-rel-url="SyncPrim/sync-3.html" data-book-page-id="7503">信号量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-4.html" title="互斥锁" data-book-page-rel-url="SyncPrim/sync-4.html" data-book-page-id="7504">互斥锁</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-5.html" title="读者/写者信号量" data-book-page-rel-url="SyncPrim/sync-5.html" data-book-page-id="7505">读者/写者信号量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/SyncPrim/sync-6.html" title="顺序锁" data-book-page-rel-url="SyncPrim/sync-6.html" data-book-page-id="7506">顺序锁</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/README.html" title="内存管理" data-book-page-rel-url="MM/README.html" data-book-page-id="7508">内存管理</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-1.html" title="内存块" data-book-page-rel-url="MM/linux-mm-1.html" data-book-page-id="7509">内存块</a>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-2.html" title="固定映射地址和 ioremap" data-book-page-rel-url="MM/linux-mm-2.html" data-book-page-id="7510">固定映射地址和 ioremap</a>
</li>
<li>
<a class="pjax" href="../../../book/104/MM/linux-mm-3.html" title="kmemcheck" data-book-page-rel-url="MM/linux-mm-3.html" data-book-page-id="7511">kmemcheck</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/README.html" title="概念" data-book-page-rel-url="Concepts/README.html" data-book-page-id="7512">概念</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Concepts/per-cpu.html" title="每个 CPU 的变量" data-book-page-rel-url="Concepts/per-cpu.html" data-book-page-id="7513">每个 CPU 的变量</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/cpumask.html" title="CPU 掩码" data-book-page-rel-url="Concepts/cpumask.html" data-book-page-id="7514">CPU 掩码</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/initcall.html" title="initcall 机制" data-book-page-rel-url="Concepts/initcall.html" data-book-page-id="7515">initcall 机制</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Concepts/notification_chains.html" title="Linux 内核的通知链" data-book-page-rel-url="Concepts/notification_chains.html" data-book-page-id="7516">Linux 内核的通知链</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/README.html" title="Linux 内核中的数据结构" data-book-page-rel-url="DataStructures/README.html" data-book-page-id="7517">Linux 内核中的数据结构</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/DataStructures/dlist.html" title="双向链表" data-book-page-rel-url="DataStructures/dlist.html" data-book-page-id="7518">双向链表</a>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/radix-tree.html" title="基数树" data-book-page-rel-url="DataStructures/radix-tree.html" data-book-page-id="7519">基数树</a>
</li>
<li>
<a class="pjax" href="../../../book/104/DataStructures/bitmap.html" title="位数组" data-book-page-rel-url="DataStructures/bitmap.html" data-book-page-id="7520">位数组</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Theory/README.html" title="理论" data-book-page-rel-url="Theory/README.html" data-book-page-id="7521">理论</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Theory/Paging.html" title="分页" data-book-page-rel-url="Theory/Paging.html" data-book-page-id="7522">分页</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Theory/ELF.html" title="Elf64 格式" data-book-page-rel-url="Theory/ELF.html" data-book-page-id="7523">Elf64 格式</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/README.html" title="杂项" data-book-page-rel-url="Misc/README.html" data-book-page-id="7524">杂项</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/Misc/how_kernel_compiled.html" title="内核编译方法" data-book-page-rel-url="Misc/how_kernel_compiled.html" data-book-page-id="7525">内核编译方法</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/linkers.html" title="链接器" data-book-page-rel-url="Misc/linkers.html" data-book-page-id="7526">链接器</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/contribute.html" title="Linux 内核开发" data-book-page-rel-url="Misc/contribute.html" data-book-page-id="7527">Linux 内核开发</a>
</li>
<li>
<a class="pjax" href="../../../book/104/Misc/program_startup.html" title="用户空间的程序启动过程" data-book-page-rel-url="Misc/program_startup.html" data-book-page-id="7528">用户空间的程序启动过程</a>
</li>
<li>
<a class="pjax" href="../../../book/104/" title="Write and Submit your first Linux kernel Patch" data-book-page-rel-url="" data-book-page-id="7507">Write and Submit your first Linux kernel Patch</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/KernelStructures/README.html" title="内核数据结构" data-book-page-rel-url="KernelStructures/README.html" data-book-page-id="7529">内核数据结构</a>
<ul>
<li>
<a class="pjax" href="../../../book/104/KernelStructures/idt.html" title="中断描述符表" data-book-page-rel-url="KernelStructures/idt.html" data-book-page-id="7530">中断描述符表</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/104/LINKS.html" title="有帮助的链接" data-book-page-rel-url="LINKS.html" data-book-page-id="7531">有帮助的链接</a>
</li>
<li>
<a class="pjax" href="../../../book/104/contributors.html" title="贡献者" data-book-page-rel-url="contributors.html" data-book-page-id="7532">贡献者</a>
</li>
</ul>
</div>
</div>
<script src="https://cdn.staticfile.net/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript" src="../../../static/components/uikit-2.27.5/js/uikit.reader.js"></script>
<script type="text/javascript" src="../../../static/components/social-share/social-share.min.js"></script>
<script>(function(){var bp =document.createElement('script');var curProtocol =window.location.protocol.split(':')[0];if (curProtocol ==='https') {bp.src ='https://zz.bdstatic.com/linksubmit/push.js';}
else {bp.src ='http://push.zhanzhang.baidu.com/push.js';}
var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
<script src="https://cdn.staticfile.net/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.staticfile.net/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>
<script src="https://cdn.staticfile.net/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://cdn.staticfile.net/uikit/2.27.5/js/components/lightbox.min.js"></script>
<link rel="dns-prefetch" href="../../..//cdn.mathjax.org" />
<script type="text/x-mathjax-config">
 function initMathJax() {
    var mathId = $("book-content-section")[0];
    MathJax.Hub.Config({
        tex2jax: {skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code','a']},
        showProcessingMessages: false,
        messageStyle: "none"
    });
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,mathId]);
 };
initMathJax();
</script>
<script src='https://cdn.staticfile.net/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
<style>
	.MathJax_Display{display:inline!important;}
</style>
<script type="text/javascript" src="../../../static/components/js/reader.js"></script>
<script type="text/javascript">var bookId =104;var bookPageId =7511;var bookPageRelUrl ='MM/linux-mm-3.html';</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
</body>
</html>