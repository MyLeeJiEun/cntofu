
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<title>Laravel Database——Eloquent Model 模型关系加载与查询-Laravel 源码详解</title>
<meta content='Laravel Database——Eloquent Model 模型关系加载与查询,Laravel 源码详解' name='keywords'>
<meta content='Laravel Database——Eloquent Model 模型关系加载与查询,Laravel 源码详解' name='description'>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="zh-CN" />
<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=no"../../>
<meta name="applicable-device" content="pc,mobile">
<link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon" />
<meta name="renderer" content="webkit">
<link rel="stylesheet" href="../../static/components/uikit-2.27.5/css/uikit.custom.css">
<link rel="stylesheet" href="../../static/components/social-share/social-share.min.css">
<link rel="stylesheet" href="../../static/components/highlight/styles/custom.css">
<link rel="stylesheet" href="../../static/components/css/base.css">
<link rel="stylesheet" href="../../static/components/css/reader.css">
<link rel="stylesheet" href="../../static/components/css/markdown.css">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5313208362165053" crossorigin="anonymous"></script>
</head>
<body>
<div class=" book-main-wrap uk-container uk-container-center uk-margin-top ">
<div class="uk-grid">
<div class="uk-width-1-1 reader-wrap ">
<div class=" bottom-nav uk-clearfix ">
<div class="uk-align-left ">
<a href="../../book/107/Laravel%20Database——Eloquent%20Model%20关联源码分析.html">
<i class="nav-icon-left uk-icon-small  uk-icon-caret-left"></i>
<span class="">Laravel Dat..</span>
</a>
</div>
<div class="uk-align-right ">
<a href="../../book/107/Laravel%20Database——Eloquent%20Model%20更新关联模型.html">
<span class="">Laravel Dat..</span>
<i class="nav-icon-right uk-icon-small  uk-icon-caret-right"></i>
</a>
</div>
</div>
<div class="uk-text-center">
<h2 class="book-page-title uk-container-center">
<a href="../../book/107/index.html">Laravel 源码详解</a>
<a target="_blank" rel="nofollow" href="https://github.com/tzivanmoe/laravel-source-analysis" class="uk-icon-button uk-icon-github" title="github项目地址"></a>
</h2>
</div>
<script type="text/javascript" src="../../static/components/js/app_intro.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5313208362165053" data-ad-slot="1328047120"></ins>
<script>(adsbygoogle =window.adsbygoogle ||[]).push({});</script>
<hr class="uk-article-divider">
<div class="book-content-section  md-content-section  uk-margin-bottom">
<h1 id="laravel-databaseeloquent-model-模型关系加载与查询">Laravel Database——Eloquent Model 模型关系加载与查询</h1>
<h2 id="前言">前言</h2>
<p>我们在上一篇文章中介绍了模型关系的定义初始化，我们可以看到，在初始化的过程中 <code>laravel</code> 已经为各种关联关系的模型预先插入了初始的 <code>where</code> 条件。本文将会进一步介绍如何添加自定义的查询条件，如何加载、预加载关联模型。</p>
<h2 id="关联模型的加载">关联模型的加载</h2>
<p>当我们定义关联模型后：</p>
<pre><code class="language-php">class User extends Model
{
    /**
     * 获得与用户关联的电话记录。
     */
    public function phone()
    {
        $this-&gt;hasOne('App\Phone', 'user_id', 'id');
    }
}

</code></pre>
<p>我们可以像成员变量一样来获取与之关联的模型：</p>
<pre><code class="language-php">$user = App\User::find(1);

foreach ($user-&gt;posts as $post) {
    //
}
</code></pre>
<p>实际上，模型的属性获取函数的确可以加载关联模型：</p>
<pre><code class="language-php">public function getAttribute($key)
{
    if (! $key) {
        return;
    }

    ...

    return $this-&gt;getRelationValue($key);
}

</code></pre>
<p><code>getRelationValue</code> 函数专用于加载我们之前定义的关联模型：</p>
<pre><code class="language-php">public function getRelationValue($key)
{
    if ($this-&gt;relationLoaded($key)) {
        return $this-&gt;relations[$key];
    }

    if (method_exists($this, $key)) {
        return $this-&gt;getRelationshipFromMethod($key);
    }
}

public function relationLoaded($key)
{
    return array_key_exists($key, $this-&gt;relations);
}
</code></pre>
<p>可以看到，关联的加载带有缓存，<code>laravel</code> 首先会验证当前关联关系是否已经被加载，如果加载过，那么直接返回缓存结果。</p>
<pre><code class="language-php">protected function getRelationshipFromMethod($method)
{
    $relation = $this-&gt;$method();

    if (! $relation instanceof Relation) {
        throw new LogicException(get_class($this).'::'.$method.' must return a relationship instance.');
    }

    return tap($relation-&gt;getResults(), function ($results) use ($method) {
        $this-&gt;setRelation($method, $results);
    });
}

</code></pre>
<p>当我们调用 <code>$user-&gt;posts</code> 语句的时候，<code>laravel</code> 会调用 <code>posts</code> 函数，该函数开始定义关联关系，并且返回 <code>hasOne</code> 对象，在这里将会调用 <code>getResults</code> 函数来加载关联模型：</p>
<pre><code class="language-php"> public function getResults()
{
    return $this-&gt;query-&gt;first() ?: $this-&gt;getDefaultFor($this-&gt;parent);
}
</code></pre>
<p><code>getDefaultFor</code> 函数用于在未查询到任何关联模型时的情况。我们在定义关联的时候，可以提供默认的方法来控制返回的结果：</p>
<pre><code class="language-php">public function user()
{
    return $this-&gt;belongsTo('App\User')-&gt;withDefault();
}

public function user()
{
    return $this-&gt;belongsTo('App\User')-&gt;withDefault([
        'name' =&gt; '游客',
    ]);
}

public function user()
{
    return $this-&gt;belongsTo('App\User')-&gt;withDefault(function ($user) {
        $user-&gt;name = '游客';
    });
}

</code></pre>
<p><code>withDefault</code> 可以提供空值、数组、闭包函数等等选项，<code>getDefaultFor</code> 函数在关联没有查询到结果的时候，按要求返回一个模型：</p>
<pre><code class="language-php">public function withDefault($callback = true)
{
    $this-&gt;withDefault = $callback;

    return $this;
}

protected function getDefaultFor(Model $parent)
{
    if (! $this-&gt;withDefault) {
        return;
    }

    $instance = $this-&gt;newRelatedInstanceFor($parent);

    if (is_callable($this-&gt;withDefault)) {
        return call_user_func($this-&gt;withDefault, $instance) ?: $instance;
    }

    if (is_array($this-&gt;withDefault)) {
        $instance-&gt;forceFill($this-&gt;withDefault);
    }

    return $instance;
}
</code></pre>
<p>获取到关联模型后，就要放入缓存当中，以备后续情况使用：</p>
<pre><code class="language-php">public function setRelation($relation, $value)
{
    $this-&gt;relations[$relation] = $value;

    return $this;
}

</code></pre>
<h3 id="多对多关系的加载">多对多关系的加载</h3>
<p>多对多关系的加载与一对多等关系的加载有所不同，原因是不仅要加载 <code>related</code> 模型，还要加载中间表模型：</p>
<pre><code class="language-php">public function getResults()
{
    return $this-&gt;get();
}

public function get($columns = ['*'])
{
    $columns = $this-&gt;query-&gt;getQuery()-&gt;columns ? [] : $columns;

    $builder = $this-&gt;query-&gt;applyScopes();

    $models = $builder-&gt;addSelect(
        $this-&gt;shouldSelect($columns)
    )-&gt;getModels();

    $this-&gt;hydratePivotRelation($models);

    if (count($models) &gt; 0) {
        $models = $builder-&gt;eagerLoadRelations($models);
    }

    return $this-&gt;related-&gt;newCollection($models);
}
</code></pre>
<p><code>shouldSelect</code> 函数加载了中间表的字段属性：</p>
<pre><code class="language-php">protected function shouldSelect(array $columns = ['*'])
{
    if ($columns == ['*']) {
        $columns = [$this-&gt;related-&gt;getTable().'.*'];
    }

    return array_merge($columns, $this-&gt;aliasedPivotColumns());
}

protected function aliasedPivotColumns()
{
    $defaults = [$this-&gt;foreignPivotKey, $this-&gt;relatedPivotKey];

    return collect(array_merge($defaults, $this-&gt;pivotColumns))-&gt;map(function ($column) {
        return $this-&gt;table.'.'.$column.' as pivot_'.$column;
    })-&gt;unique()-&gt;all();
}
</code></pre>
<p>可以看到，这个时候，中间表的属性会被放入 <code>related</code> 模型中，并且会被赋予别名前缀 <code>pivot_</code>。</p>
<p>接着 <code>hydratePivotRelation</code> 会将这些中间表属性加载到中间表模型中：</p>
<pre><code class="language-php">protected function hydratePivotRelation(array $models)
{
    foreach ($models as $model) {
        $model-&gt;setRelation($this-&gt;accessor, $this-&gt;newExistingPivot(
            $this-&gt;migratePivotAttributes($model)
        ));
    }
}

protected function migratePivotAttributes(Model $model)
{
    $values = [];

    foreach ($model-&gt;getAttributes() as $key =&gt; $value) {
        if (strpos($key, 'pivot_') === 0) {
            $values[substr($key, 6)] = $value;

            unset($model-&gt;$key);
        }
    }

    return $values;
}
</code></pre>
<p><code>accessor</code> 默认值为 <code>pivot</code>，我们也可以在定义多对多的时候使用 <code>as</code> 函数为它取别名：</p>
<pre><code class="language-php">return $this-&gt;belongsToMany('App\Role')-&gt;as(‘role_user’);

</code></pre>
<p>源码：</p>
<pre><code class="language-php">public function as($accessor)
{
    $this-&gt;accessor = $accessor;

    return $this;
}
</code></pre>
<h2 id="关联模型的预加载">关联模型的预加载</h2>
<h3 id="with-函数">with 函数</h3>
<p>当作为属性访问 Eloquent 关联时，关联数据是「懒加载」的。意味着在你第一次访问该属性时，才会加载关联数据。不过，当你查询父模型时，Eloquent 还可以进行「预加载」关联数据。预加载避免了 N + 1 查询问题。</p>
<p>预加载可以一次操作中预加载关联模型并且自定义用于 <code>select</code> 的列，可以预加载几个不同的关联，还可以预加载嵌套关联，预加载关联数据的时候，为查询指定额外的约束条件：</p>
<pre><code class="language-php">$books = App\Book::with(['author:id,name'])-&gt;get();

$books = App\Book::with(['author', 'publisher'])-&gt;get();

$books = App\Book::with('author.contacts')-&gt;get();

$users = App\User::with(['posts' =&gt; function ($query) {
    $query-&gt;where('title', 'like', '%first%');
}])-&gt;get();
</code></pre>
<p>我们来看看 <code>with</code> 函数：</p>
<pre><code class="language-php">public static function with($relations)
{
    return (new static)-&gt;newQuery()-&gt;with(
        is_string($relations) ? func_get_args() : $relations
    );
}
</code></pre>
<p>预加载调用 <code>Eloquent/builder</code> 的 <code>with</code> 函数：</p>
<pre><code class="language-php">public function with($relations)
{
    $eagerLoad = $this-&gt;parseWithRelations(is_string($relations) ? func_get_args() : $relations);

    $this-&gt;eagerLoad = array_merge($this-&gt;eagerLoad, $eagerLoad);

    return $this;
}

</code></pre>
<p><code>eagerLoad</code> 成员变量用于存放预加载的关联关系，<code>parseWithRelations</code> 用于解析关联关系：</p>
<pre><code class="language-php">protected function parseWithRelations(array $relations)
{
    $results = [];

    foreach ($relations as $name =&gt; $constraints) {
        if (is_numeric($name)) {
            $name = $constraints;

            list($name, $constraints) = Str::contains($name, ':')
                        ? $this-&gt;createSelectWithConstraint($name)
                        : [$name, function () {
                            //
                        }];
        }

        $results = $this-&gt;addNestedWiths($name, $results);

        $results[$name] = $constraints;
    }

    return $results;
}

</code></pre>
<p>当我们在模型关系中写入 <code>:</code> 符合的时候，说明我们不想 <code>select *</code>，而是想要只查询特定的字段，<code>createSelectWithConstraint</code>:</p>
<pre><code class="language-php">protected function createSelectWithConstraint($name)
{
    return [explode(':', $name)[0], function ($query) use ($name) {
        $query-&gt;select(explode(',', explode(':', $name)[1]));
    }];
}

</code></pre>
<p>也就是为关联关系添加 <code>select</code> 条件。</p>
<p>当我们想要进行嵌套查询的时候，需要在关联关系中写下 <code>.</code>，<code>addNestedWiths</code> :</p>
<pre><code class="language-php">protected function addNestedWiths($name, $results)
{
    $progress = [];

    foreach (explode('.', $name) as $segment) {
        $progress[] = $segment;

        if (! isset($results[$last = implode('.', $progress)])) {
            $results[$last] = function () {
                //
            };
        }
    }

    return $results;
}

</code></pre>
<p>可以看到，<code>addNestedWiths</code> 为嵌套的模型关系赋予默认的空闭包函数，例如 <code>a.b.c</code>，<code>addNestedWiths</code> 返回的 <code>results</code> 数组中会有三个成员: <code>a</code>、<code>a.b</code>、<code>a.b.c</code>，这三个变量的闭包函数都是空。</p>
<p>接下来，<code>parseWithRelations</code> 为 <code>a.b.c</code> 的闭包函数重新赋值，将用户定义的约束条件赋予给 <code>a.b.c</code>。</p>
<h3 id="get-函数预加载">get 函数预加载</h3>
<p><code>with</code> 函数为 <code>laravel</code> 提供了需要预加载的关联关系，<code>get</code> 函数在从数据库中获取父模型的数据后，会将需要预加载的模型也一并取出来：</p>
<pre><code class="language-php">public function get($columns = ['*'])
{
    $builder = $this-&gt;applyScopes();

    if (count($models = $builder-&gt;getModels($columns)) &gt; 0) {
        $models = $builder-&gt;eagerLoadRelations($models);
    }

    return $builder-&gt;getModel()-&gt;newCollection($models);
}

</code></pre>
<p>顾名思义 <code>eagerLoadRelations</code> 函数就是获取预加载模型的的函数：</p>
<pre><code class="language-php">public function eagerLoadRelations(array $models)
{
    foreach ($this-&gt;eagerLoad as $name =&gt; $constraints) {
        // For nested eager loads we'll skip loading them here and they will be set as an
        // eager load on the query to retrieve the relation so that they will be eager
        // loaded on that query, because that is where they get hydrated as models.
        if (strpos($name, '.') === false) {
            $models = $this-&gt;eagerLoadRelation($models, $name, $constraints);
        }
    }

    return $models;
}

</code></pre>
<p>在这里，很让人费解的是 <code>if</code> 条件，这个条件语句看起来排除了嵌套预加载关系。例如上面的 <code>a.b.c</code>，<code>eagerLoadRelations</code> 只会加载 <code>a</code> 这个关联关系。其实原因是：</p>
<blockquote>
<p>// For nested eager loads we'll skip loading them here and they will be set as an eager load on the query to retrieve the relation so that they will be eager loaded on that query, because that is where they get hydrated as models.</p>
</blockquote>
<p>翻译过来就是说，嵌套预加载要一步一步的来，第一次只加载 <code>a</code>，获得了 <code>a</code> 的关联模型之后，第二次再加载 <code>b</code>，最后加载 <code>c</code>。这里看不懂没关系，答案在下面的代码中：</p>
<pre><code class="language-php">protected function eagerLoadRelation(array $models, $name, Closure $constraints)
{
    $relation = $this-&gt;getRelation($name);

    $relation-&gt;addEagerConstraints($models);

    $constraints($relation);

    return $relation-&gt;match(
        $relation-&gt;initRelation($models, $name),
        $relation-&gt;getEager(), $name
    );
}

</code></pre>
<p><code>eagerLoadRelation</code> 是预加载关联关系的核心，我们可以看到加载关联模型关系主要有四个步骤：</p>
<ul>
<li>通过关系名来调用 <code>hasOne</code> 等函数来加载模型关系 <code>relation</code></li>
<li>利用 <code>models</code> 来为模型关系添加约束条件</li>
<li>调用 <code>with</code> 函数附带的约束条件</li>
<li>从数据库获取关联模型并匹配到各个父模型中，作为父模型的属性</li>
</ul>
<p>我们先从调用关联函数 <code>getRelation</code> 来说：</p>
<h4 id="getrelation">getRelation</h4>
<pre><code class="language-php">public function getRelation($name)
{
    $relation = Relation::noConstraints(function () use ($name) {
        try {
            return $this-&gt;getModel()-&gt;{$name}();
        } catch (BadMethodCallException $e) {
            throw RelationNotFoundException::make($this-&gt;getModel(), $name);
        }
    });

    $nested = $this-&gt;relationsNestedUnder($name);

    if (count($nested) &gt; 0) {
        $relation-&gt;getQuery()-&gt;with($nested);
    }

    return $relation;
}
</code></pre>
<p>我们在上一个文章说过，<code>hasOne</code> 等函数会自动加约束条件例如：</p>
<pre><code class="language-php">
select phone where phone.user_id = user.id

</code></pre>
<p>但是这个约束条件并不适用于预加载，因为预加载的父模型通常不只只一个。因此需要调用函数 <code>noConstraints</code> 来避免加载约束条件:</p>
<pre><code class="language-php">public static function noConstraints(Closure $callback)
{
    $previous = static::$constraints;

    static::$constraints = false;

    try {
        return call_user_func($callback);
    } finally {
        static::$constraints = $previous;
    }
}

</code></pre>
<p>接下来，就要调用定义关联的函数：</p>
<pre><code class="language-php">return $this-&gt;getModel()-&gt;{$name}();
</code></pre>
<p>下面的 <code>relationsNestedUnder</code> 函数用于加载嵌套的预加载关联关系：</p>
<pre><code class="language-php">protected function relationsNestedUnder($relation)
{
    $nested = [];

    foreach ($this-&gt;eagerLoad as $name =&gt; $constraints) {
        if ($this-&gt;isNestedUnder($relation, $name)) {
            $nested[substr($name, strlen($relation.'.'))] = $constraints;
        }
    }

    return $nested;
}

protected function isNestedUnder($relation, $name)
{
    return Str::contains($name, '.') &amp;&amp; Str::startsWith($name, $relation.'.');
}
</code></pre>
<p>从代码上可以看出来，如果当前的模型关系是 <code>a</code>，<code>relationsNestedUnder</code> 函数会把其嵌套的关系都检测出来：<code>a.b</code>、<code>a.b.c</code>，并且放入 <code>nested</code> 数组中：<code>nested[b]、nested[b.c]</code>。</p>
<p>接下来：</p>
<pre><code class="language-php">if (count($nested) &gt; 0) {
    $relation-&gt;getQuery()-&gt;with($nested);
}
</code></pre>
<p>就会继续递归预加载关联关系。</p>
<h4 id="关联关系预加载约束条件">关联关系预加载约束条件</h4>
<p>获得关联关系之后，就要加载各个关联关系自己的预加载约束条件：</p>
<pre><code class="language-php">public function addEagerConstraints(array $models)
{
    $this-&gt;query-&gt;whereIn(
        $this-&gt;foreignKey, $this-&gt;getKeys($models, $this-&gt;localKey)
    );
}
</code></pre>
<p>也就是从父模型的外键来为关联模型添加 <code>where</code> 条件。当然各个关联关系不同，这个函数也有一定的区别。</p>
<h4 id="with-预加载约束条件">with 预加载约束条件</h4>
<p>接下来还有加载 <code>with</code> 函数的约束条件 ：</p>
<pre><code class="language-php">$constraints($relation);
</code></pre>
<h4 id="匹配父模型">匹配父模型</h4>
<p>当关联关系的约束条件都设置完毕后，就要从数据库中来获取关联模型：</p>
<pre><code class="language-php">$relation-&gt;match(
    $relation-&gt;initRelation($models, $name),
    $relation-&gt;getEager(), $name
);

public function getEager()
{
    return $this-&gt;get();
}
</code></pre>
<p><code>initRelation</code> 会为父模型设置默认的关联模型：</p>
<pre><code class="language-php">public function initRelation(array $models, $relation)
{
    foreach ($models as $model) {
        $model-&gt;setRelation($relation, $this-&gt;getDefaultFor($model));
    }

    return $models;
}
</code></pre>
<p>两步都做好了，接下来就要为父模型和子模型进行匹配了：</p>
<pre><code class="language-php">public function match(array $models, Collection $results, $relation)
{
    return $this-&gt;matchOne($models, $results, $relation);
}

public function matchOne(array $models, Collection $results, $relation)
{
    return $this-&gt;matchOneOrMany($models, $results, $relation, 'one');
}

protected function matchOneOrMany(array $models, Collection $results, $relation, $type)
{
    $dictionary = $this-&gt;buildDictionary($results);

    foreach ($models as $model) {
        if (isset($dictionary[$key = $model-&gt;getAttribute($this-&gt;localKey)])) {
            $model-&gt;setRelation(
                $relation, $this-&gt;getRelationValue($dictionary, $key, $type)
            );
        }
    }

    return $models;
}
</code></pre>
<p>匹配的过程分为两步：创建目录 <code>buildDictionary</code> 和设置子模型 <code>setRelation</code>：</p>
<pre><code class="language-php">protected function buildDictionary(Collection $results)
{
    $dictionary = [];

    $foreign = $this-&gt;getForeignKeyName();

    foreach ($results as $result) {
        $dictionary[$result-&gt;{$foreign}][] = $result;
    }

    return $dictionary;
}

</code></pre>
<p>创建目录 <code>buildDictionary</code> 函数根据子模型的外键 <code>foreign</code> 将子模型进行分类，拥有同一外键的子模型放入同一个数组中。</p>
<p>接下来，为父模型设置子模型：</p>
<pre><code class="language-php">foreach ($models as $model) {
    if (isset($dictionary[$key = $model-&gt;getAttribute($this-&gt;localKey)])) {
        $model-&gt;setRelation(
            $relation, $this-&gt;getRelationValue($dictionary, $key, $type)
        );
    }
}

protected function getRelationValue(array $dictionary, $key, $type)
{
    $value = $dictionary[$key];

    return $type == 'one' ? reset($value) : $this-&gt;related-&gt;newCollection($value);
}
</code></pre>
<p>如果目录 <code>dictionary</code> 中存在父模型的主键，就会从目录中取出对应的子模型数组，并利用 <code>setRelation</code> 来为父模型设置关联模型。</p>
<h2 id="关联模型的关联查询">关联模型的关联查询</h2>
<h3 id="基于存在的关联查询">基于存在的关联查询</h3>
<p>官方样例：</p>
<pre><code class="language-php">// 获得所有至少有一条评论的文章...
$posts = App\Post::has('comments')-&gt;get();

// 获得所有有三条或三条以上评论的文章...
$posts = Post::has('comments', '&gt;=', 3)-&gt;get();

// 获得所有至少有一条获赞评论的文章...
$posts = Post::has('comments.votes')-&gt;get();

// 获得所有至少有一条评论内容满足 foo% 条件的文章
$posts = Post::whereHas('comments', function ($query) {
    $query-&gt;where('content', 'like', 'foo%');
})-&gt;get();

</code></pre>
<p><code>has</code> 函数用于基于存在的关联查询：</p>
<pre><code class="language-php">public function has($relation, $operator = '&gt;=', $count = 1, $boolean = 'and', Closure $callback = null)
{
    if (strpos($relation, '.') !== false) {
        return $this-&gt;hasNested($relation, $operator, $count, $boolean, $callback);
    }

    $relation = $this-&gt;getRelationWithoutConstraints($relation);

    $method = $this-&gt;canUseExistsForExistenceCheck($operator, $count)
                    ? 'getRelationExistenceQuery'
                    : 'getRelationExistenceCountQuery';

    $hasQuery = $relation-&gt;{$method}(
        $relation-&gt;getRelated()-&gt;newQuery(), $this
    );

    if ($callback) {
        $hasQuery-&gt;callScope($callback);
    }

    return $this-&gt;addHasWhere(
        $hasQuery, $relation, $operator, $count, $boolean
    );
}

</code></pre>
<p><code>has</code> 函数的步骤：</p>
<ul>
<li>获取无约束的关联关系</li>
<li>为关联关系添加 <code>existence</code> 约束</li>
<li>为关联关系添加 <code>has</code> 外部约束</li>
<li>将关联关系添加到 <code>where</code> 条件中</li>
</ul>
<h4 id="无约束的关联关系">无约束的关联关系</h4>
<pre><code class="language-php">protected function getRelationWithoutConstraints($relation)
{
    return Relation::noConstraints(function () use ($relation) {
        return $this-&gt;getModel()-&gt;{$relation}();
    });
}
</code></pre>
<p>这个不用多说，和预加载的原理一样。</p>
<h4 id="existence-约束">existence 约束</h4>
<p>关系模型的 <code>existence</code> 约束条件很简单：</p>
<pre><code class="language-php">select * from post where user.id = post.user_id
</code></pre>
<p><code>laravel</code> 还考虑一种特殊情况，那就是自己关联自己，这个时候就会为模型命名一个新的 <code>hash</code>：</p>
<pre><code class="language-php">select * from user as wedfklk where user.id = wedfklk.foreignKey
</code></pre>
<p>源代码比较简单：</p>
<pre><code class="language-php">public function getRelationExistenceQuery(Builder $query, Builder $parentQuery, $columns = ['*'])
{
    if ($query-&gt;getQuery()-&gt;from == $parentQuery-&gt;getQuery()-&gt;from) {
        return $this-&gt;getRelationExistenceQueryForSelfRelation($query, $parentQuery, $columns);
    }

    return parent::getRelationExistenceQuery($query, $parentQuery, $columns);
}

public function getRelationExistenceQueryForSelfRelation(Builder $query, Builder $parentQuery, $columns = ['*'])
{
    $query-&gt;from($query-&gt;getModel()-&gt;getTable().' as '.$hash = $this-&gt;getRelationCountHash());

    $query-&gt;getModel()-&gt;setTable($hash);

    return $query-&gt;select($columns)-&gt;whereColumn(
        $this-&gt;getQualifiedParentKeyName(), '=', $hash.'.'.$this-&gt;getForeignKeyName()
    );
}

public function getRelationExistenceQuery(Builder $query, Builder $parentQuery, $columns = ['*'])
{
    return $query-&gt;select($columns)-&gt;whereColumn(
        $this-&gt;getQualifiedParentKeyName(), '=', $this-&gt;getExistenceCompareKey()
    );
}

public function getExistenceCompareKey()
{
    return $this-&gt;getQualifiedForeignKeyName();
}
</code></pre>
<h4 id="existencecount-约束">ExistenceCount 约束</h4>
<p><code>ExistenceCount</code> 约束只是 <code>select *</code> 变成了 <code>select count(*)</code>:</p>
<pre><code class="language-php">select count(*) from post where user.id = post.user_id
</code></pre>
<p>源代码：</p>
<pre><code class="language-php">public function getRelationExistenceCountQuery(Builder $query, Builder $parentQuery)
{
    return $this-&gt;getRelationExistenceQuery(
        $query, $parentQuery, new Expression('count(*)')
    );
}
</code></pre>
<h4 id="关联关系添加到-where-条件">关联关系添加到 <code>where</code> 条件</h4>
<p>当关联关系的 <code>存在</code> 约束设置完毕后，就要加载到父模型的 <code>where</code> 条件中，一般会作为父模型的子查询：</p>
<pre><code class="language-php">protected function addHasWhere(Builder $hasQuery, Relation $relation, $operator, $count, $boolean)
{
    $hasQuery-&gt;mergeConstraintsFrom($relation-&gt;getQuery());

    return $this-&gt;canUseExistsForExistenceCheck($operator, $count)
            ? $this-&gt;addWhereExistsQuery($hasQuery-&gt;toBase(), $boolean, $operator === '&lt;' &amp;&amp; $count === 1)
            : $this-&gt;addWhereCountQuery($hasQuery-&gt;toBase(), $operator, $count, $boolean);
}

public function addWhereExistsQuery(Builder $query, $boolean = 'and', $not = false)
{
    $type = $not ? 'NotExists' : 'Exists';

    $this-&gt;wheres[] = compact('type', 'operator', 'query', 'boolean');

    $this-&gt;addBinding($query-&gt;getBindings(), 'where');

    return $this;
}

protected function addWhereCountQuery(QueryBuilder $query, $operator = '&gt;=', $count = 1, $boolean = 'and')
{
    $this-&gt;query-&gt;addBinding($query-&gt;getBindings(), 'where');

    return $this-&gt;where(
        new Expression('('.$query-&gt;toSql().')'),
        $operator,
        is_numeric($count) ? new Expression($count) : $count,
        $boolean
    );
}
</code></pre>
<p><code>existence</code> 约束最后条件：</p>
<pre><code class="language-php">select * from user where exists (select * from phone where phone.user_id=user.id)

</code></pre>
<p><code>ExistenceCount</code> 约束:</p>
<pre><code class="language-php">select * from user where (select count(*) from phone where phone.user_id=user.id) &gt;= 3

</code></pre>
<h4 id="嵌套查询">嵌套查询</h4>
<p>嵌套查询需要进行递归来调用 <code>has</code> 函数：</p>
<pre><code class="language-php">protected function hasNested($relations, $operator = '&gt;=', $count = 1, $boolean = 'and', $callback = null)
{
    $relations = explode('.', $relations);

    $closure = function ($q) use (&amp;$closure, &amp;$relations, $operator, $count, $callback) {
        count($relations) &gt; 1
            ? $q-&gt;whereHas(array_shift($relations), $closure)
            : $q-&gt;has(array_shift($relations), $operator, $count, 'and', $callback);
    };

    return $this-&gt;has(array_shift($relations), '&gt;=', 1, $boolean, $closure);
}

public function whereHas($relation, Closure $callback = null, $operator = '&gt;=', $count = 1)
{
    return $this-&gt;has($relation, $operator, $count, 'and', $callback);
}

</code></pre>
<p>例如</p>
<pre><code class="language-php">$posts = Post::has('comments.votes')-&gt;get();
</code></pre>
<p>首先 <code>hasNested</code> 会返回：</p>
<pre><code class="language-php">$this-&gt;has('comments', '&gt;=', 1, 'and', function ($q) use (&amp;$closure, ‘votes’, '&gt;=', 1, $callback) {
        $q-&gt;has(‘votes’, '&gt;=', 1, 'and', $callback);
    }
);
</code></pre>
<p>生成的 sql:</p>
<pre><code class="language-php">select * from post where exist (select * from comment where comment.post_id=post.id and where exist (select * from vote where vote.comment_id=comment.id))

</code></pre>
<h3 id="基于不存在的关联查询">基于不存在的关联查询</h3>
<p>基于不存在的关联查询只是基于存在的关联查询</p>
<pre><code class="language-php">public function doesntHave($relation, $boolean = 'and', Closure $callback = null)
{
    return $this-&gt;has($relation, '&lt;', 1, $boolean, $callback);
}

public function whereDoesntHave($relation, Closure $callback = null)
{
    return $this-&gt;doesntHave($relation, 'and', $callback);
}
</code></pre>
<h3 id="关联数据计数">关联数据计数</h3>
<p>如果您只想统计结果数而不需要加载实际数据，那么可以使用 withCount 方法，此方法会在您的结果集模型中添加一个 {关联名}_count 字段。例如：</p>
<pre><code class="language-php">$posts = App\Post::withCount('comments')-&gt;get();
//select *,(select count(*) from comment where comment.post_id=post.id) as comments_count from post 

foreach ($posts as $post) {
    echo $post-&gt;comments_count;
}

//多个关联数据「计数」，并为其查询添加约束条件：
$posts = Post::withCount(['votes', 'comments' =&gt; function ($query) {
    $query-&gt;where('content', 'like', 'foo%');
}])-&gt;get();
//select *,(select count(*) from comment where comment.post_id=post.id and content like 'foo%') as comments_count,(select count(*) from votes where vote.post_id=post.id) as votes_count from post 

echo $posts[0]-&gt;votes_count;
echo $posts[0]-&gt;comments_count;

//可以为关联数据计数结果起别名，允许在同一个关联上多次计数：
$posts = Post::withCount([
    'comments',
    'comments as pending_comments_count' =&gt; function ($query) {
        $query-&gt;where('approved', false);
    }
])-&gt;get();
//select *,(select count(*) from comment where comment.post_id=post.id) as comments_count,(select count(*) from comment where comment.post_id=post.id and approved=false) as pending_comments_count from post

echo $posts[0]-&gt;comments_count;

echo $posts[0]-&gt;pending_comments_count;
</code></pre>
<p><code>withCount</code> 的源代码与 <code>has</code> 的代码高度相似：</p>
<pre><code class="language-php">public function withCount($relations)
{
    if (empty($relations)) {
        return $this;
    }

    if (is_null($this-&gt;query-&gt;columns)) {
        $this-&gt;query-&gt;select([$this-&gt;query-&gt;from.'.*']);
    }

    $relations = is_array($relations) ? $relations : func_get_args();

    foreach ($this-&gt;parseWithRelations($relations) as $name =&gt; $constraints) {
        $segments = explode(' ', $name);

        unset($alias);

        if (count($segments) == 3 &amp;&amp; Str::lower($segments[1]) == 'as') {
            list($name, $alias) = [$segments[0], $segments[2]];
        }

        $relation = $this-&gt;getRelationWithoutConstraints($name);

        $query = $relation-&gt;getRelationExistenceCountQuery(
            $relation-&gt;getRelated()-&gt;newQuery(), $this
        );

        $query-&gt;callScope($constraints);

        $query-&gt;mergeConstraintsFrom($relation-&gt;getQuery());

        $column = $alias ?? Str::snake($name.'_count');

        $this-&gt;selectSub($query-&gt;toBase(), $column);
    }

    return $this;
}

</code></pre>
<ul>
<li>解析关联关系名称</li>
<li>获取无约束的关联关系</li>
<li>为关联关系添加 <code>existenceCount</code> 约束</li>
<li>为关联关系添加 <code>with</code> 外部约束</li>
<li>将关联关系添加到 <code>where</code> 条件中</li>
<li>设置 <code>alias</code> 别名</li>
<li>创建 <code>select</code> 子查询</li>
</ul>
<h3 id="多对多关系的中间表查询">多对多关系的中间表查询</h3>
<pre><code class="language-php">return $this-&gt;belongsToMany('App\Role')-&gt;wherePivot('approved', 1);

return $this-&gt;belongsToMany('App\Role')-&gt;wherePivotIn('priority', [1, 2]);
</code></pre>
<pre><code class="language-php">public function wherePivot($column, $operator = null, $value = null, $boolean = 'and')
{
    $this-&gt;pivotWheres[] = func_get_args();

    return $this-&gt;where($this-&gt;table.'.'.$column, $operator, $value, $boolean);
}

public function wherePivotIn($column, $values, $boolean = 'and', $not = false)
{
    $this-&gt;pivotWhereIns[] = func_get_args();

    return $this-&gt;whereIn($this-&gt;table.'.'.$column, $values, $boolean, $not);
}
</code></pre>
<p>注意这里的 <code>pivotWheres</code> 与 <code>pivotWheres</code> 变量，这个变量在对中间表的加载中会被使用：</p>
<pre><code class="language-php">protected function newPivotQuery()
{
    $query = $this-&gt;newPivotStatement();

    foreach ($this-&gt;pivotWheres as $arguments) {
        call_user_func_array([$query, 'where'], $arguments);
    }

    foreach ($this-&gt;pivotWhereIns as $arguments) {
        call_user_func_array([$query, 'whereIn'], $arguments);
    }

    return $query-&gt;where($this-&gt;foreignPivotKey, $this-&gt;parent-&gt;{$this-&gt;parentKey});
}
</code></pre>
</div>
<hr class="uk-article-divider">
<div class="uk-block uk-block-muted uk-padding-top-remove uk-padding-bottom-remove uk-margin-large-top  book-recommend-wrap">
<div class="uk-margin-top uk-margin-bottom uk-margin-left uk-margin-right">
<div class="uk-margin uk-text-muted "><i class="uk-icon-outdent uk-icon-justify uk-margin-small-right"></i>书籍推荐</div>
<div class="books">
<ul class="uk-book-list">
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../book/59/index.html">
<img class="uk-book-cover" src="../../static/icons/48/tensorflow_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../book/59/index.html">TensorFlow 官方文档中文版</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../user/35.html">jikexueyuanwiki</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="tensorflow">tensorflow</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">33页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年6月5日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 8767个">8767</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../book/163/index.html">
<img class="uk-book-cover" src="../../static/icons/48/git_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../book/163/index.html">Git的奇技淫巧</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../user/92.html">jackfrued</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="git">git</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">77页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年5月26日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 28个">28</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../book/154/index.html">
<img class="uk-book-cover" src="../../static/icons/48/python_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../book/154/index.html">Python 学习总结</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../user/86.html">itroger</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="python">python</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">11页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年5月12日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 0个">0</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../book/140/index.html">
<img class="uk-book-cover" src="../../static/icons/48/haskell_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../book/140/index.html">HASKELL 趣學指南</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../user/73.html">MnO2</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="haskell">haskell</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">17页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2019年3月2日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 301个">301</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../book/197/index.html">
<img class="uk-book-cover" src="../../static/icons/48/ubuntu_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../book/197/index.html">手把手教你，搭建内网穿透服务</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../user/112.html">frank-lam</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="ubuntu">ubuntu</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">45页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2021年10月24日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 189个">189</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../book/111/index.html">
<img class="uk-book-cover" src="../../static/icons/48/kubernetes_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../book/111/index.html">和我一步步部署 kubernetes 集群</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../user/62.html">tzivanmoe</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="kubernetes">kubernetes</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">17页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年7月1日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 0个">0</span>
</div>
</div>
</div>
</li>
<hr>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<nav class="tm-navbar uk-navbar uk-navbar-attached reader-nav">
<div class="uk-float-left uk-margin-small-top">
<a href="javascript:;" title="目录菜单" class="show-menu  uk-icon-hover  uk-icon-align-justify uk-margin-right"></a>
<div data-uk-dropdown="{mode:'click',pos:'bottom-left'}" class="font-setting-wrap">
<a class="uk-icon-hover uk-icon-font uk-margin-right" aria-label="字体设置" href="javascript:;"></a>
<div class="uk-dropdown dropdown-menu">
<div class="dropdown-caret"><span class="caret-outer"></span><span class="caret-inner"></span></div>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-reduce">小字</button>
<button class="uk-button-link button size-2 font-enlarge">大字</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-1 ">宋体</button>
<button class="uk-button-link button size-2 font-2 ">黑体</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-3 color-theme-sun "><i class="uk-icon-sun-o"></i>白天</button>
<button class="uk-button-link button size-3 color-theme-eye "><i class="uk-icon-eye"></i>护眼</button>
<button class="uk-button-link button size-3 color-theme-moon "><i class="uk-icon-moon-o"></i>夜晚</button></div>
</div>
</div>
<a class="logo uk-margin-right" href="../../" title="返回首页"><img class="" src="../../static/components/images/icon_32.png" /></a>
</div>
<div class="uk-navbar-flip  uk-hidden-small">
<div id="share-box"></div>
</div>
</nav>
<div id="menu-id" class="uk-offcanvas reader-offcanvas">
<div class="uk-offcanvas-bar">
<ul class="book-menu-bar uk-nav uk-nav-offcanvas" data-uk-nav>
<li>
<a href="../../book/107/index.html" data-book-page-rel-url="index.html" data-book-page-id="0" title="封面">封面</a>
</li>
<li>
<a class="pjax" href="../../book/107/readme.html" data-book-page-rel-url="readme.html" data-book-page-id="0" title="简介">简介</a>
</li>
<li>
<a class="pjax" href="../../book/107/README.html" title="Introduction" data-book-page-rel-url="README.html" data-book-page-id="7730">Introduction</a>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="PHP Composer 自动加载" disabled data-book-page-rel-url="" data-book-page-id="7731">PHP Composer 自动加载</a>
<ul>
<li>
<a class="pjax" href="../../book/107/PHP%20Composer——自动加载原理.html" title="PHP Composer——自动加载原理" data-book-page-rel-url="PHP%20Composer——自动加载原理.html" data-book-page-id="7732">PHP Composer——自动加载原理</a>
</li>
<li>
<a class="pjax" href="../../book/107/PHP%20Composer——%20初始化源码分析.html" title="PHP Composer—— 初始化源码分析" data-book-page-rel-url="PHP%20Composer——%20初始化源码分析.html" data-book-page-id="7733">PHP Composer—— 初始化源码分析</a>
</li>
<li>
<a class="pjax" href="../../book/107/PHP%20Composer-——-注册与运行源码分析.html" title="PHP Composer-——-注册与运行源码分析" data-book-page-rel-url="PHP%20Composer-——-注册与运行源码分析.html" data-book-page-id="7734">PHP Composer-——-注册与运行源码分析</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Facade 门面" disabled data-book-page-rel-url="" data-book-page-id="7735">Laravel Facade 门面</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Facade——Facade%20门面源码分析.html" title="Laravel Facade——Facade 门面源码分析" data-book-page-rel-url="Laravel%20Facade——Facade%20门面源码分析.html" data-book-page-id="7736">Laravel Facade——Facade 门面源码分析</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Ioc 容器" disabled data-book-page-rel-url="" data-book-page-id="7737">Laravel Ioc 容器</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Container——IoC%20服务容器.html" title="Laravel Container——IoC 服务容器" data-book-page-rel-url="Laravel%20Container——IoC%20服务容器.html" data-book-page-id="7738">Laravel Container——IoC 服务容器</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Container——IoC%20服务容器源码解析%28服务器绑定%29.html" title="Laravel Container——IoC 服务容器源码解析(服务器绑定)" data-book-page-rel-url="Laravel%20Container——IoC%20服务容器源码解析%28服务器绑定%29.html" data-book-page-id="7739">Laravel Container——IoC 服务容器源码解析(服务器绑定)</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Container——IoC%20服务容器源码解析%28服务器解析%29.html" title="Laravel Container——IoC 服务容器源码解析(服务器解析)" data-book-page-rel-url="Laravel%20Container——IoC%20服务容器源码解析%28服务器解析%29.html" data-book-page-id="7740">Laravel Container——IoC 服务容器源码解析(服务器解析)</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Container——服务容器的细节特性.html" title="Laravel Container——服务容器的细节特性" data-book-page-rel-url="Laravel%20Container——服务容器的细节特性.html" data-book-page-id="7741">Laravel Container——服务容器的细节特性</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Route 路由" disabled data-book-page-rel-url="" data-book-page-id="7742">Laravel Route 路由</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20HTTP——路由.html" title="Laravel HTTP——路由" data-book-page-rel-url="Laravel%20HTTP——路由.html" data-book-page-id="7743">Laravel HTTP——路由</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20HTTP——路由加载源码分析.html" title="Laravel HTTP——路由加载源码分析" data-book-page-rel-url="Laravel%20HTTP——路由加载源码分析.html" data-book-page-id="7744">Laravel HTTP——路由加载源码分析</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20HTTP——Pipeline中间件处理源码分析.html" title="Laravel HTTP——Pipeline中间件处理源码分析" data-book-page-rel-url="Laravel%20HTTP——Pipeline中间件处理源码分析.html" data-book-page-id="7745">Laravel HTTP——Pipeline中间件处理源码分析</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20HTTP——路由的正则编译.html" title="Laravel HTTP——路由的正则编译" data-book-page-rel-url="Laravel%20HTTP——路由的正则编译.html" data-book-page-id="7746">Laravel HTTP——路由的正则编译</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20HTTP——路由的匹配与参数绑定.html" title="Laravel HTTP——路由的匹配与参数绑定" data-book-page-rel-url="Laravel%20HTTP——路由的匹配与参数绑定.html" data-book-page-id="7747">Laravel HTTP——路由的匹配与参数绑定</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20HTTP——路由中间件源码分析.html" title="Laravel HTTP——路由中间件源码分析" data-book-page-rel-url="Laravel%20HTTP——路由中间件源码分析.html" data-book-page-id="7748">Laravel HTTP——路由中间件源码分析</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20HTTP——SubstituteBindings%20参数绑定中间件的使用与源码解析.html" title="Laravel HTTP——SubstituteBindings 参数绑定中间件的使用与源码解析" data-book-page-rel-url="Laravel%20HTTP——SubstituteBindings%20参数绑定中间件的使用与源码解析.html" data-book-page-id="7749">Laravel HTTP——SubstituteBindings 参数绑定中间件的使用与源码解析</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20HTTP——控制器方法的参数构建与运行.html" title="Laravel HTTP——控制器方法的参数构建与运行" data-book-page-rel-url="Laravel%20HTTP——控制器方法的参数构建与运行.html" data-book-page-id="7750">Laravel HTTP——控制器方法的参数构建与运行</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20HTTP——%20RESTFul%20风格路由的使用与源码分析.html" title="Laravel HTTP—— RESTFul 风格路由的使用与源码分析" data-book-page-rel-url="Laravel%20HTTP——%20RESTFul%20风格路由的使用与源码分析.html" data-book-page-id="7751">Laravel HTTP—— RESTFul 风格路由的使用与源码分析</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20HTTP——重定向的使用与源码分析.html" title="Laravel HTTP——重定向的使用与源码分析" data-book-page-rel-url="Laravel%20HTTP——重定向的使用与源码分析.html" data-book-page-id="7752">Laravel HTTP——重定向的使用与源码分析</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel ENV 环境变量" disabled data-book-page-rel-url="" data-book-page-id="7753">Laravel ENV 环境变量</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20ENV——%20环境变量的加载与源码解析.html" title="Laravel ENV—— 环境变量的加载与源码解析" data-book-page-rel-url="Laravel%20ENV——%20环境变量的加载与源码解析.html" data-book-page-id="7754">Laravel ENV—— 环境变量的加载与源码解析</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Config 配置文件" disabled data-book-page-rel-url="" data-book-page-id="7755">Laravel Config 配置文件</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Config——%20配置文件的加载与源码解析.html" title="Laravel Config—— 配置文件的加载与源码解析" data-book-page-rel-url="Laravel%20Config——%20配置文件的加载与源码解析.html" data-book-page-id="7756">Laravel Config—— 配置文件的加载与源码解析</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Exceptions 异常处理" disabled data-book-page-rel-url="" data-book-page-id="7757">Laravel Exceptions 异常处理</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Exceptions——异常与错误处理.html" title="Laravel Exceptions——异常与错误处理.html" data-book-page-rel-url="Laravel%20Exceptions——异常与错误处理.html" data-book-page-id="7758">Laravel Exceptions——异常与错误处理.html</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Providers 服务提供者" disabled data-book-page-rel-url="" data-book-page-id="7759">Laravel Providers 服务提供者</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Providers——服务提供者的注册与启动源码解析.html" title="Laravel Providers——服务提供者的注册与启动源码解析" data-book-page-rel-url="Laravel%20Providers——服务提供者的注册与启动源码解析.html" data-book-page-id="7760">Laravel Providers——服务提供者的注册与启动源码解析</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Database 数据库" disabled data-book-page-rel-url="" data-book-page-id="7761">Laravel Database 数据库</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——数据库服务的启动与连接.html" title="Laravel Database——数据库服务的启动与连接" data-book-page-rel-url="Laravel%20Database——数据库服务的启动与连接.html" data-book-page-id="7762">Laravel Database——数据库服务的启动与连接</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——数据库的%20CRUD%20操作.html" title="Laravel Database——数据库的 CRUD 操作" data-book-page-rel-url="Laravel%20Database——数据库的%20CRUD%20操作.html" data-book-page-id="7763">Laravel Database——数据库的 CRUD 操作</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——查询构造器与语法编译器源码分析%28上%29.html" title="Laravel Database——查询构造器与语法编译器源码分析(上)" data-book-page-rel-url="Laravel%20Database——查询构造器与语法编译器源码分析%28上%29.html" data-book-page-id="7764">Laravel Database——查询构造器与语法编译器源码分析(上)</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——查询构造器与语法编译器源码分析%28中%29.html" title="Laravel Database——查询构造器与语法编译器源码分析(中)" data-book-page-rel-url="Laravel%20Database——查询构造器与语法编译器源码分析%28中%29.html" data-book-page-id="7765">Laravel Database——查询构造器与语法编译器源码分析(中)</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——查询构造器与语法编译器源码分析%28下%29.html" title="Laravel Database——查询构造器与语法编译器源码分析(下)" data-book-page-rel-url="Laravel%20Database——查询构造器与语法编译器源码分析%28下%29.html" data-book-page-id="7766">Laravel Database——查询构造器与语法编译器源码分析(下)</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——分页原理与源码分析.html" title="Laravel Database——分页原理与源码分析" data-book-page-rel-url="Laravel%20Database——分页原理与源码分析.html" data-book-page-id="7767">Laravel Database——分页原理与源码分析</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——Eloquent%20Model%20源码分析%28上%29.html" title="Laravel Database——Eloquent Model 源码分析(上)" data-book-page-rel-url="Laravel%20Database——Eloquent%20Model%20源码分析%28上%29.html" data-book-page-id="7768">Laravel Database——Eloquent Model 源码分析(上)</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——Eloquent%20Model%20源码分析（下）.html" title="Laravel Database——Eloquent Model 源码分析（下）" data-book-page-rel-url="Laravel%20Database——Eloquent%20Model%20源码分析（下）.html" data-book-page-id="7769">Laravel Database——Eloquent Model 源码分析（下）</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——Eloquent%20Model%20关联源码分析.html" title="Laravel Database——Eloquent Model 关联源码分析" data-book-page-rel-url="Laravel%20Database——Eloquent%20Model%20关联源码分析.html" data-book-page-id="7770">Laravel Database——Eloquent Model 关联源码分析</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——Eloquent%20Model%20模型关系加载与查询.html" title="Laravel Database——Eloquent Model 模型关系加载与查询" data-book-page-rel-url="Laravel%20Database——Eloquent%20Model%20模型关系加载与查询.html" data-book-page-id="7771">Laravel Database——Eloquent Model 模型关系加载与查询</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Database——Eloquent%20Model%20更新关联模型.html" title="Laravel Database——Eloquent Model 更新关联模型" data-book-page-rel-url="Laravel%20Database——Eloquent%20Model%20更新关联模型.html" data-book-page-id="7772">Laravel Database——Eloquent Model 更新关联模型</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Session" disabled data-book-page-rel-url="" data-book-page-id="7773">Laravel Session</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Session——session%20的启动与运行源码分析.html" title="Laravel Session——session 的启动与运行源码分析" data-book-page-rel-url="Laravel%20Session——session%20的启动与运行源码分析.html" data-book-page-id="7774">Laravel Session——session 的启动与运行源码分析</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Event 事件系统" disabled data-book-page-rel-url="" data-book-page-id="7775">Laravel Event 事件系统</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Event——事件系统的启动与运行源码分析.html" title="Laravel Event——事件系统的启动与运行源码分析" data-book-page-rel-url="Laravel%20Event——事件系统的启动与运行源码分析.html" data-book-page-id="7776">Laravel Event——事件系统的启动与运行源码分析</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Queue 队列" disabled data-book-page-rel-url="" data-book-page-id="7777">Laravel Queue 队列</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Queue——消息队列任务与分发源码剖析.html" title="Laravel Queue——消息队列任务与分发源码剖析" data-book-page-rel-url="Laravel%20Queue——消息队列任务与分发源码剖析.html" data-book-page-id="7778">Laravel Queue——消息队列任务与分发源码剖析</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Queue——消息队列任务处理器源码剖析.html" title="Laravel Queue——消息队列任务处理器源码剖析" data-book-page-rel-url="Laravel%20Queue——消息队列任务处理器源码剖析.html" data-book-page-id="7779">Laravel Queue——消息队列任务处理器源码剖析</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel 广播系统" disabled data-book-page-rel-url="" data-book-page-id="7780">Laravel 广播系统</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Broadcast——广播系统源码剖析.html" title="Laravel Broadcast——广播系统源码剖析" data-book-page-rel-url="Laravel%20Broadcast——广播系统源码剖析.html" data-book-page-id="7781">Laravel Broadcast——广播系统源码剖析</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Laravel Passport" disabled data-book-page-rel-url="" data-book-page-id="7782">Laravel Passport</a>
<ul>
<li>
<a class="pjax" href="../../book/107/Laravel%20Passport——OAuth2%20API%20认证系统源码解析.html" title="Laravel Passport——OAuth2 API 认证系统源码解析" data-book-page-rel-url="Laravel%20Passport——OAuth2%20API%20认证系统源码解析.html" data-book-page-id="7783">Laravel Passport——OAuth2 API 认证系统源码解析</a>
</li>
<li>
<a class="pjax" href="../../book/107/Laravel%20Passport——OAuth2%20API%20认证系统源码解析（下）.html" title="Laravel Passport——OAuth2 API 认证系统源码解析(下)" data-book-page-rel-url="Laravel%20Passport——OAuth2%20API%20认证系统源码解析（下）.html" data-book-page-id="7784">Laravel Passport——OAuth2 API 认证系统源码解析(下)</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
<script src="https://cdn.staticfile.net/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript" src="../../static/components/uikit-2.27.5/js/uikit.reader.js"></script>
<script type="text/javascript" src="../../static/components/social-share/social-share.min.js"></script>
<script>(function(){var bp =document.createElement('script');var curProtocol =window.location.protocol.split(':')[0];if (curProtocol ==='https') {bp.src ='https://zz.bdstatic.com/linksubmit/push.js';}
else {bp.src ='http://push.zhanzhang.baidu.com/push.js';}
var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
<script src="https://cdn.staticfile.net/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.staticfile.net/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>
<script src="https://cdn.staticfile.net/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://cdn.staticfile.net/uikit/2.27.5/js/components/lightbox.min.js"></script>
<link rel="dns-prefetch" href="../..//cdn.mathjax.org" />
<script type="text/x-mathjax-config">
 function initMathJax() {
    var mathId = $("book-content-section")[0];
    MathJax.Hub.Config({
        tex2jax: {skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code','a']},
        showProcessingMessages: false,
        messageStyle: "none"
    });
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,mathId]);
 };
initMathJax();
</script>
<script src='https://cdn.staticfile.net/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
<style>
	.MathJax_Display{display:inline!important;}
</style>
<script type="text/javascript" src="../../static/components/js/reader.js"></script>
<script type="text/javascript">var bookId =107;var bookPageId =7771;var bookPageRelUrl ='Laravel%20Database——Eloquent%20Model%20模型关系加载与查询.html';</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
</body>
</html>