
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<title>异常处理的实现-Linux 内核揭密</title>
<meta content='异常处理的实现,Linux 内核揭密' name='keywords'>
<meta content='异常处理的实现,Linux 内核揭密' name='description'>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="zh-CN" />
<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=no"../../../>
<meta name="applicable-device" content="pc,mobile">
<link rel="shortcut icon" href="../../../favicon.ico" type="image/x-icon" />
<meta name="renderer" content="webkit">
<link rel="stylesheet" href="../../../static/components/uikit-2.27.5/css/uikit.custom.css">
<link rel="stylesheet" href="../../../static/components/social-share/social-share.min.css">
<link rel="stylesheet" href="../../../static/components/highlight/styles/custom.css">
<link rel="stylesheet" href="../../../static/components/css/base.css">
<link rel="stylesheet" href="../../../static/components/css/reader.css">
<link rel="stylesheet" href="../../../static/components/css/markdown.css">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5313208362165053" crossorigin="anonymous"></script>
</head>
<body>
<div class=" book-main-wrap uk-container uk-container-center uk-margin-top ">
<div class="uk-grid">
<div class="uk-width-1-1 reader-wrap ">
<div class=" bottom-nav uk-clearfix ">
<div class="uk-align-left ">
<a href="../../../book/114/Interrupts/interrupts-4.html">
<i class="nav-icon-left uk-icon-small  uk-icon-caret-left"></i>
<span class="">中断处理</span>
</a>
</div>
<div class="uk-align-right ">
<a href="../../../book/114/Interrupts/interrupts-6.html">
<span class="">处理不可屏蔽中断</span>
<i class="nav-icon-right uk-icon-small  uk-icon-caret-right"></i>
</a>
</div>
</div>
<div class="uk-text-center">
<h2 class="book-page-title uk-container-center">
<a href="../../../book/114/index.html">Linux 内核揭密</a>
<a target="_blank" rel="nofollow" href="https://github.com/tzivanmoe/linux-insides-zh" class="uk-icon-button uk-icon-github" title="github项目地址"></a>
</h2>
</div>
<script type="text/javascript" src="../../../static/components/js/app_intro.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5313208362165053" data-ad-slot="1328047120"></ins>
<script>(adsbygoogle =window.adsbygoogle ||[]).push({});</script>
<hr class="uk-article-divider">
<div class="book-content-section  md-content-section  uk-margin-bottom">
<h1 id="interrupts-and-interrupt-handling-part-5">Interrupts and Interrupt Handling. Part 5.</h1>
<h2 id="implementation-of-exception-handlers">Implementation of exception handlers</h2>
<p>This is the fifth part about an interrupts and exceptions handling in the Linux kernel and in the previous <a href="http://0xax.gitbooks.io/linux-insides/content/interrupts/interrupts-4.html">part</a> we stopped on the setting of interrupt gates to the <a href="https://en.wikipedia.org/wiki/Interrupt_descriptor_table">Interrupt descriptor Table</a>. We did it in the <code>trap_init</code> function from the <a href="https://github.com/torvalds/linux/tree/master/arch/x86/kernel/traps.c">arch/x86/kernel/traps.c</a> source code file. We saw only setting of these interrupt gates in the previous part and in the current part we will see implementation of the exception handlers for these gates. The preparation before an exception handler will be executed is in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/entry/entry_64.S">arch/x86/entry/entry_64.S</a> assembly file and occurs in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/entry/entry_64.S#L820">idtentry</a> macro that defines exceptions entry points:</p>
<pre><code class="language-assembly">idtentry divide_error			        do_divide_error			       has_error_code=0
idtentry overflow			            do_overflow			           has_error_code=0
idtentry invalid_op			            do_invalid_op			       has_error_code=0
idtentry bounds				            do_bounds			           has_error_code=0
idtentry device_not_available		    do_device_not_available		   has_error_code=0
idtentry coprocessor_segment_overrun	do_coprocessor_segment_overrun has_error_code=0
idtentry invalid_TSS			        do_invalid_TSS			       has_error_code=1
idtentry segment_not_present		    do_segment_not_present		   has_error_code=1
idtentry spurious_interrupt_bug		    do_spurious_interrupt_bug	   has_error_code=0
idtentry coprocessor_error		        do_coprocessor_error		   has_error_code=0
idtentry alignment_check		        do_alignment_check		       has_error_code=1
idtentry simd_coprocessor_error		    do_simd_coprocessor_error	   has_error_code=0
</code></pre>
<p>The <code>idtentry</code> macro does following preparation before an actual exception handler (<code>do_divide_error</code> for the <code>divide_error</code>, <code>do_overflow</code> for the <code>overflow</code> and etc.) will get control. In another words the <code>idtentry</code> macro allocates place for the registers (<a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/include/uapi/asm/ptrace.h#L43">pt_regs</a> structure) on the stack, pushes dummy error code for the stack consistency if an interrupt/exception has no error code, checks the segment selector in the <code>cs</code> segment register and switches depends on the previous state(userspace or kernelspace). After all of these preparations it makes a call of an actual interrupt/exception handler:</p>
<pre><code class="language-assembly">.macro idtentry sym do_sym has_error_code:req paranoid=0 shift_ist=-1
ENTRY(\sym)
	...
	...
	...
	call	\do_sym
	...
	...
	...
END(\sym)
.endm
</code></pre>
<p>After an exception handler will finish its work, the <code>idtentry</code> macro restores stack and general purpose registers of an interrupted task and executes <a href="http://x86.renejeschke.de/html/file_module_x86_id_145.html">iret</a> instruction:</p>
<pre><code class="language-assembly">ENTRY(paranoid_exit)
	...
	...
	...
	RESTORE_EXTRA_REGS
	RESTORE_C_REGS
	REMOVE_PT_GPREGS_FROM_STACK 8
	INTERRUPT_RETURN
END(paranoid_exit)
</code></pre>
<p>where <code>INTERRUPT_RETURN</code> is:</p>
<pre><code class="language-assembly">#define INTERRUPT_RETURN	jmp native_iret
...
ENTRY(native_iret)
.global native_irq_return_iret
native_irq_return_iret:
iretq
</code></pre>
<p>More about the <code>idtentry</code> macro you can read in the third part of the <a href="http://0xax.gitbooks.io/linux-insides/content/interrupts/interrupts-3.html">http://0xax.gitbooks.io/linux-insides/content/interrupts/interrupts-3.html</a> chapter. Ok, now we saw the preparation before an exception handler will be executed and now time to look on the handlers. First of all let's look on the following handlers:</p>
<ul>
<li>divide_error</li>
<li>overflow</li>
<li>invalid_op</li>
<li>coprocessor_segment_overrun</li>
<li>invalid_TSS</li>
<li>segment_not_present</li>
<li>stack_segment</li>
<li>alignment_check</li>
</ul>
<p>All these handlers defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/kernel/traps.c">arch/x86/kernel/traps.c</a> source code file with the <code>DO_ERROR</code> macro:</p>
<pre><code class="language-C">DO_ERROR(X86_TRAP_DE,     SIGFPE,  "divide error",                divide_error)
DO_ERROR(X86_TRAP_OF,     SIGSEGV, "overflow",                    overflow)
DO_ERROR(X86_TRAP_UD,     SIGILL,  "invalid opcode",              invalid_op)
DO_ERROR(X86_TRAP_OLD_MF, SIGFPE,  "coprocessor segment overrun", coprocessor_segment_overrun)
DO_ERROR(X86_TRAP_TS,     SIGSEGV, "invalid TSS",                 invalid_TSS)
DO_ERROR(X86_TRAP_NP,     SIGBUS,  "segment not present",         segment_not_present)
DO_ERROR(X86_TRAP_SS,     SIGBUS,  "stack segment",               stack_segment)
DO_ERROR(X86_TRAP_AC,     SIGBUS,  "alignment check",             alignment_check)
</code></pre>
<p>As we can see the <code>DO_ERROR</code> macro takes 4 parameters:</p>
<ul>
<li>Vector number of an interrupt;</li>
<li>Signal number which will be sent to the interrupted process;</li>
<li>String which describes an exception;</li>
<li>Exception handler entry point.</li>
</ul>
<p>This macro defined in the same source code file and expands to the function with the <code>do_handler</code> name:</p>
<pre><code class="language-C">#define DO_ERROR(trapnr, signr, str, name)                              \
dotraplinkage void do_##name(struct pt_regs *regs, long error_code)     \
{                                                                       \
        do_error_trap(regs, error_code, str, trapnr, signr);            \
}
</code></pre>
<p>Note on the <code>##</code> tokens. This is special feature - <a href="https://gcc.gnu.org/onlinedocs/cpp/Concatenation.html#Concatenation">GCC macro Concatenation</a> which concatenates two given strings. For example, first <code>DO_ERROR</code> in our example will expands to the:</p>
<pre><code class="language-C">dotraplinkage void do_divide_error(struct pt_regs *regs, long error_code)     \
{
	...
}
</code></pre>
<p>We can see that all functions which are generated by the <code>DO_ERROR</code> macro just make a call of the <code>do_error_trap</code> function from the <a href="https://github.com/torvalds/linux/tree/master/arch/x86/kernel/traps.c">arch/x86/kernel/traps.c</a>. Let's look on implementation of the <code>do_error_trap</code> function.</p>
<h2 id="trap-handlers">Trap handlers</h2>
<p>The <code>do_error_trap</code> function starts and ends from the two following functions:</p>
<pre><code class="language-C">enum ctx_state prev_state = exception_enter();
...
...
...
exception_exit(prev_state);
</code></pre>
<p>from the <a href="https://github.com/torvalds/linux/tree/master/include/linux/context_tracking.h">include/linux/context_tracking.h</a>. The context tracking in the Linux kernel subsystem which provide kernel boundaries probes to keep track of the transitions between level contexts with two basic initial contexts: <code>user</code> or <code>kernel</code>. The <code>exception_enter</code> function checks that context tracking is enabled. After this if it is enabled, the <code>exception_enter</code> reads previous context and compares it with the <code>CONTEXT_KERNEL</code>. If the previous context is <code>user</code>, we call <code>context_tracking_exit</code> function from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/kernel/context_tracking.c">kernel/context_tracking.c</a> which inform the context tracking subsystem that a processor is exiting user mode and entering the kernel mode:</p>
<pre><code class="language-C">if (!context_tracking_is_enabled())
	return 0;

prev_ctx = this_cpu_read(context_tracking.state);
if (prev_ctx != CONTEXT_KERNEL)
	context_tracking_exit(prev_ctx);

return prev_ctx;
</code></pre>
<p>If previous context is non <code>user</code>, we just return it. The <code>pre_ctx</code> has <code>enum ctx_state</code> type which defined in the <a href="https://github.com/torvalds/linux/tree/master/include/linux/context_tracking_state.h">include/linux/context_tracking_state.h</a> and looks as:</p>
<pre><code class="language-C">enum ctx_state {
	CONTEXT_KERNEL = 0,
	CONTEXT_USER,
	CONTEXT_GUEST,
} state;
</code></pre>
<p>The second function is <code>exception_exit</code> defined in the same <a href="https://github.com/torvalds/linux/tree/master/include/linux/context_tracking.h">include/linux/context_tracking.h</a> file and checks that context tracking is enabled and call the <code>contert_tracking_enter</code> function if the previous context was <code>user</code>:</p>
<pre><code class="language-C">static inline void exception_exit(enum ctx_state prev_ctx)
{
	if (context_tracking_is_enabled()) {
		if (prev_ctx != CONTEXT_KERNEL)
			context_tracking_enter(prev_ctx);
	}
}
</code></pre>
<p>The <code>context_tracking_enter</code> function informs the context tracking subsystem that a processor is going to enter to the user mode from the kernel mode. We can see the following code between the <code>exception_enter</code> and <code>exception_exit</code>:</p>
<pre><code class="language-C">if (notify_die(DIE_TRAP, str, regs, error_code, trapnr, signr) !=
		NOTIFY_STOP) {
	conditional_sti(regs);
	do_trap(trapnr, signr, str, regs, error_code,
		fill_trap_info(regs, signr, trapnr, &amp;info));
}
</code></pre>
<p>First of all it calls the <code>notify_die</code> function which defined in the <a href="https://github.com/torvalds/linux/tree/master/kernel/notifier.c">kernel/notifier.c</a>. To get notified for <a href="https://en.wikipedia.org/wiki/Kernel_panic">kernel panic</a>, <a href="https://en.wikipedia.org/wiki/Linux_kernel_oops">kernel oops</a>, <a href="https://en.wikipedia.org/wiki/Non-maskable_interrupt">Non-Maskable Interrupt</a> or other events the caller needs to insert itself in the <code>notify_die</code> chain and the <code>notify_die</code> function does it. The Linux kernel has special mechanism that allows kernel to ask when something happens and this mechanism called <code>notifiers</code> or <code>notifier chains</code>. This mechanism used for example for the <code>USB</code> hotplug events (look on the <a href="https://github.com/torvalds/linux/tree/master/drivers/usb/core/notify.c">drivers/usb/core/notify.c</a>), for the memory <a href="https://en.wikipedia.org/wiki/Hot_swapping">hotplug</a> (look on the <a href="https://github.com/torvalds/linux/tree/master/include/linux/memory.h">include/linux/memory.h</a>, the <code>hotplug_memory_notifier</code> macro and etc...), system reboots and etc. A notifier chain is thus a simple, singly-linked list. When a Linux kernel subsystem wants to be notified of specific events, it fills out a special <code>notifier_block</code> structure and passes it to the <code>notifier_chain_register</code> function. An event can be sent with the call of the <code>notifier_call_chain</code> function. First of all the <code>notify_die</code> function fills <code>die_args</code> structure with the trap number, trap string, registers and other values:</p>
<pre><code class="language-C">struct die_args args = {
       .regs   = regs,
       .str    = str,
       .err    = err,
       .trapnr = trap,
       .signr  = sig,
}
</code></pre>
<p>and returns the result of the <code>atomic_notifier_call_chain</code> function with the <code>die_chain</code>:</p>
<pre><code class="language-C">static ATOMIC_NOTIFIER_HEAD(die_chain);
return atomic_notifier_call_chain(&amp;die_chain, val, &amp;args);
</code></pre>
<p>which just expands to the <code>atomic_notifier_head</code> structure that contains lock and <code>notifier_block</code>:</p>
<pre><code class="language-C">struct atomic_notifier_head {
        spinlock_t lock;
        struct notifier_block __rcu *head;
};
</code></pre>
<p>The <code>atomic_notifier_call_chain</code> function calls each function in a notifier chain in turn and returns the value of the last notifier function called. If the <code>notify_die</code> in the <code>do_error_trap</code> does not return <code>NOTIFY_STOP</code> we execute <code>conditional_sti</code> function from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/kernel/traps.c">arch/x86/kernel/traps.c</a> that checks the value of the <a href="https://en.wikipedia.org/wiki/Interrupt_flag">interrupt flag</a> and enables interrupt depends on it:</p>
<pre><code class="language-C">static inline void conditional_sti(struct pt_regs *regs)
{
        if (regs-&gt;flags &amp; X86_EFLAGS_IF)
                local_irq_enable();
}
</code></pre>
<p>more about <code>local_irq_enable</code> macro you can read in the second <a href="http://0xax.gitbooks.io/linux-insides/content/interrupts/interrupts-2.html">part</a> of this chapter. The next and last call in the <code>do_error_trap</code> is the <code>do_trap</code> function. First of all the <code>do_trap</code> function defined the <code>tsk</code> variable which has <code>task_struct</code> type and represents the current interrupted process. After the definition of the <code>tsk</code>, we can see the call of the <code>do_trap_no_signal</code> function:</p>
<pre><code class="language-C">struct task_struct *tsk = current;

if (!do_trap_no_signal(tsk, trapnr, str, regs, error_code))
	return;
</code></pre>
<p>The <code>do_trap_no_signal</code> function makes two checks:</p>
<ul>
<li>Did we come from the <a href="https://en.wikipedia.org/wiki/Virtual_8086_mode">Virtual 8086</a> mode;</li>
<li>Did we come from the kernelspace.</li>
</ul>
<pre><code class="language-C">if (v8086_mode(regs)) {
	...
}

if (!user_mode(regs)) {
	...
}

return -1;
</code></pre>
<p>We will not consider first case because the <a href="https://en.wikipedia.org/wiki/Long_mode">long mode</a> does not support the <a href="https://en.wikipedia.org/wiki/Virtual_8086_mode">Virtual 8086</a> mode. In the second case we invoke <code>fixup_exception</code> function which will try to recover a fault and <code>die</code> if we can't:</p>
<pre><code class="language-C">if (!fixup_exception(regs)) {
	tsk-&gt;thread.error_code = error_code;
	tsk-&gt;thread.trap_nr = trapnr;
	die(str, regs, error_code);
}
</code></pre>
<p>The <code>die</code> function defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/kernel/dumpstack.c">arch/x86/kernel/dumpstack.c</a> source code file, prints useful information about stack, registers, kernel modules and caused kernel <a href="https://en.wikipedia.org/wiki/Linux_kernel_oops">oops</a>. If we came from the userspace the <code>do_trap_no_signal</code> function will return <code>-1</code> and the execution of the <code>do_trap</code> function will continue. If we passed through the <code>do_trap_no_signal</code> function and did not exit from the <code>do_trap</code> after this, it means that previous context was - <code>user</code>. Most exceptions caused by the processor are interpreted by Linux as error conditions, for example division by zero, invalid opcode and etc. When an exception occurs the Linux kernel sends a <a href="https://en.wikipedia.org/wiki/Unix_signal">signal</a> to the interrupted process that caused the exception to notify it of an incorrect condition. So, in the <code>do_trap</code> function we need to send a signal with the given number (<code>SIGFPE</code> for the divide error, <code>SIGILL</code> for the overflow exception and etc...). First of all we save error code and vector number in the current interrupts process with the filling <code>thread.error_code</code> and <code>thread_trap_nr</code>:</p>
<pre><code class="language-C">tsk-&gt;thread.error_code = error_code;
tsk-&gt;thread.trap_nr = trapnr;
</code></pre>
<p>After this we make a check do we need to print information about unhandled signals for the interrupted process. We check that <code>show_unhandled_signals</code> variable is set, that <code>unhandled_signal</code> function from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/kernel/signal.c">kernel/signal.c</a> will return unhandled signal(s) and <a href="https://en.wikipedia.org/wiki/Printk">printk</a> rate limit:</p>
<pre><code class="language-C">#ifdef CONFIG_X86_64
	if (show_unhandled_signals &amp;&amp; unhandled_signal(tsk, signr) &amp;&amp;
	    printk_ratelimit()) {
		pr_info("%s[%d] trap %s ip:%lx sp:%lx error:%lx",
			tsk-&gt;comm, tsk-&gt;pid, str,
			regs-&gt;ip, regs-&gt;sp, error_code);
		print_vma_addr(" in ", regs-&gt;ip);
		pr_cont("\n");
	}
#endif
</code></pre>
<p>And send a given signal to interrupted process:</p>
<pre><code class="language-C">force_sig_info(signr, info ?: SEND_SIG_PRIV, tsk);
</code></pre>
<p>This is the end of the <code>do_trap</code>. We just saw generic implementation for eight different exceptions which are defined with the <code>DO_ERROR</code> macro. Now let's look on another exception handlers.</p>
<h2 id="double-fault">Double fault</h2>
<p>The next exception is <code>#DF</code> or <code>Double fault</code>. This exception occurs when the processor detected a second exception while calling an exception handler for a prior exception. We set the trap gate for this exception in the previous part:</p>
<pre><code class="language-C">set_intr_gate_ist(X86_TRAP_DF, &amp;double_fault, DOUBLEFAULT_STACK);
</code></pre>
<p>Note that this exception runs on the <code>DOUBLEFAULT_STACK</code> <a href="https://www.kernel.org/doc/Documentation/x86/x86_64/kernel-stacks">Interrupt Stack Table</a> which has index - <code>1</code>:</p>
<pre><code class="language-C">#define DOUBLEFAULT_STACK 1
</code></pre>
<p>The <code>double_fault</code> is handler for this exception and defined in the <a href="https://github.com/torvalds/linux/tree/master/arch/x86/kernel/traps.c">arch/x86/kernel/traps.c</a>. The <code>double_fault</code> handler starts from the definition of two variables: string that describes exception and interrupted process, as other exception handlers:</p>
<pre><code class="language-C">static const char str[] = "double fault";
struct task_struct *tsk = current;
</code></pre>
<p>The handler of the double fault exception split on two parts. The first part is the check which checks that a fault is a <code>non-IST</code> fault on the <code>espfix64</code> stack. Actually the <code>iret</code> instruction restores only the bottom <code>16</code> bits when returning to a <code>16</code> bit segment. The <code>espfix</code> feature solves this problem. So if the <code>non-IST</code> fault on the espfix64 stack we modify the stack to make it look like <code>General Protection Fault</code>:</p>
<pre><code class="language-C">struct pt_regs *normal_regs = task_pt_regs(current);

memmove(&amp;normal_regs-&gt;ip, (void *)regs-&gt;sp, 5*8);
ormal_regs-&gt;orig_ax = 0;
regs-&gt;ip = (unsigned long)general_protection;
regs-&gt;sp = (unsigned long)&amp;normal_regs-&gt;orig_ax;
return;
</code></pre>
<p>In the second case we do almost the same that we did in the previous exception handlers. The first is the call of the <code>ist_enter</code> function that discards previous context, <code>user</code> in our case:</p>
<pre><code class="language-C">ist_enter(regs);
</code></pre>
<p>And after this we fill the interrupted process with the vector number of the <code>Double fault</code> exception and error code as we did it in the previous handlers:</p>
<pre><code class="language-C">tsk-&gt;thread.error_code = error_code;
tsk-&gt;thread.trap_nr = X86_TRAP_DF;
</code></pre>
<p>Next we print useful information about the double fault (<a href="https://en.wikipedia.org/wiki/Process_identifier">PID</a> number, registers content):</p>
<pre><code class="language-C">#ifdef CONFIG_DOUBLEFAULT
	df_debug(regs, error_code);
#endif
</code></pre>
<p>And die:</p>
<pre><code>	for (;;)
		die(str, regs, error_code);
</code></pre>
<p>That's all.</p>
<h2 id="device-not-available-exception-handler">Device not available exception handler</h2>
<p>The next exception is the <code>#NM</code> or <code>Device not available</code>. The <code>Device not available</code> exception can occur depending on these things:</p>
<ul>
<li>The processor executed an <a href="https://en.wikipedia.org/wiki/X87">x87 FPU</a> floating-point instruction while the EM flag in <a href="https://en.wikipedia.org/wiki/Control_register">control register</a> <code>cr0</code> was set;</li>
<li>The processor executed a <code>wait</code> or <code>fwait</code> instruction while the <code>MP</code> and <code>TS</code> flags of register <code>cr0</code> were set;</li>
<li>The processor executed an <a href="https://en.wikipedia.org/wiki/X87">x87 FPU</a>, <a href="https://en.wikipedia.org/wiki/MMX_%28instruction_set%29">MMX</a> or <a href="https://en.wikipedia.org/wiki/Streaming_SIMD_Extensions">SSE</a> instruction while the <code>TS</code> flag in control register <code>cr0</code> was set and the <code>EM</code> flag is clear.</li>
</ul>
<p>The handler of the <code>Device not available</code> exception is the <code>do_device_not_available</code> function and it defined in the <a href="https://github.com/torvalds/linux/tree/master/arch/x86/kernel/traps.c">arch/x86/kernel/traps.c</a> source code file too. It starts and ends from the getting of the previous context, as other traps which we saw in the beginning of this part:</p>
<pre><code class="language-C">enum ctx_state prev_state;
prev_state = exception_enter();
...
...
...
exception_exit(prev_state);
</code></pre>
<p>In the next step we check that <code>FPU</code> is not eager:</p>
<pre><code class="language-C">BUG_ON(use_eager_fpu());
</code></pre>
<p>When we switch into a task or interrupt we may avoid loading the <code>FPU</code> state. If a task will use it, we catch <code>Device not Available exception</code> exception. If we loading the <code>FPU</code> state during task switching, the <code>FPU</code> is eager. In the next step we check <code>cr0</code> control register on the <code>EM</code> flag which can show us is <code>x87</code> floating point unit present (flag clear) or not (flag set):</p>
<pre><code class="language-C">#ifdef CONFIG_MATH_EMULATION
	if (read_cr0() &amp; X86_CR0_EM) {
		struct math_emu_info info = { };

		conditional_sti(regs);

		info.regs = regs;
		math_emulate(&amp;info);
		exception_exit(prev_state);
		return;
	}
#endif
</code></pre>
<p>If the <code>x87</code> floating point unit not presented, we enable interrupts with the <code>conditional_sti</code>, fill the <code>math_emu_info</code> (defined in the <a href="https://github.com/torvalds/linux/tree/master/arch/x86/include/asm/math_emu.h">arch/x86/include/asm/math_emu.h</a>) structure with the registers of an interrupt task and call <code>math_emulate</code> function from the <a href="https://github.com/torvalds/linux/tree/master/arch/x86/math-emu/fpu_entry.c">arch/x86/math-emu/fpu_entry.c</a>. As you can understand from function's name, it emulates <code>X87 FPU</code> unit (more about the <code>x87</code> we will know in the special chapter). In other way, if <code>X86_CR0_EM</code> flag is clear which means that <code>x87 FPU</code> unit is presented, we call the <code>fpu__restore</code> function from the <a href="https://github.com/torvalds/linux/tree/master/arch/x86/kernel/fpu/core.c">arch/x86/kernel/fpu/core.c</a> which copies the <code>FPU</code> registers from the <code>fpustate</code> to the live hardware registers. After this <code>FPU</code> instructions can be used:</p>
<pre><code class="language-C">fpu__restore(&amp;current-&gt;thread.fpu);
</code></pre>
<h2 id="general-protection-fault-exception-handler">General protection fault exception handler</h2>
<p>The next exception is the <code>#GP</code> or <code>General protection fault</code>. This exception occurs when the processor detected one of a class of protection violations called <code>general-protection violations</code>. It can be:</p>
<ul>
<li>Exceeding the segment limit when accessing the <code>cs</code>, <code>ds</code>, <code>es</code>, <code>fs</code> or <code>gs</code> segments;</li>
<li>Loading the <code>ss</code>, <code>ds</code>, <code>es</code>, <code>fs</code> or <code>gs</code> register with a segment selector for a system segment.;</li>
<li>Violating any of the privilege rules;</li>
<li>and other...</li>
</ul>
<p>The exception handler for this exception is the <code>do_general_protection</code> from the <a href="https://github.com/torvalds/linux/tree/master/arch/x86/kernel/traps.c">arch/x86/kernel/traps.c</a>. The <code>do_general_protection</code> function starts and ends as other exception handlers from the getting of the previous context:</p>
<pre><code class="language-C">prev_state = exception_enter();
...
exception_exit(prev_state);
</code></pre>
<p>After this we enable interrupts if they were disabled and check that we came from the <a href="https://en.wikipedia.org/wiki/Virtual_8086_mode">Virtual 8086</a> mode:</p>
<pre><code class="language-C">conditional_sti(regs);

if (v8086_mode(regs)) {
	local_irq_enable();
	handle_vm86_fault((struct kernel_vm86_regs *) regs, error_code);
	goto exit;
}
</code></pre>
<p>As long mode does not support this mode, we will not consider exception handling for this case. In the next step check that previous mode was kernel mode and try to fix the trap. If we can't fix the current general protection fault exception we fill the interrupted process with the vector number and error code of the exception and add it to the <code>notify_die</code> chain:</p>
<pre><code class="language-C">if (!user_mode(regs)) {
	if (fixup_exception(regs))
		goto exit;

	tsk-&gt;thread.error_code = error_code;
	tsk-&gt;thread.trap_nr = X86_TRAP_GP;
	if (notify_die(DIE_GPF, "general protection fault", regs, error_code,
		       X86_TRAP_GP, SIGSEGV) != NOTIFY_STOP)
		die("general protection fault", regs, error_code);
	goto exit;
}
</code></pre>
<p>If we can fix exception we go to the <code>exit</code> label which exits from exception state:</p>
<pre><code class="language-C">exit:
	exception_exit(prev_state);
</code></pre>
<p>If we came from user mode we send <code>SIGSEGV</code> signal to the interrupted process from user mode as we did it in the <code>do_trap</code> function:</p>
<pre><code class="language-C">if (show_unhandled_signals &amp;&amp; unhandled_signal(tsk, SIGSEGV) &amp;&amp;
		printk_ratelimit()) {
	pr_info("%s[%d] general protection ip:%lx sp:%lx error:%lx",
		tsk-&gt;comm, task_pid_nr(tsk),
		regs-&gt;ip, regs-&gt;sp, error_code);
	print_vma_addr(" in ", regs-&gt;ip);
	pr_cont("\n");
}

force_sig_info(SIGSEGV, SEND_SIG_PRIV, tsk);
</code></pre>
<p>That's all.</p>
<h2 id="conclusion">Conclusion</h2>
<p>It is the end of the fifth part of the <a href="http://0xax.gitbooks.io/linux-insides/content/interrupts/index.html">Interrupts and Interrupt Handling</a> chapter and we saw implementation of some interrupt handlers in this part. In the next part we will continue to dive into interrupt and exception handlers and will see handler for the <a href="https://en.wikipedia.org/wiki/Non-maskable_interrupt">Non-Maskable Interrupts</a>, handling of the math <a href="https://en.wikipedia.org/wiki/Coprocessor">coprocessor</a> and <a href="https://en.wikipedia.org/wiki/SIMD">SIMD</a> coprocessor exceptions and many many more.</p>
<p>If you have any questions or suggestions write me a comment or ping me at <a href="https://twitter.com/0xAX">twitter</a>.</p>
<p><strong>Please note that English is not my first language, And I am really sorry for any inconvenience. If you find any mistakes please send me PR to <a href="https://github.com/0xAX/linux-insides">linux-insides</a>.</strong></p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Interrupt_descriptor_table">Interrupt descriptor Table</a></li>
<li><a href="http://x86.renejeschke.de/html/file_module_x86_id_145.html">iret instruction</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/cpp/Concatenation.html#Concatenation">GCC macro Concatenation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Kernel_panic">kernel panic</a></li>
<li><a href="https://en.wikipedia.org/wiki/Linux_kernel_oops">kernel oops</a></li>
<li><a href="https://en.wikipedia.org/wiki/Non-maskable_interrupt">Non-Maskable Interrupt</a></li>
<li><a href="https://en.wikipedia.org/wiki/Hot_swapping">hotplug</a></li>
<li><a href="https://en.wikipedia.org/wiki/Interrupt_flag">interrupt flag</a></li>
<li><a href="https://en.wikipedia.org/wiki/Long_mode">long mode</a></li>
<li><a href="https://en.wikipedia.org/wiki/Unix_signal">signal</a></li>
<li><a href="https://en.wikipedia.org/wiki/Printk">printk</a></li>
<li><a href="https://en.wikipedia.org/wiki/Coprocessor">coprocessor</a></li>
<li><a href="https://en.wikipedia.org/wiki/SIMD">SIMD</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/x86/x86_64/kernel-stacks">Interrupt Stack Table</a></li>
<li><a href="https://en.wikipedia.org/wiki/Process_identifier">PID</a></li>
<li><a href="https://en.wikipedia.org/wiki/X87">x87 FPU</a></li>
<li><a href="https://en.wikipedia.org/wiki/Control_register">control register</a></li>
<li><a href="https://en.wikipedia.org/wiki/MMX_%28instruction_set%29">MMX</a></li>
<li><a href="http://0xax.gitbooks.io/linux-insides/content/interrupts/interrupts-4.html">Previous part</a></li>
</ul>
</div>
<hr class="uk-article-divider">
<div class="uk-block uk-block-muted uk-padding-top-remove uk-padding-bottom-remove uk-margin-large-top  book-recommend-wrap">
<div class="uk-margin-top uk-margin-bottom uk-margin-left uk-margin-right">
<div class="uk-margin uk-text-muted "><i class="uk-icon-outdent uk-icon-justify uk-margin-small-right"></i>书籍推荐</div>
<div class="books">
<ul class="uk-book-list">
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/104/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/104/index.html">Linux 内核揭密</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/63.html">ye11ow</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">83页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年6月29日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 0个">0</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/46/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/46/index.html">软件开发平台及语言笔记大全(超详细)</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/22.html">jasonblog</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="android">android</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="java">java</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="cplusplus">cplusplus</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="python">python</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">1,399页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年5月30日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 16个">16</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/28/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/28/index.html">笨办法学 Linux</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/15.html">wizardforcel</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">34页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年5月3日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 326个">326</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/120/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/spark_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/120/index.html">Openstack用户指南（简体中文版）</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/62.html">tzivanmoe</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="spark">spark</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">47页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年7月1日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 0个">0</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/37/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/android_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/37/index.html">安卓逆向系列教程</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/15.html">wizardforcel</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="android">android</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">20页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2018年5月3日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 87个">87</span>
</div>
</div>
</div>
</li>
<hr>
<li>
<div class="uk-book-item">
<div class="uk-book-header uk-clearfix">
<a href="../../../book/195/index.html">
<img class="uk-book-cover" src="../../../static/icons/48/linux_48.png" height="48px" alt="">
</a>
<h4 class="uk-book-title uk-margin-small-bottom"><a href="../../../book/195/index.html">Linux命令大全搜索工具</a></h4>
<div class="uk-book-meta  uk-text-middle uk-float-left">
<a class="uk-margin-small-right  uk-text-middle user-name " href="../../../user/111.html">jaywcjlove</a>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-badge uk-badge-notification  book-subject" title="linux">linux</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">30页</span>
<span class="uk-margin-small-right  uk-text-middle">•</span>
<span class="uk-margin-small-right  uk-text-middle">2021年10月24日</span>
</div>
<div class="uk-book-tip uk-float-right  uk-text-middle">
<span class="uk-badge uk-badge-notification" title="github star 个"></span>
</div>
</div>
</div>
</li>
<hr>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<nav class="tm-navbar uk-navbar uk-navbar-attached reader-nav">
<div class="uk-float-left uk-margin-small-top">
<a href="javascript:;" title="目录菜单" class="show-menu  uk-icon-hover  uk-icon-align-justify uk-margin-right"></a>
<div data-uk-dropdown="{mode:'click',pos:'bottom-left'}" class="font-setting-wrap">
<a class="uk-icon-hover uk-icon-font uk-margin-right" aria-label="字体设置" href="javascript:;"></a>
<div class="uk-dropdown dropdown-menu">
<div class="dropdown-caret"><span class="caret-outer"></span><span class="caret-inner"></span></div>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-reduce">小字</button>
<button class="uk-button-link button size-2 font-enlarge">大字</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-2 font-1 ">宋体</button>
<button class="uk-button-link button size-2 font-2 ">黑体</button>
</div>
<hr>
<div class="buttons uk-clearfix">
<button class="uk-button-link button size-3 color-theme-sun "><i class="uk-icon-sun-o"></i>白天</button>
<button class="uk-button-link button size-3 color-theme-eye "><i class="uk-icon-eye"></i>护眼</button>
<button class="uk-button-link button size-3 color-theme-moon "><i class="uk-icon-moon-o"></i>夜晚</button></div>
</div>
</div>
<a class="logo uk-margin-right" href="../../../" title="返回首页"><img class="" src="../../../static/components/images/icon_32.png" /></a>
</div>
<div class="uk-navbar-flip  uk-hidden-small">
<div id="share-box"></div>
</div>
</nav>
<div id="menu-id" class="uk-offcanvas reader-offcanvas">
<div class="uk-offcanvas-bar">
<ul class="book-menu-bar uk-nav uk-nav-offcanvas" data-uk-nav>
<li>
<a href="../../../book/114/index.html" data-book-page-rel-url="index.html" data-book-page-id="0" title="封面">封面</a>
</li>
<li>
<a class="pjax" href="../../../book/114/readme.html" data-book-page-rel-url="readme.html" data-book-page-id="0" title="简介">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/114/README.html" title="简介" data-book-page-rel-url="README.html" data-book-page-id="8065">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Booting/README.html" title="引导" data-book-page-rel-url="Booting/README.html" data-book-page-id="8066">引导</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/Booting/linux-bootstrap-1.html" title="从引导加载程序内核" data-book-page-rel-url="Booting/linux-bootstrap-1.html" data-book-page-id="8067">从引导加载程序内核</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Booting/linux-bootstrap-2.html" title="在内核安装代码的第一步" data-book-page-rel-url="Booting/linux-bootstrap-2.html" data-book-page-id="8068">在内核安装代码的第一步</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Booting/linux-bootstrap-3.html" title="视频模式初始化和转换到保护模式" data-book-page-rel-url="Booting/linux-bootstrap-3.html" data-book-page-id="8069">视频模式初始化和转换到保护模式</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Booting/linux-bootstrap-4.html" title="过渡到 64 位模式" data-book-page-rel-url="Booting/linux-bootstrap-4.html" data-book-page-id="8070">过渡到 64 位模式</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Booting/linux-bootstrap-5.html" title="内核解压缩" data-book-page-rel-url="Booting/linux-bootstrap-5.html" data-book-page-id="8071">内核解压缩</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/Initialization/README.html" title="初始化" data-book-page-rel-url="Initialization/README.html" data-book-page-id="8072">初始化</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/Initialization/linux-initialization-1.html" title="内核解压之后的首要步骤" data-book-page-rel-url="Initialization/linux-initialization-1.html" data-book-page-id="8073">内核解压之后的首要步骤</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Initialization/linux-initialization-2.html" title="早期的中断和异常控制" data-book-page-rel-url="Initialization/linux-initialization-2.html" data-book-page-id="8074">早期的中断和异常控制</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Initialization/linux-initialization-3.html" title="在到达内核入口之前最后的准备" data-book-page-rel-url="Initialization/linux-initialization-3.html" data-book-page-id="8075">在到达内核入口之前最后的准备</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Initialization/linux-initialization-4.html" title="内核入口 - start_kernel" data-book-page-rel-url="Initialization/linux-initialization-4.html" data-book-page-id="8076">内核入口 - start_kernel</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Initialization/linux-initialization-5.html" title="体系架构初始化" data-book-page-rel-url="Initialization/linux-initialization-5.html" data-book-page-id="8077">体系架构初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Initialization/linux-initialization-6.html" title="进一步初始化指定体系架构" data-book-page-rel-url="Initialization/linux-initialization-6.html" data-book-page-id="8078">进一步初始化指定体系架构</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Initialization/linux-initialization-7.html" title="最后对指定体系架构初始化" data-book-page-rel-url="Initialization/linux-initialization-7.html" data-book-page-id="8079">最后对指定体系架构初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Initialization/linux-initialization-8.html" title="调度器初始化" data-book-page-rel-url="Initialization/linux-initialization-8.html" data-book-page-id="8080">调度器初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Initialization/linux-initialization-9.html" title="RCU 初始化" data-book-page-rel-url="Initialization/linux-initialization-9.html" data-book-page-id="8081">RCU 初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Initialization/linux-initialization-10.html" title="初始化结束" data-book-page-rel-url="Initialization/linux-initialization-10.html" data-book-page-id="8082">初始化结束</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/Interrupts/README.html" title="中断" data-book-page-rel-url="Interrupts/README.html" data-book-page-id="8083">中断</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/Interrupts/interrupts-1.html" title="中断和中断处理 Part 1." data-book-page-rel-url="Interrupts/interrupts-1.html" data-book-page-id="8084">中断和中断处理 Part 1.</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Interrupts/interrupts-2.html" title="深入 Linux 内核中的中断" data-book-page-rel-url="Interrupts/interrupts-2.html" data-book-page-id="8085">深入 Linux 内核中的中断</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Interrupts/interrupts-3.html" title="初步中断处理" data-book-page-rel-url="Interrupts/interrupts-3.html" data-book-page-id="8086">初步中断处理</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Interrupts/interrupts-4.html" title="中断处理" data-book-page-rel-url="Interrupts/interrupts-4.html" data-book-page-id="8087">中断处理</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Interrupts/interrupts-5.html" title="异常处理的实现" data-book-page-rel-url="Interrupts/interrupts-5.html" data-book-page-id="8088">异常处理的实现</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Interrupts/interrupts-6.html" title="处理不可屏蔽中断" data-book-page-rel-url="Interrupts/interrupts-6.html" data-book-page-id="8089">处理不可屏蔽中断</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Interrupts/interrupts-7.html" title="深入外部硬件中断" data-book-page-rel-url="Interrupts/interrupts-7.html" data-book-page-id="8090">深入外部硬件中断</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Interrupts/interrupts-8.html" title="IRQs的非早期初始化" data-book-page-rel-url="Interrupts/interrupts-8.html" data-book-page-id="8091">IRQs的非早期初始化</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Interrupts/interrupts-9.html" title="Softirq, Tasklets and Workqueues" data-book-page-rel-url="Interrupts/interrupts-9.html" data-book-page-id="8092">Softirq, Tasklets and Workqueues</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Interrupts/interrupts-10.html" title="最后一部分" data-book-page-rel-url="Interrupts/interrupts-10.html" data-book-page-id="8093">最后一部分</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/SysCall/README.html" title="系统调用" data-book-page-rel-url="SysCall/README.html" data-book-page-id="8094">系统调用</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/SysCall/syscall-1.html" title="系统调用概念简介" data-book-page-rel-url="SysCall/syscall-1.html" data-book-page-id="8095">系统调用概念简介</a>
</li>
<li>
<a class="pjax" href="../../../book/114/SysCall/syscall-2.html" title="Linux 内核如何处理系统调用" data-book-page-rel-url="SysCall/syscall-2.html" data-book-page-id="8096">Linux 内核如何处理系统调用</a>
</li>
<li>
<a class="pjax" href="../../../book/114/SysCall/syscall-3.html" title="vsyscall and vDSO" data-book-page-rel-url="SysCall/syscall-3.html" data-book-page-id="8097">vsyscall and vDSO</a>
</li>
<li>
<a class="pjax" href="../../../book/114/SysCall/syscall-4.html" title="Linux 内核如何运行程序" data-book-page-rel-url="SysCall/syscall-4.html" data-book-page-id="8098">Linux 内核如何运行程序</a>
</li>
<li>
<a class="pjax" href="../../../book/114/SysCall/syscall-5.html" title="open 系统调用的实现" data-book-page-rel-url="SysCall/syscall-5.html" data-book-page-id="8099">open 系统调用的实现</a>
</li>
<li>
<a class="pjax" href="javascript:;" class="uk-link-muted uk-text-muted" title="Linux 资源限制" disabled data-book-page-rel-url="SysCall/syscall-6.html" data-book-page-id="8100">Linux 资源限制</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/Timers/README.html" title="定时器和时钟管理" data-book-page-rel-url="Timers/README.html" data-book-page-id="8101">定时器和时钟管理</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/Timers/timers-1.html" title="简介" data-book-page-rel-url="Timers/timers-1.html" data-book-page-id="8102">简介</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Timers/timers-2.html" title="时钟源框架简介" data-book-page-rel-url="Timers/timers-2.html" data-book-page-id="8103">时钟源框架简介</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Timers/timers-3.html" title="The tick broadcast framework and dyntick" data-book-page-rel-url="Timers/timers-3.html" data-book-page-id="8104">The tick broadcast framework and dyntick</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Timers/timers-4.html" title="定时器介绍" data-book-page-rel-url="Timers/timers-4.html" data-book-page-id="8105">定时器介绍</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Timers/timers-5.html" title="Clockevents 框架简介" data-book-page-rel-url="Timers/timers-5.html" data-book-page-id="8106">Clockevents 框架简介</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Timers/timers-6.html" title="x86 相关的时钟源" data-book-page-rel-url="Timers/timers-6.html" data-book-page-id="8107">x86 相关的时钟源</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Timers/timers-7.html" title="Linux 内核中与时钟相关的系统调用" data-book-page-rel-url="Timers/timers-7.html" data-book-page-id="8108">Linux 内核中与时钟相关的系统调用</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/SyncPrim/README.html" title="同步原语" data-book-page-rel-url="SyncPrim/README.html" data-book-page-id="8109">同步原语</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/SyncPrim/sync-1.html" title="自旋锁简介" data-book-page-rel-url="SyncPrim/sync-1.html" data-book-page-id="8110">自旋锁简介</a>
</li>
<li>
<a class="pjax" href="../../../book/114/SyncPrim/sync-2.html" title="队列自旋锁" data-book-page-rel-url="SyncPrim/sync-2.html" data-book-page-id="8111">队列自旋锁</a>
</li>
<li>
<a class="pjax" href="../../../book/114/SyncPrim/sync-3.html" title="信号量" data-book-page-rel-url="SyncPrim/sync-3.html" data-book-page-id="8112">信号量</a>
</li>
<li>
<a class="pjax" href="../../../book/114/SyncPrim/sync-4.html" title="互斥锁" data-book-page-rel-url="SyncPrim/sync-4.html" data-book-page-id="8113">互斥锁</a>
</li>
<li>
<a class="pjax" href="../../../book/114/SyncPrim/sync-5.html" title="读者/写者信号量" data-book-page-rel-url="SyncPrim/sync-5.html" data-book-page-id="8114">读者/写者信号量</a>
</li>
<li>
<a class="pjax" href="../../../book/114/SyncPrim/sync-6.html" title="顺序锁" data-book-page-rel-url="SyncPrim/sync-6.html" data-book-page-id="8115">顺序锁</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/MM/README.html" title="内存管理" data-book-page-rel-url="MM/README.html" data-book-page-id="8117">内存管理</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/MM/linux-mm-1.html" title="内存块" data-book-page-rel-url="MM/linux-mm-1.html" data-book-page-id="8118">内存块</a>
</li>
<li>
<a class="pjax" href="../../../book/114/MM/linux-mm-2.html" title="固定映射地址和 ioremap" data-book-page-rel-url="MM/linux-mm-2.html" data-book-page-id="8119">固定映射地址和 ioremap</a>
</li>
<li>
<a class="pjax" href="../../../book/114/MM/linux-mm-3.html" title="kmemcheck" data-book-page-rel-url="MM/linux-mm-3.html" data-book-page-id="8120">kmemcheck</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/Cgroups/README.html" title="Cgroups" data-book-page-rel-url="Cgroups/README.html" data-book-page-id="8121">Cgroups</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/Cgroups/cgroups1.html" title="控制组简介" data-book-page-rel-url="Cgroups/cgroups1.html" data-book-page-id="8122">控制组简介</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/Concepts/README.html" title="概念" data-book-page-rel-url="Concepts/README.html" data-book-page-id="8123">概念</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/Concepts/per-cpu.html" title="每个 CPU 的变量" data-book-page-rel-url="Concepts/per-cpu.html" data-book-page-id="8124">每个 CPU 的变量</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Concepts/cpumask.html" title="CPU 掩码" data-book-page-rel-url="Concepts/cpumask.html" data-book-page-id="8125">CPU 掩码</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Concepts/initcall.html" title="initcall 机制" data-book-page-rel-url="Concepts/initcall.html" data-book-page-id="8126">initcall 机制</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Concepts/notification_chains.html" title="Linux 内核的通知链" data-book-page-rel-url="Concepts/notification_chains.html" data-book-page-id="8127">Linux 内核的通知链</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/DataStructures/README.html" title="Linux 内核中的数据结构" data-book-page-rel-url="DataStructures/README.html" data-book-page-id="8128">Linux 内核中的数据结构</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/DataStructures/dlist.html" title="双向链表" data-book-page-rel-url="DataStructures/dlist.html" data-book-page-id="8129">双向链表</a>
</li>
<li>
<a class="pjax" href="../../../book/114/DataStructures/radix-tree.html" title="基数树" data-book-page-rel-url="DataStructures/radix-tree.html" data-book-page-id="8130">基数树</a>
</li>
<li>
<a class="pjax" href="../../../book/114/DataStructures/bitmap.html" title="位数组" data-book-page-rel-url="DataStructures/bitmap.html" data-book-page-id="8131">位数组</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/Theory/README.html" title="理论" data-book-page-rel-url="Theory/README.html" data-book-page-id="8132">理论</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/Theory/Paging.html" title="分页" data-book-page-rel-url="Theory/Paging.html" data-book-page-id="8133">分页</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Theory/ELF.html" title="Elf64 格式" data-book-page-rel-url="Theory/ELF.html" data-book-page-id="8134">Elf64 格式</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/Misc/README.html" title="杂项" data-book-page-rel-url="Misc/README.html" data-book-page-id="8135">杂项</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/Misc/how_kernel_compiled.html" title="内核编译方法" data-book-page-rel-url="Misc/how_kernel_compiled.html" data-book-page-id="8136">内核编译方法</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Misc/linkers.html" title="链接器" data-book-page-rel-url="Misc/linkers.html" data-book-page-id="8137">链接器</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Misc/contribute.html" title="Linux 内核开发" data-book-page-rel-url="Misc/contribute.html" data-book-page-id="8138">Linux 内核开发</a>
</li>
<li>
<a class="pjax" href="../../../book/114/Misc/program_startup.html" title="用户空间的程序启动过程" data-book-page-rel-url="Misc/program_startup.html" data-book-page-id="8139">用户空间的程序启动过程</a>
</li>
<li>
<a class="pjax" href="../../../book/114/" title="书写并提交你第一个内核补丁" data-book-page-rel-url="" data-book-page-id="8116">书写并提交你第一个内核补丁</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/KernelStructures/README.html" title="内核数据结构" data-book-page-rel-url="KernelStructures/README.html" data-book-page-id="8140">内核数据结构</a>
<ul>
<li>
<a class="pjax" href="../../../book/114/KernelStructures/idt.html" title="中断描述符表" data-book-page-rel-url="KernelStructures/idt.html" data-book-page-id="8141">中断描述符表</a>
</li>
</ul>
</li>
<li>
<a class="pjax" href="../../../book/114/LINKS.html" title="有帮助的链接" data-book-page-rel-url="LINKS.html" data-book-page-id="8142">有帮助的链接</a>
</li>
<li>
<a class="pjax" href="../../../book/114/contributors.html" title="贡献者" data-book-page-rel-url="contributors.html" data-book-page-id="8143">贡献者</a>
</li>
</ul>
</div>
</div>
<script src="https://cdn.staticfile.net/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript" src="../../../static/components/uikit-2.27.5/js/uikit.reader.js"></script>
<script type="text/javascript" src="../../../static/components/social-share/social-share.min.js"></script>
<script>(function(){var bp =document.createElement('script');var curProtocol =window.location.protocol.split(':')[0];if (curProtocol ==='https') {bp.src ='https://zz.bdstatic.com/linksubmit/push.js';}
else {bp.src ='http://push.zhanzhang.baidu.com/push.js';}
var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
<script src="https://cdn.staticfile.net/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.staticfile.net/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>
<script src="https://cdn.staticfile.net/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://cdn.staticfile.net/uikit/2.27.5/js/components/lightbox.min.js"></script>
<link rel="dns-prefetch" href="../../..//cdn.mathjax.org" />
<script type="text/x-mathjax-config">
 function initMathJax() {
    var mathId = $("book-content-section")[0];
    MathJax.Hub.Config({
        tex2jax: {skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code','a']},
        showProcessingMessages: false,
        messageStyle: "none"
    });
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,mathId]);
 };
initMathJax();
</script>
<script src='https://cdn.staticfile.net/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
<style>
	.MathJax_Display{display:inline!important;}
</style>
<script type="text/javascript" src="../../../static/components/js/reader.js"></script>
<script type="text/javascript">var bookId =114;var bookPageId =8088;var bookPageRelUrl ='Interrupts/interrupts-5.html';</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-38429407-1"></script>
<script>window.dataLayer =window.dataLayer ||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-38429407-1');</script>
<script>var _hmt =_hmt ||[];(function() {var hm =document.createElement("script");hm.src ="https://hm.baidu.com/hm.js?f28e71bd2b5dee3439448dca9f534107";var s =document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script>
</body>
</html>